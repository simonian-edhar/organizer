{"version":3,"sources":["../../../src/pricelists/services/pricelist.service.ts"],"sourcesContent":["import { Injectable, NotFoundException } from '@nestjs/common';\nimport { InjectRepository } from '@nestjs/typeorm';\nimport { Repository, In } from 'typeorm';\nimport { Pricelist } from '../../database/entities/Pricelist.entity';\nimport { PricelistItem } from '../../database/entities/PricelistItem.entity';\nimport {\n    CreatePricelistDto,\n    UpdatePricelistDto,\n    CreatePricelistItemDto,\n    UpdatePricelistItemDto,\n    PricelistFiltersDto,\n} from '../dto/pricelist.dto';\n\n/**\n * Pricelist Service\n */\n@Injectable()\nexport class PricelistService {\n    constructor(\n        @InjectRepository(Pricelist)\n        private readonly pricelistRepository: Repository<Pricelist>,\n        @InjectRepository(PricelistItem)\n        private readonly pricelistItemRepository: Repository<PricelistItem>,\n    ) {}\n\n    /**\n     * Get all pricelists\n     */\n    async findAll(\n        tenantId: string,\n        filters: PricelistFiltersDto = {}\n    ): Promise<{ data: Pricelist[]; total: number; page: number; limit: number }> {\n        const query = this.pricelistRepository\n            .createQueryBuilder('pricelist')\n            .where('pricelist.tenantId = :tenantId AND pricelist.deletedAt IS NULL', { tenantId });\n\n        // Filter by type\n        if (filters.type) {\n            query.andWhere('pricelist.type = :type', { type: filters.type });\n        }\n\n        // Filter by status\n        if (filters.status) {\n            query.andWhere('pricelist.status = :status', { status: filters.status });\n        }\n\n        // Filter by default\n        if (filters.isDefault !== undefined) {\n            query.andWhere('pricelist.isDefault = :isDefault', { isDefault: filters.isDefault });\n        }\n\n        // Search\n        if (filters.search) {\n            query.andWhere('pricelist.name ILIKE :search', { search: `%${filters.search}%` });\n        }\n\n        // Sorting\n        query.orderBy('pricelist.createdAt', 'DESC');\n\n        // Pagination\n        const page = filters.page || 1;\n        const limit = filters.limit || 20;\n        const skip = (page - 1) * limit;\n\n        query.skip(skip).take(limit);\n\n        // Include items\n        query.leftJoinAndSelect('pricelist.items', 'items');\n\n        const [data, total] = await query.getManyAndCount();\n\n        return {\n            data,\n            total,\n            page,\n            limit,\n        };\n    }\n\n    /**\n     * Get pricelist by ID with items\n     */\n    async findById(tenantId: string, id: string): Promise<Pricelist> {\n        const pricelist = await this.pricelistRepository.findOne({\n            where: {\n                id,\n                tenantId,\n                deletedAt: null,\n            },\n            relations: ['items'],\n            order: {\n                items: {\n                    displayOrder: 'ASC',\n                },\n            },\n        });\n\n        if (!pricelist) {\n            throw new NotFoundException('Прайс-лист не знайдено');\n        }\n\n        return pricelist;\n    }\n\n    /**\n     * Create new pricelist\n     */\n    async create(\n        tenantId: string,\n        userId: string,\n        dto: CreatePricelistDto\n    ): Promise<Pricelist> {\n        const pricelist = this.pricelistRepository.create({\n            tenantId,\n            ...dto,\n            createdBy: userId,\n            updatedBy: userId,\n        });\n\n        return this.pricelistRepository.save(pricelist);\n    }\n\n    /**\n     * Update pricelist\n     */\n    async update(\n        tenantId: string,\n        id: string,\n        userId: string,\n        dto: UpdatePricelistDto\n    ): Promise<Pricelist> {\n        const pricelist = await this.findById(tenantId, id);\n\n        Object.assign(pricelist, dto, {\n            updatedBy: userId,\n        });\n\n        return this.pricelistRepository.save(pricelist);\n    }\n\n    /**\n     * Delete pricelist (soft delete)\n     */\n    async delete(tenantId: string, id: string, userId: string): Promise<void> {\n        const pricelist = await this.findById(tenantId, id);\n\n        await this.pricelistRepository.update(\n            { id, tenantId },\n            {\n                deletedAt: new Date(),\n                updatedBy: userId,\n                status: 'archived',\n            }\n        );\n    }\n\n    /**\n     * Add item to pricelist\n     */\n    async addItem(\n        tenantId: string,\n        userId: string,\n        pricelistId: string,\n        dto: CreatePricelistItemDto\n    ): Promise<PricelistItem> {\n        const item = this.pricelistItemRepository.create({\n            tenantId,\n            pricelistId,\n            ...dto,\n            createdBy: userId,\n            updatedBy: userId,\n        });\n\n        return this.pricelistItemRepository.save(item);\n    }\n\n    /**\n     * Update item in pricelist\n     */\n    async updateItem(\n        tenantId: string,\n        id: string,\n        userId: string,\n        dto: UpdatePricelistItemDto\n    ): Promise<PricelistItem> {\n        const item = await this.pricelistItemRepository.findOne({\n            where: {\n                id,\n                tenantId,\n                deletedAt: null,\n            },\n        });\n\n        if (!item) {\n            throw new NotFoundException('Позицію прайс-листа не знайдено');\n        }\n\n        Object.assign(item, dto, {\n            updatedBy: userId,\n        });\n\n        return this.pricelistItemRepository.save(item);\n    }\n\n    /**\n     * Delete item from pricelist\n     */\n    async deleteItem(tenantId: string, id: string, userId: string): Promise<void> {\n        await this.pricelistItemRepository.delete({\n            id,\n            tenantId,\n        });\n    }\n\n    /**\n     * Get available items by category\n     */\n    async getItemsByCategory(\n        tenantId: string,\n        category: string\n    ): Promise<PricelistItem[]> {\n        return this.pricelistItemRepository\n            .createQueryBuilder('item')\n            .innerJoin('item.pricelist', 'pricelist')\n            .where(\n                'pricelist.tenantId = :tenantId AND ' +\n                'item.category = :category AND ' +\n                'item.isActive = :isActive AND ' +\n                'pricelist.status = :status AND ' +\n                'pricelist.deletedAt IS NULL AND ' +\n                'item.deletedAt IS NULL',\n                { tenantId, category, isActive: true, status: 'active' }\n            )\n            .orderBy('item.displayOrder', 'ASC')\n            .getMany();\n    }\n\n    /**\n     * Get default pricelist\n     */\n    async getDefaultPricelist(tenantId: string): Promise<Pricelist | null> {\n        return this.pricelistRepository.findOne({\n            where: {\n                tenantId,\n                isDefault: true,\n                status: 'active',\n                deletedAt: null,\n            },\n            relations: ['items'],\n        });\n    }\n}\n"],"names":["PricelistService","findAll","tenantId","filters","query","pricelistRepository","createQueryBuilder","where","type","andWhere","status","isDefault","undefined","search","orderBy","page","limit","skip","take","leftJoinAndSelect","data","total","getManyAndCount","findById","id","pricelist","findOne","deletedAt","relations","order","items","displayOrder","NotFoundException","create","userId","dto","createdBy","updatedBy","save","update","Object","assign","delete","Date","addItem","pricelistId","item","pricelistItemRepository","updateItem","deleteItem","getItemsByCategory","category","innerJoin","isActive","getMany","getDefaultPricelist"],"mappings":"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"}
{"version":3,"sources":["../../src/logs/logs.controller.ts"],"sourcesContent":["import { Controller, Post, Body, UseGuards, HttpCode, HttpStatus } from '@nestjs/common';\nimport { ApiTags, ApiOperation, ApiResponse, ApiBearerAuth } from '@nestjs/common';\nimport { Throttle } from '@nestjs/throttler';\nimport { JwtAuthGuard } from '../auth/guards';\nimport { IsArray, IsObject, IsString, IsOptional, ValidateNested, IsEnum, IsNumber } from 'class-validator';\nimport { Type } from 'class-transformer';\nimport { LoggingService } from '../common/logging';\n\nexport type LogLevel = 'debug' | 'info' | 'warn' | 'error' | 'fatal';\n\nexport class LogEntryDto {\n    @IsString()\n    timestamp: string;\n\n    @IsEnum(['debug', 'info', 'warn', 'error', 'fatal'])\n    level: LogLevel;\n\n    @IsString()\n    message: string;\n\n    @IsString()\n    @IsOptional()\n    context?: string;\n\n    @IsString()\n    @IsOptional()\n    userId?: string;\n\n    @IsString()\n    @IsOptional()\n    tenantId?: string;\n\n    @IsString()\n    @IsOptional()\n    url?: string;\n\n    @IsString()\n    @IsOptional()\n    userAgent?: string;\n\n    @IsObject()\n    @IsOptional()\n    metadata?: Record<string, any>;\n\n    @IsObject()\n    @IsOptional()\n    error?: {\n        name: string;\n        message: string;\n        stack?: string;\n    };\n}\n\nexport class LogBatchDto {\n    @IsArray()\n    @ValidateNested({ each: true })\n    @Type(() => LogEntryDto)\n    logs: LogEntryDto[];\n}\n\n/**\n * Logs Controller\n * Receives and stores frontend logs\n */\n@ApiTags('Logs')\n@Controller('logs')\nexport class LogsController {\n    constructor(private readonly loggingService: LoggingService) {}\n\n    @Post()\n    @UseGuards(JwtAuthGuard)\n    @ApiBearerAuth()\n    @HttpCode(HttpStatus.NO_CONTENT)\n    @Throttle({ default: { limit: 30, ttl: 60000 } }) // 30 requests per minute\n    @ApiOperation({ summary: 'Submit frontend logs' })\n    @ApiResponse({ status: 204, description: 'Logs received' })\n    @ApiResponse({ status: 400, description: 'Invalid log data' })\n    @ApiResponse({ status: 401, description: 'Unauthorized' })\n    async receiveLogs(@Body() dto: LogBatchDto): Promise<void> {\n        for (const log of dto.logs) {\n            this.processLogEntry(log);\n        }\n    }\n\n    /**\n     * Process a single log entry\n     */\n    private processLogEntry(log: LogEntryDto): void {\n        const context = log.context ? `[Frontend:${log.context}]` : '[Frontend]';\n        const metadata = {\n            ...log.metadata,\n            userId: log.userId,\n            tenantId: log.tenantId,\n            url: log.url,\n            userAgent: log.userAgent,\n        };\n\n        switch (log.level) {\n            case 'debug':\n                this.loggingService.debug(`${context} ${log.message}`, metadata);\n                break;\n            case 'info':\n                this.loggingService.info(`${context} ${log.message}`, metadata);\n                break;\n            case 'warn':\n                this.loggingService.warn(`${context} ${log.message}`, metadata);\n                break;\n            case 'error':\n            case 'fatal':\n                const error = log.error\n                    ? new Error(`${log.error.name}: ${log.error.message}`)\n                    : new Error(log.message);\n                if (log.error?.stack) {\n                    error.stack = log.error.stack;\n                }\n                this.loggingService.error(`${context} ${log.message}`, error.stack, metadata);\n                break;\n        }\n    }\n}\n"],"names":["LogBatchDto","LogEntryDto","LogsController","each","receiveLogs","dto","log","logs","processLogEntry","context","metadata","userId","tenantId","url","userAgent","level","loggingService","debug","message","info","warn","error","Error","name","stack","NO_CONTENT","default","limit","ttl","summary","status","description"],"mappings":";;;;;;;;;;;QAqDaA;eAAAA;;QA3CAC;eAAAA;;QAwDAC;eAAAA;;;wBAlE2D;2BAE/C;wBACI;gCAC6D;kCACrE;yBACU;;;;;;;;;;;;;;;AAIxB,IAAA,AAAMD,cAAN,MAAMA;AAyCb;;;;;;;QArCa;QAAS;QAAQ;QAAQ;QAAS;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAuCxC,IAAA,AAAMD,cAAN,MAAMA;AAKb;;;;QAHsBG,MAAM;;oCACZF;;;AAUT,IAAA,AAAMC,iBAAN,MAAMA;IAGT,MASME,YAAY,AAAQC,GAAgB,EAAiB;QACvD,KAAK,MAAMC,OAAOD,IAAIE,IAAI,CAAE;YACxB,IAAI,CAACC,eAAe,CAACF;QACzB;IACJ;IAEA;;KAEC,GACD,AAAQE,gBAAgBF,GAAgB,EAAQ;QAC5C,MAAMG,UAAUH,IAAIG,OAAO,GAAG,CAAC,UAAU,EAAEH,IAAIG,OAAO,CAAC,CAAC,CAAC,GAAG;QAC5D,MAAMC,WAAW;YACb,GAAGJ,IAAII,QAAQ;YACfC,QAAQL,IAAIK,MAAM;YAClBC,UAAUN,IAAIM,QAAQ;YACtBC,KAAKP,IAAIO,GAAG;YACZC,WAAWR,IAAIQ,SAAS;QAC5B;QAEA,OAAQR,IAAIS,KAAK;YACb,KAAK;gBACD,IAAI,CAACC,cAAc,CAACC,KAAK,CAAC,GAAGR,QAAQ,CAAC,EAAEH,IAAIY,OAAO,EAAE,EAAER;gBACvD;YACJ,KAAK;gBACD,IAAI,CAACM,cAAc,CAACG,IAAI,CAAC,GAAGV,QAAQ,CAAC,EAAEH,IAAIY,OAAO,EAAE,EAAER;gBACtD;YACJ,KAAK;gBACD,IAAI,CAACM,cAAc,CAACI,IAAI,CAAC,GAAGX,QAAQ,CAAC,EAAEH,IAAIY,OAAO,EAAE,EAAER;gBACtD;YACJ,KAAK;YACL,KAAK;gBACD,MAAMW,QAAQf,IAAIe,KAAK,GACjB,IAAIC,MAAM,GAAGhB,IAAIe,KAAK,CAACE,IAAI,CAAC,EAAE,EAAEjB,IAAIe,KAAK,CAACH,OAAO,EAAE,IACnD,IAAII,MAAMhB,IAAIY,OAAO;gBAC3B,IAAIZ,IAAIe,KAAK,EAAEG,OAAO;oBAClBH,MAAMG,KAAK,GAAGlB,IAAIe,KAAK,CAACG,KAAK;gBACjC;gBACA,IAAI,CAACR,cAAc,CAACK,KAAK,CAAC,GAAGZ,QAAQ,CAAC,EAAEH,IAAIY,OAAO,EAAE,EAAEG,MAAMG,KAAK,EAAEd;gBACpE;QACR;IACJ;IAnDA,YAAY,AAAiBM,cAA8B,CAAE;aAAhCA,iBAAAA;IAAiC;AAoDlE;;;;;6CA/CyBS;;QACTC,SAAS;YAAEC,OAAO;YAAIC,KAAK;QAAM;;;QAC7BC,SAAS;;;QACVC,QAAQ;QAAKC,aAAa;;;QAC1BD,QAAQ;QAAKC,aAAa;;;QAC1BD,QAAQ;QAAKC,aAAa"}
{"version":3,"sources":["../../../src/auth/services/jwt.service.ts"],"sourcesContent":["import { Injectable, UnauthorizedException, ConflictException } from '@nestjs/common';\nimport { JwtService as NestJwtService } from '@nestjs/jwt';\nimport { ConfigService } from '@nestjs/config';\nimport { JwtPayload, RefreshTokenPayload } from '../interfaces/jwt.interface';\nimport { SecurityConfig } from '../interfaces/jwt.interface';\nimport { generateUuid } from '../../common/utils/crypto.util';\n\n/**\n * JWT Service\n */\n@Injectable()\nexport class JwtService {\n    constructor(\n        private readonly jwtService: NestJwtService,\n        private readonly configService: ConfigService,\n    ) {}\n\n    /**\n     * Generate access token\n     */\n    async generateAccessToken(payload: Omit<JwtPayload, 'jti' | 'iat' | 'exp'>): Promise<string> {\n        const jwtPayload: JwtPayload = {\n            ...payload,\n            jti: generateUuid(),\n        };\n\n        return this.jwtService.sign(jwtPayload, {\n            expiresIn: this.configService.get<string>('JWT_ACCESS_TOKEN_EXPIRY', SecurityConfig.JWT_ACCESS_TOKEN_EXPIRY),\n        });\n    }\n\n    /**\n     * Generate refresh token\n     */\n    async generateRefreshToken(payload: Omit<RefreshTokenPayload, 'iat' | 'exp'>): Promise<string> {\n        return this.jwtService.sign(payload, {\n            expiresIn: this.configService.get<string>('JWT_REFRESH_TOKEN_EXPIRY', SecurityConfig.JWT_REFRESH_TOKEN_EXPIRY),\n        });\n    }\n\n    /**\n     * Verify access token\n     */\n    async verifyAccessToken(token: string): Promise<JwtPayload> {\n        try {\n            return this.jwtService.verify<JwtPayload>(token);\n        } catch (error) {\n            throw new UnauthorizedException('Invalid or expired token');\n        }\n    }\n\n    /**\n     * Verify refresh token\n     */\n    async verifyRefreshToken(token: string): Promise<RefreshTokenPayload> {\n        try {\n            return this.jwtService.verify<RefreshTokenPayload>(token);\n        } catch (error) {\n            throw new UnauthorizedException('Invalid or expired refresh token');\n        }\n    }\n\n    /**\n     * Decode token without verification (for JTI extraction)\n     */\n    decodeToken(token: string): JwtPayload | RefreshTokenPayload | null {\n        try {\n            return this.jwtService.decode(token) as JwtPayload | RefreshTokenPayload | null;\n        } catch (error) {\n            return null;\n        }\n    }\n\n    /**\n     * Get token expiration time\n     */\n    getTokenExpiry(token: string): number | null {\n        const decoded = this.decodeToken(token);\n        return decoded?.exp || null;\n    }\n\n    /**\n     * Check if token is expired\n     */\n    isTokenExpired(token: string): boolean {\n        const decoded = this.decodeToken(token);\n        if (!decoded || !decoded.exp) {\n            return true;\n        }\n\n        return Date.now() >= decoded.exp * 1000;\n    }\n\n    /**\n     * Get time until token expiration (in seconds)\n     */\n    getTimeUntilExpiration(token: string): number | null {\n        const decoded = this.decodeToken(token);\n        if (!decoded || !decoded.exp) {\n            return null;\n        }\n\n        const expirationTime = decoded.exp * 1000;\n        const remainingTime = Math.max(0, expirationTime - Date.now());\n\n        return Math.floor(remainingTime / 1000);\n    }\n}\n"],"names":["JwtService","generateAccessToken","payload","jwtPayload","jti","generateUuid","jwtService","sign","expiresIn","configService","get","SecurityConfig","JWT_ACCESS_TOKEN_EXPIRY","generateRefreshToken","JWT_REFRESH_TOKEN_EXPIRY","verifyAccessToken","token","verify","error","UnauthorizedException","verifyRefreshToken","decodeToken","decode","getTokenExpiry","decoded","exp","isTokenExpired","Date","now","getTimeUntilExpiration","expirationTime","remainingTime","Math","max","floor"],"mappings":";;;;+BAWaA;;;eAAAA;;;wBAXwD;qBACxB;wBACf;8BAEC;4BACF;;;;;;;;;;AAMtB,IAAA,AAAMA,aAAN,MAAMA;IAMT;;KAEC,GACD,MAAMC,oBAAoBC,OAAgD,EAAmB;QACzF,MAAMC,aAAyB;YAC3B,GAAGD,OAAO;YACVE,KAAKC,IAAAA,wBAAY;QACrB;QAEA,OAAO,IAAI,CAACC,UAAU,CAACC,IAAI,CAACJ,YAAY;YACpCK,WAAW,IAAI,CAACC,aAAa,CAACC,GAAG,CAAS,2BAA2BC,4BAAc,CAACC,uBAAuB;QAC/G;IACJ;IAEA;;KAEC,GACD,MAAMC,qBAAqBX,OAAiD,EAAmB;QAC3F,OAAO,IAAI,CAACI,UAAU,CAACC,IAAI,CAACL,SAAS;YACjCM,WAAW,IAAI,CAACC,aAAa,CAACC,GAAG,CAAS,4BAA4BC,4BAAc,CAACG,wBAAwB;QACjH;IACJ;IAEA;;KAEC,GACD,MAAMC,kBAAkBC,KAAa,EAAuB;QACxD,IAAI;YACA,OAAO,IAAI,CAACV,UAAU,CAACW,MAAM,CAAaD;QAC9C,EAAE,OAAOE,OAAO;YACZ,MAAM,IAAIC,6BAAqB,CAAC;QACpC;IACJ;IAEA;;KAEC,GACD,MAAMC,mBAAmBJ,KAAa,EAAgC;QAClE,IAAI;YACA,OAAO,IAAI,CAACV,UAAU,CAACW,MAAM,CAAsBD;QACvD,EAAE,OAAOE,OAAO;YACZ,MAAM,IAAIC,6BAAqB,CAAC;QACpC;IACJ;IAEA;;KAEC,GACDE,YAAYL,KAAa,EAA2C;QAChE,IAAI;YACA,OAAO,IAAI,CAACV,UAAU,CAACgB,MAAM,CAACN;QAClC,EAAE,OAAOE,OAAO;YACZ,OAAO;QACX;IACJ;IAEA;;KAEC,GACDK,eAAeP,KAAa,EAAiB;QACzC,MAAMQ,UAAU,IAAI,CAACH,WAAW,CAACL;QACjC,OAAOQ,SAASC,OAAO;IAC3B;IAEA;;KAEC,GACDC,eAAeV,KAAa,EAAW;QACnC,MAAMQ,UAAU,IAAI,CAACH,WAAW,CAACL;QACjC,IAAI,CAACQ,WAAW,CAACA,QAAQC,GAAG,EAAE;YAC1B,OAAO;QACX;QAEA,OAAOE,KAAKC,GAAG,MAAMJ,QAAQC,GAAG,GAAG;IACvC;IAEA;;KAEC,GACDI,uBAAuBb,KAAa,EAAiB;QACjD,MAAMQ,UAAU,IAAI,CAACH,WAAW,CAACL;QACjC,IAAI,CAACQ,WAAW,CAACA,QAAQC,GAAG,EAAE;YAC1B,OAAO;QACX;QAEA,MAAMK,iBAAiBN,QAAQC,GAAG,GAAG;QACrC,MAAMM,gBAAgBC,KAAKC,GAAG,CAAC,GAAGH,iBAAiBH,KAAKC,GAAG;QAE3D,OAAOI,KAAKE,KAAK,CAACH,gBAAgB;IACtC;IA9FA,YACI,AAAiBzB,UAA0B,EAC3C,AAAiBG,aAA4B,CAC/C;aAFmBH,aAAAA;aACAG,gBAAAA;IAClB;AA4FP"}
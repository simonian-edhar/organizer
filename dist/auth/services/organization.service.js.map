{"version":3,"sources":["../../../src/auth/services/organization.service.ts"],"sourcesContent":["import { Injectable, NotFoundException } from '@nestjs/common';\nimport { InjectRepository } from '@nestjs/typeorm';\nimport { Repository } from 'typeorm';\nimport { Organization } from '../../database/entities/Organization.entity';\nimport { Subscription } from '../../database/entities/Subscription.entity';\nimport { SubscriptionStatus } from '../../database/entities/enums/subscription.enum';\nimport { SubscriptionPlan } from '../../database/entities/enums/subscription.enum';\nimport { OnboardingProgress } from '../../database/entities/OnboardingProgress.entity';\n\n/**\n * Organization Service\n */\n@Injectable()\nexport class OrganizationService {\n    constructor(\n        @InjectRepository(Organization)\n        private readonly organizationRepository: Repository<Organization>,\n        @InjectRepository(Subscription)\n        private readonly subscriptionRepository: Repository<Subscription>,\n        @InjectRepository(OnboardingProgress)\n        private readonly onboardingProgressRepository: Repository<OnboardingProgress>,\n    ) {}\n\n    /**\n     * Get organization by ID\n     */\n    async getOrganizationById(tenantId: string): Promise<Organization> {\n        const organization = await this.organizationRepository.findOne({\n            where: { id: tenantId, deletedAt: null },\n        });\n\n        if (!organization) {\n            throw new NotFoundException('Організацію не знайдено');\n        }\n\n        return organization;\n    }\n\n    /**\n     * Update organization\n     */\n    async updateOrganization(\n        tenantId: string,\n        data: Partial<Organization>\n    ): Promise<Organization> {\n        await this.organizationRepository.update({ id: tenantId }, data);\n\n        return this.getOrganizationById(tenantId);\n    }\n\n    /**\n     * Delete organization (soft delete)\n     */\n    async deleteOrganization(tenantId: string): Promise<void> {\n        await this.organizationRepository.update(\n            { id: tenantId },\n            { deletedAt: new Date() }\n        );\n    }\n\n    /**\n     * Get onboarding progress\n     */\n    async getOnboardingProgress(tenantId: string, userId: string): Promise<{\n        completed: boolean;\n        percentage: number;\n        steps: any[];\n    }> {\n        const progress = await this.onboardingProgressRepository.find({\n            where: { tenantId, userId },\n            order: { step: 'ASC' },\n        });\n\n        const completedSteps = progress.filter(p => p.completed);\n        const percentage = progress.length > 0\n            ? Math.round((completedSteps.length / progress.length) * 100)\n            : 0;\n\n        return {\n            completed: percentage === 100,\n            percentage,\n            steps: progress.map(p => ({\n                step: p.step,\n                completed: p.completed,\n                completedAt: p.completedAt,\n            })),\n        };\n    }\n\n    /**\n     * Update onboarding step\n     */\n    async updateOnboardingStep(\n        tenantId: string,\n        userId: string,\n        step: string,\n        completed: boolean,\n        data: Record<string, any> = {}\n    ): Promise<void> {\n        const existingProgress = await this.onboardingProgressRepository.findOne({\n            where: { tenantId, userId, step: step as any },\n        });\n\n        if (existingProgress) {\n            await this.onboardingProgressRepository.update(\n                { id: existingProgress.id },\n                {\n                    completed,\n                    completedAt: completed ? new Date() : null,\n                    data: { ...existingProgress.data, ...data },\n                }\n            );\n        } else {\n            await this.onboardingProgressRepository.save({\n                tenantId,\n                userId,\n                step: step as any,\n                completed,\n                completedAt: completed ? new Date() : null,\n                data,\n                percentage: completed ? 100 : 0,\n            });\n        }\n    }\n\n    /**\n     * Get subscription status\n     */\n    async getSubscriptionStatus(tenantId: string): Promise<Subscription> {\n        const subscription = await this.subscriptionRepository.findOne({\n            where: { tenantId },\n        });\n\n        if (!subscription) {\n            throw new NotFoundException('Підписку не знайдено');\n        }\n\n        return subscription;\n    }\n\n    /**\n     * Check subscription status\n     */\n    async isSubscriptionActive(tenantId: string): Promise<boolean> {\n        const organization = await this.organizationRepository.findOne({\n            where: { id: tenantId, deletedAt: null },\n        });\n\n        if (!organization) {\n            return false;\n        }\n\n        // Check if trial is active\n        if (\n            organization.subscriptionStatus === SubscriptionStatus.TRIALING &&\n            organization.trialEndAt &&\n            organization.trialEndAt > new Date()\n        ) {\n            return true;\n        }\n\n        // Check if subscription is active\n        return organization.subscriptionStatus === SubscriptionStatus.ACTIVE;\n    }\n\n    /**\n     * Check if user can access feature based on subscription plan\n     */\n    async canAccessFeature(tenantId: string, requiredPlan: SubscriptionPlan): Promise<boolean> {\n        const organization = await this.organizationRepository.findOne({\n            where: { id: tenantId, deletedAt: null },\n        });\n\n        if (!organization) {\n            return false;\n        }\n\n        const planLevels = {\n            [SubscriptionPlan.BASIC]: 1,\n            [SubscriptionPlan.PROFESSIONAL]: 2,\n            [SubscriptionPlan.ENTERPRISE]: 3,\n        };\n\n        const currentLevel = planLevels[organization.subscriptionPlan];\n        const requiredLevel = planLevels[requiredPlan];\n\n        return currentLevel >= requiredLevel;\n    }\n}\n"],"names":["OrganizationService","getOrganizationById","tenantId","organization","organizationRepository","findOne","where","id","deletedAt","NotFoundException","updateOrganization","data","update","deleteOrganization","Date","getOnboardingProgress","userId","progress","onboardingProgressRepository","find","order","step","completedSteps","filter","p","completed","percentage","length","Math","round","steps","map","completedAt","updateOnboardingStep","existingProgress","save","getSubscriptionStatus","subscription","subscriptionRepository","isSubscriptionActive","subscriptionStatus","SubscriptionStatus","TRIALING","trialEndAt","ACTIVE","canAccessFeature","requiredPlan","planLevels","SubscriptionPlan","BASIC","PROFESSIONAL","ENTERPRISE","currentLevel","subscriptionPlan","requiredLevel"],"mappings":"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"}
{"version":3,"sources":["../../../src/auth/services/auth.service.ts"],"sourcesContent":["import { Injectable, UnauthorizedException, ConflictException, Logger } from '@nestjs/common';\nimport { InjectRepository } from '@nestjs/typeorm';\nimport { Repository, DataSource } from 'typeorm';\nimport * as bcrypt from 'bcrypt';\nimport { User } from '../../database/entities/User.entity';\nimport { Organization } from '../../database/entities/Organization.entity';\nimport { RefreshToken } from '../../database/entities/RefreshToken.entity';\nimport { Subscription } from '../../database/entities/Subscription.entity';\nimport { SubscriptionPlan, SubscriptionStatus, SubscriptionProvider, UserRole, UserStatus } from '../../database/entities/enums/subscription.enum';\nimport { JwtPayload, RefreshTokenPayload } from '../interfaces/jwt.interface';\nimport { LoginDto, LoginResponseDto } from '../dto/login.dto';\nimport { RegisterDto, RegisterOrganizationDto } from '../dto/register.dto';\nimport { RefreshTokenDto, RefreshTokenResponseDto, LogoutDto } from '../dto/refresh-token.dto';\nimport { ForgotPasswordDto, ResetPasswordDto } from '../dto/forgot-password.dto';\nimport { VerifyEmailDto } from '../dto/verify-email.dto';\nimport { JwtService } from './jwt.service';\nimport {\n    generateSalt,\n    hashPassword,\n    verifyPassword,\n    generateToken,\n    generateUuid,\n    generateDeviceFingerprint,\n    generateTotpSecret,\n    generateMfaBackupCodes,\n} from '../../common/utils/crypto.util';\nimport { validatePasswordStrength } from '../../common/utils/validation.util';\nimport { AuditService } from './audit.service';\nimport { LoggingService } from '../../common/logging';\n\n/**\n * Auth Service\n */\n@Injectable()\nexport class AuthService {\n    private readonly logger = new Logger(AuthService.name);\n\n    constructor(\n        @InjectRepository(User)\n        private readonly userRepository: Repository<User>,\n        @InjectRepository(Organization)\n        private readonly organizationRepository: Repository<Organization>,\n        @InjectRepository(RefreshToken)\n        private readonly refreshTokenRepository: Repository<RefreshToken>,\n        @InjectRepository(Subscription)\n        private readonly subscriptionRepository: Repository<Subscription>,\n        private readonly jwtService: JwtService,\n        private readonly auditService: AuditService,\n        private readonly loggingService: LoggingService,\n        private readonly dataSource: DataSource,\n    ) {\n    }\n\n    /**\n     * Register organization with admin user\n     */\n    async registerOrganization(dto: RegisterOrganizationDto): Promise<{ organizationId: string; userId: string }> {\n        // Validate password strength\n        const passwordValidation = validatePasswordStrength(dto.password);\n        if (!passwordValidation.valid) {\n            this.loggingService.logAuthEvent('login_failed', {\n                email: dto.email,\n                reason: 'Password too weak',\n            });\n            throw new ConflictException('Password too weak: ' + passwordValidation.errors.join(', '));\n        }\n\n        this.loggingService.debug('Starting organization registration', { email: dto.email, organizationName: dto.name });\n\n        const queryRunner = this.dataSource.createQueryRunner();\n        await queryRunner.connect();\n        await queryRunner.startTransaction();\n\n        try {\n            // Create organization\n            const organization = queryRunner.manager.create(Organization, {\n                name: dto.name,\n                legalForm: dto.legalForm,\n                edrpou: dto.edrpou,\n                taxNumber: dto.taxNumber,\n                address: dto.address,\n                city: dto.city,\n                region: dto.region,\n                phone: dto.phone,\n                email: dto.email,\n                website: dto.website,\n                subscriptionPlan: dto.subscriptionPlan || SubscriptionPlan.BASIC,\n                subscriptionStatus: SubscriptionStatus.TRIALING,\n                trialEndAt: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000), // 14 days trial\n                maxUsers: dto.subscriptionPlan === SubscriptionPlan.BASIC ? 1 : 5,\n                status: 'active',\n            });\n\n            const savedOrganization = await queryRunner.manager.save(organization);\n\n            // Create subscription record\n            const subscription = queryRunner.manager.create(Subscription, {\n                tenantId: savedOrganization.id,\n                provider: SubscriptionProvider.WAYFORPAY,\n                plan: dto.subscriptionPlan || SubscriptionPlan.BASIC,\n                status: SubscriptionStatus.TRIALING,\n                trialStartAt: new Date(),\n                trialEndAt: savedOrganization.trialEndAt,\n                currency: 'UAH',\n            });\n\n            await queryRunner.manager.save(subscription);\n\n            // Create admin user\n            const salt = await generateSalt();\n            const passwordHash = await hashPassword(dto.password, salt);\n\n            const user = queryRunner.manager.create(User, {\n                tenantId: savedOrganization.id,\n                firstName: dto.firstName,\n                lastName: dto.lastName,\n                patronymic: dto.patronymic,\n                email: dto.email,\n                phone: dto.phone,\n                passwordHash,\n                salt,\n                role: UserRole.ORGANIZATION_OWNER,\n                status: UserStatus.PENDING,\n                position: dto.position,\n                barNumber: dto.barNumber,\n                emailVerified: false,\n                emailVerificationToken: generateToken(),\n                lastPasswordChangeAt: new Date(),\n            });\n\n            const savedUser = await queryRunner.manager.save(user);\n\n            // Create onboarding progress\n            await queryRunner.manager.getRepository('OnboardingProgress').save({\n                tenantId: savedOrganization.id,\n                userId: savedUser.id,\n                step: 'organization_details',\n                completed: true,\n                completedAt: new Date(),\n                percentage: 20,\n            });\n\n            await queryRunner.manager.getRepository('OnboardingProgress').save({\n                tenantId: savedOrganization.id,\n                userId: savedUser.id,\n                step: 'user_profile',\n                completed: true,\n                completedAt: new Date(),\n                percentage: 40,\n            });\n\n            await queryRunner.commitTransaction();\n\n            this.loggingService.logBusinessEvent('create', 'Organization', savedOrganization.id, {\n                tenantId: savedOrganization.id,\n                userId: savedUser.id,\n                subscriptionPlan: dto.subscriptionPlan,\n            });\n\n            // Send verification email\n            // await this.emailService.sendVerificationEmail(savedUser.email, savedUser.emailVerificationToken);\n\n            // Log audit\n            await this.auditService.log({\n                tenantId: savedOrganization.id,\n                userId: savedUser.id,\n                action: 'create',\n                entityType: 'Organization',\n                entityId: savedOrganization.id,\n                newValues: savedOrganization,\n            });\n\n            return {\n                organizationId: savedOrganization.id,\n                userId: savedUser.id,\n            };\n        } catch (error) {\n            await queryRunner.rollbackTransaction();\n            this.loggingService.logError(error, {\n                action: 'registerOrganization',\n                email: dto.email,\n                organizationName: dto.name,\n            });\n            throw error;\n        } finally {\n            await queryRunner.release();\n        }\n    }\n\n    /**\n     * Simple register - email and password only\n     * Creates a default organization for the user\n     */\n    async register(dto: RegisterDto): Promise<{ userId: string; accessToken: string; refreshToken: string }> {\n        // Check if user already exists\n        const existingUser = await this.userRepository.findOne({\n            where: { email: dto.email.toLowerCase() },\n        });\n\n        if (existingUser) {\n            throw new ConflictException('Користувач з таким email вже існує');\n        }\n\n        // Validate password\n        if (dto.password.length < 8) {\n            throw new ConflictException('Пароль має містити мінімум 8 символів');\n        }\n\n        const queryRunner = this.dataSource.createQueryRunner();\n        await queryRunner.connect();\n        await queryRunner.startTransaction();\n\n        try {\n            // Create a default organization for the user\n            const organization = queryRunner.manager.create(Organization, {\n                name: `Особистий кабінет`,\n                subscriptionPlan: SubscriptionPlan.BASIC,\n                subscriptionStatus: SubscriptionStatus.TRIALING,\n                trialEndAt: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000),\n                maxUsers: 1,\n                status: 'active',\n            });\n\n            const savedOrganization = await queryRunner.manager.save(organization);\n\n            // Create user\n            const salt = await generateSalt();\n            const passwordHash = await hashPassword(dto.password, salt);\n\n            const user = queryRunner.manager.create(User, {\n                tenantId: savedOrganization.id,\n                email: dto.email.toLowerCase(),\n                firstName: '', // Will be filled in profile\n                lastName: '', // Will be filled in profile\n                passwordHash,\n                salt,\n                role: UserRole.ORGANIZATION_OWNER,\n                status: UserStatus.ACTIVE,\n                emailVerified: false,\n                emailVerificationToken: generateToken(),\n                lastPasswordChangeAt: new Date(),\n            });\n\n            const savedUser = await queryRunner.manager.save(user);\n\n            await queryRunner.commitTransaction();\n\n            // Generate tokens for auto-login\n            const accessToken = await this.jwtService.generateAccessToken({\n                user_id: savedUser.id,\n                tenant_id: savedOrganization.id,\n                role: savedUser.role,\n                subscription_plan: savedOrganization.subscriptionPlan,\n                email: savedUser.email,\n            });\n\n            const refreshToken = await this.jwtService.generateRefreshToken({\n                user_id: savedUser.id,\n                tenant_id: savedOrganization.id,\n                token_id: generateUuid(),\n                device_id: generateDeviceFingerprint('registration', '0.0.0.0'),\n            });\n\n            // Save refresh token\n            await this.refreshTokenRepository.save({\n                userId: savedUser.id,\n                tenantId: savedOrganization.id,\n                token: refreshToken,\n                deviceInfo: { userAgent: 'registration', ipAddress: '0.0.0.0' },\n                ipAddress: '0.0.0.0',\n                userAgent: 'registration',\n                expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),\n            });\n\n            this.loggingService.logAuthEvent('register', {\n                userId: savedUser.id,\n                tenantId: savedOrganization.id,\n                email: dto.email,\n            });\n\n            return {\n                userId: savedUser.id,\n                accessToken,\n                refreshToken,\n            };\n        } catch (error) {\n            await queryRunner.rollbackTransaction();\n            this.loggingService.logError(error, {\n                action: 'register',\n                email: dto.email,\n            });\n            throw error;\n        } finally {\n            await queryRunner.release();\n        }\n    }\n\n    /**\n     * Login\n     */\n    async login(dto: LoginDto, ipAddress: string, userAgent: string): Promise<LoginResponseDto> {\n        this.loggingService.debug('Login attempt', { email: dto.email, ipAddress });\n\n        // Find user\n        const user = await this.userRepository.findOne({\n            where: {\n                email: dto.email.toLowerCase(),\n                deletedAt: null,\n            },\n            relations: ['organization'],\n        });\n\n        if (!user) {\n            this.loggingService.logAuthEvent('login_failed', {\n                email: dto.email,\n                ipAddress,\n                userAgent,\n                reason: 'User not found',\n            });\n\n            throw new UnauthorizedException('Невірний email або пароль');\n        }\n\n        // Check account status\n        if (user.status === UserStatus.SUSPENDED) {\n            this.loggingService.logSecurityEvent('login_attempt_suspended', 'high', {\n                userId: user.id,\n                tenantId: user.tenantId,\n                ipAddress,\n                userAgent,\n            });\n            throw new UnauthorizedException('Акаунт призупинено. Зв\\'яжіться з підтримкою.');\n        }\n\n        if (user.status === UserStatus.DELETED) {\n            throw new UnauthorizedException('Акаунт видалено.');\n        }\n\n        // Check account lockout\n        if (user.lockedUntil && user.lockedUntil > new Date()) {\n            const remainingMinutes = Math.ceil((user.lockedUntil.getTime() - Date.now()) / (1000 * 60));\n            this.loggingService.logSecurityEvent('login_attempt_locked', 'medium', {\n                userId: user.id,\n                tenantId: user.tenantId,\n                ipAddress,\n                remainingMinutes,\n                failedAttempts: user.failedLoginAttempts,\n            });\n            throw new UnauthorizedException(`Акаунт заблоковано на ${remainingMinutes} хвилин.`);\n        }\n\n        // Verify password\n        const passwordValid = await verifyPassword(dto.password, user.salt, user.passwordHash);\n\n        if (!passwordValid) {\n            // Increment failed attempts\n            await this.userRepository.increment({ id: user.id }, 'failedLoginAttempts', 1);\n\n            // Lock account if max attempts reached\n            const updatedUser = await this.userRepository.findOne({ where: { id: user.id } });\n            if (updatedUser.failedLoginAttempts >= 5) {\n                const lockedUntil = new Date(Date.now() + 30 * 60 * 1000); // 30 minutes\n                await this.userRepository.update(user.id, { lockedUntil });\n\n                this.loggingService.logSecurityEvent('account_locked', 'high', {\n                    userId: user.id,\n                    tenantId: user.tenantId,\n                    ipAddress,\n                    userAgent,\n                    failedAttempts: updatedUser.failedLoginAttempts,\n                });\n\n                throw new UnauthorizedException('Забагато невдалих спроб. Акаунт заблоковано на 30 хвилин.');\n            }\n\n            // Log failed attempt\n            await this.auditService.log({\n                tenantId: user.tenantId,\n                userId: user.id,\n                action: 'login',\n                entityType: 'User',\n                ipAddress,\n                userAgent,\n                metadata: { reason: 'Invalid password' },\n            });\n\n            this.loggingService.logAuthEvent('login_failed', {\n                userId: user.id,\n                tenantId: user.tenantId,\n                ipAddress,\n                userAgent,\n                reason: 'Invalid password',\n                failedAttempts: updatedUser.failedLoginAttempts + 1,\n            });\n\n            throw new UnauthorizedException('Невірний email або пароль');\n        }\n\n        // Verify MFA if enabled\n        if (user.mfaEnabled && !dto.mfaCode) {\n            this.loggingService.logAuthEvent('mfa_required', {\n                userId: user.id,\n                tenantId: user.tenantId,\n                ipAddress,\n                userAgent,\n            });\n            throw new UnauthorizedException('Введіть код двофакторної аутентифікації');\n        }\n\n        if (user.mfaEnabled && dto.mfaCode) {\n            const mfaValid = await this.verifyMfaCode(user.id, dto.mfaCode);\n            if (!mfaValid) {\n                this.loggingService.logSecurityEvent('mfa_failed', 'medium', {\n                    userId: user.id,\n                    tenantId: user.tenantId,\n                    ipAddress,\n                    userAgent,\n                });\n                throw new UnauthorizedException('Невірний MFA код');\n            }\n\n            this.loggingService.logAuthEvent('mfa_verified', {\n                userId: user.id,\n                tenantId: user.tenantId,\n                ipAddress,\n                userAgent,\n            });\n        }\n\n        // Reset failed attempts\n        await this.userRepository.update(user.id, {\n            failedLoginAttempts: 0,\n            lockedUntil: null,\n            lastLoginAt: new Date(),\n            lastLoginIp: ipAddress,\n        });\n\n        // Generate tokens\n        const accessToken = await this.jwtService.generateAccessToken({\n            user_id: user.id,\n            tenant_id: user.tenantId,\n            role: user.role,\n            subscription_plan: user.organization.subscriptionPlan,\n            email: user.email,\n        });\n\n        const refreshToken = await this.jwtService.generateRefreshToken({\n            user_id: user.id,\n            tenant_id: user.tenantId,\n            token_id: generateUuid(),\n            device_id: generateDeviceFingerprint(userAgent, ipAddress),\n        });\n\n        // Save refresh token\n        const deviceId = generateDeviceFingerprint(userAgent, ipAddress);\n        const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000); // 7 days\n\n        await this.refreshTokenRepository.save({\n            userId: user.id,\n            tenantId: user.tenantId,\n            token: refreshToken,\n            deviceInfo: { userAgent, ipAddress },\n            ipAddress,\n            userAgent,\n            expiresAt,\n        });\n\n        // Limit number of active refresh tokens\n        await this.limitRefreshTokens(user.id);\n\n        // Log successful login\n        await this.auditService.log({\n            tenantId: user.tenantId,\n            userId: user.id,\n            action: 'login',\n            entityType: 'User',\n            entityId: user.id,\n            ipAddress,\n            userAgent,\n        });\n\n        this.loggingService.logAuthEvent('login', {\n            userId: user.id,\n            tenantId: user.tenantId,\n            ipAddress,\n            userAgent,\n            deviceId,\n            mfaEnabled: user.mfaEnabled,\n        });\n\n        return {\n            accessToken,\n            refreshToken,\n            expiresIn: 900, // 15 minutes\n            user: {\n                id: user.id,\n                email: user.email,\n                firstName: user.firstName,\n                lastName: user.lastName,\n                role: user.role,\n                tenantId: user.tenantId,\n                emailVerified: user.emailVerified,\n                mfaEnabled: user.mfaEnabled,\n            },\n            organization: {\n                id: user.organization.id,\n                name: user.organization.name,\n                subscriptionPlan: user.organization.subscriptionPlan,\n                subscriptionStatus: user.organization.subscriptionStatus,\n                trialEndAt: user.organization.trialEndAt?.toISOString(),\n            },\n        };\n    }\n\n    /**\n     * Refresh access token\n     */\n    async refreshToken(dto: RefreshTokenDto): Promise<RefreshTokenResponseDto> {\n        this.loggingService.debug('Token refresh attempt', { tokenLength: dto.refreshToken?.length });\n\n        const payload = await this.jwtService.verifyRefreshToken(dto.refreshToken);\n\n        // Find refresh token in database\n        const refreshTokenEntity = await this.refreshTokenRepository.findOne({\n            where: { token: dto.refreshToken },\n        });\n\n        if (!refreshTokenEntity) {\n            this.loggingService.logSecurityEvent('invalid_refresh_token', 'medium', {\n                userId: payload.user_id,\n                tenantId: payload.tenant_id,\n            });\n            throw new UnauthorizedException('Invalid refresh token');\n        }\n\n        // Check if token is revoked\n        if (refreshTokenEntity.revokedAt) {\n            this.loggingService.logSecurityEvent('revoked_refresh_token_used', 'high', {\n                userId: refreshTokenEntity.userId,\n                tenantId: refreshTokenEntity.tenantId,\n                deviceId: payload.device_id,\n            });\n            throw new UnauthorizedException('Refresh token revoked');\n        }\n\n        // Check if token is expired\n        if (refreshTokenEntity.expiresAt < new Date()) {\n            throw new UnauthorizedException('Refresh token expired');\n        }\n\n        // Find user\n        const user = await this.userRepository.findOne({\n            where: { id: payload.user_id, deletedAt: null },\n            relations: ['organization'],\n        });\n\n        if (!user) {\n            throw new UnauthorizedException('User not found');\n        }\n\n        // Generate new tokens\n        const newAccessToken = await this.jwtService.generateAccessToken({\n            user_id: user.id,\n            tenant_id: user.tenantId,\n            role: user.role,\n            subscription_plan: user.organization.subscriptionPlan,\n            email: user.email,\n        });\n\n        const newRefreshToken = await this.jwtService.generateRefreshToken({\n            user_id: user.id,\n            tenant_id: user.tenantId,\n            token_id: generateUuid(),\n            device_id: payload.device_id,\n        });\n\n        // Revoke old refresh token\n        await this.refreshTokenRepository.update(\n            { id: refreshTokenEntity.id },\n            { revokedAt: new Date() }\n        );\n\n        // Save new refresh token\n        await this.refreshTokenRepository.save({\n            userId: user.id,\n            tenantId: user.tenantId,\n            token: newRefreshToken,\n            deviceInfo: refreshTokenEntity.deviceInfo,\n            ipAddress: refreshTokenEntity.ipAddress,\n            userAgent: refreshTokenEntity.userAgent,\n            expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000), // 7 days\n            replacedBy: refreshTokenEntity.id,\n        });\n\n        this.loggingService.logAuthEvent('token_refresh', {\n            userId: user.id,\n            tenantId: user.tenantId,\n            deviceId: payload.device_id,\n        });\n\n        return {\n            accessToken: newAccessToken,\n            refreshToken: newRefreshToken,\n            expiresIn: 900, // 15 minutes\n        };\n    }\n\n    /**\n     * Logout\n     */\n    async logout(userId: string, dto?: LogoutDto): Promise<void> {\n        this.loggingService.logAuthEvent('logout', { userId });\n\n        if (dto?.refreshToken) {\n            await this.refreshTokenRepository.update(\n                { token: dto.refreshToken },\n                { revokedAt: new Date() }\n            );\n        }\n    }\n\n    /**\n     * Logout all devices\n     */\n    async logoutAllDevices(userId: string): Promise<void> {\n        this.loggingService.logAuthEvent('logout_all_devices', { userId });\n        await this.refreshTokenRepository.update(\n            { userId },\n            { revokedAt: new Date() }\n        );\n    }\n\n    /**\n     * Forgot password\n     */\n    async forgotPassword(dto: ForgotPasswordDto): Promise<void> {\n        this.loggingService.logAuthEvent('password_reset_requested', { email: dto.email });\n\n        const user = await this.userRepository.findOne({\n            where: {\n                email: dto.email.toLowerCase(),\n                deletedAt: null,\n            },\n        });\n\n        if (!user) {\n            // Don't reveal if user exists\n            this.loggingService.debug('Password reset requested for non-existent user', { email: dto.email });\n            return;\n        }\n\n        // Generate password reset token\n        const token = generateToken();\n        const expiresAt = new Date(Date.now() + 60 * 60 * 1000); // 1 hour\n\n        await this.userRepository.update(user.id, {\n            passwordResetToken: token,\n            passwordResetExpiresAt: expiresAt,\n        });\n\n        this.loggingService.logBusinessEvent('create', 'PasswordResetToken', token, {\n            userId: user.id,\n            tenantId: user.tenantId,\n            expiresAt,\n        });\n\n        // Send password reset email\n        // await this.emailService.sendPasswordResetEmail(user.email, token);\n    }\n\n    /**\n     * Reset password\n     */\n    async resetPassword(dto: ResetPasswordDto): Promise<void> {\n        const user = await this.userRepository.findOne({\n            where: {\n                passwordResetToken: dto.token,\n                deletedAt: null,\n            },\n        });\n\n        if (!user) {\n            this.loggingService.logSecurityEvent('invalid_password_reset_token', 'medium', {\n                token: dto.token.substring(0, 10) + '...',\n            });\n            throw new UnauthorizedException('Invalid or expired token');\n        }\n\n        if (user.passwordResetExpiresAt && user.passwordResetExpiresAt < new Date()) {\n            this.loggingService.logSecurityEvent('expired_password_reset_token', 'low', {\n                userId: user.id,\n                tenantId: user.tenantId,\n            });\n            throw new UnauthorizedException('Token expired');\n        }\n\n        // Validate password strength\n        const passwordValidation = validatePasswordStrength(dto.newPassword);\n        if (!passwordValidation.valid) {\n            throw new ConflictException('Password too weak: ' + passwordValidation.errors.join(', '));\n        }\n\n        // Hash new password\n        const salt = await generateSalt();\n        const passwordHash = await hashPassword(dto.newPassword, salt);\n\n        // Update user\n        await this.userRepository.update(user.id, {\n            passwordHash,\n            salt,\n            passwordResetToken: null,\n            passwordResetExpiresAt: null,\n            lastPasswordChangeAt: new Date(),\n        });\n\n        this.loggingService.logBusinessEvent('update', 'User', user.id, {\n            tenantId: user.tenantId,\n            userId: user.id,\n            changedFields: ['password'],\n        });\n\n        // Log audit\n        await this.auditService.log({\n            tenantId: user.tenantId,\n            userId: user.id,\n            action: 'update',\n            entityType: 'User',\n            entityId: user.id,\n            changedFields: ['password'],\n        });\n    }\n\n    /**\n     * Verify email\n     */\n    async verifyEmail(dto: VerifyEmailDto): Promise<void> {\n        const user = await this.userRepository.findOne({\n            where: {\n                emailVerificationToken: dto.token,\n                deletedAt: null,\n            },\n            relations: ['organization'],\n        });\n\n        if (!user) {\n            this.loggingService.logSecurityEvent('invalid_email_verification_token', 'low', {\n                token: dto.token.substring(0, 10) + '...',\n            });\n            throw new UnauthorizedException('Invalid token');\n        }\n\n        await this.userRepository.update(user.id, {\n            emailVerified: true,\n            emailVerifiedAt: new Date(),\n            emailVerificationToken: null,\n            status: UserStatus.ACTIVE,\n        });\n\n        this.loggingService.logBusinessEvent('update', 'User', user.id, {\n            tenantId: user.tenantId,\n            userId: user.id,\n            changedFields: ['emailVerified', 'status'],\n        });\n\n        // Log audit\n        await this.auditService.log({\n            tenantId: user.tenantId,\n            userId: user.id,\n            action: 'update',\n            entityType: 'User',\n            entityId: user.id,\n            changedFields: ['emailVerified'],\n        });\n    }\n\n    /**\n     * Enable MFA\n     */\n    async enableMfa(userId: string): Promise<{ secret: string; backupCodes: string[] }> {\n        const user = await this.userRepository.findOne({ where: { id: userId } });\n\n        if (!user) {\n            throw new UnauthorizedException('User not found');\n        }\n\n        const secret = generateTotpSecret();\n        const backupCodes = generateMfaBackupCodes();\n\n        await this.userRepository.update(userId, {\n            mfaSecret: secret,\n            mfaBackupCodes: backupCodes,\n        });\n\n        this.loggingService.logSecurityEvent('mfa_enabled', 'low', {\n            userId,\n            tenantId: user.tenantId,\n        });\n\n        return { secret, backupCodes };\n    }\n\n    /**\n     * Verify MFA code\n     */\n    private async verifyMfaCode(userId: string, code: string): Promise<boolean> {\n        const user = await this.userRepository.findOne({ where: { id: userId } });\n\n        if (!user || !user.mfaSecret) {\n            return false;\n        }\n\n        // Verify TOTP code\n        const totp = require('otpauth').totp;\n        const totpInstance = new totp({\n            secret: user.mfaSecret,\n            digits: 6,\n            period: 30,\n            window: 2,\n        });\n\n        const delta = totpInstance.validate({ token: code });\n\n        // Check backup codes\n        if (delta === null && user.mfaBackupCodes?.includes(code)) {\n            // Remove used backup code\n            const updatedBackupCodes = user.mfaBackupCodes.filter(c => c !== code);\n            await this.userRepository.update(userId, {\n                mfaBackupCodes: updatedBackupCodes,\n            });\n\n            this.loggingService.logSecurityEvent('mfa_backup_code_used', 'low', {\n                userId,\n                tenantId: user.tenantId,\n                remainingCodes: updatedBackupCodes.length,\n            });\n\n            return true;\n        }\n\n        return delta !== null;\n    }\n\n    /**\n     * Limit number of active refresh tokens per user\n     */\n    private async limitRefreshTokens(userId: string, maxTokens: number = 5): Promise<void> {\n        const tokens = await this.refreshTokenRepository.find({\n            where: { userId, revokedAt: null },\n            order: { createdAt: 'DESC' },\n        });\n\n        if (tokens.length > maxTokens) {\n            const tokensToRevoke = tokens.slice(maxTokens);\n            for (const token of tokensToRevoke) {\n                await this.refreshTokenRepository.update(\n                    { id: token.id },\n                    { revokedAt: new Date() }\n                );\n            }\n        }\n    }\n}\n"],"names":["AuthService","registerOrganization","dto","passwordValidation","validatePasswordStrength","password","valid","loggingService","logAuthEvent","email","reason","ConflictException","errors","join","debug","organizationName","name","queryRunner","dataSource","createQueryRunner","connect","startTransaction","organization","manager","create","Organization","legalForm","edrpou","taxNumber","address","city","region","phone","website","subscriptionPlan","SubscriptionPlan","BASIC","subscriptionStatus","SubscriptionStatus","TRIALING","trialEndAt","Date","now","maxUsers","status","savedOrganization","save","subscription","Subscription","tenantId","id","provider","SubscriptionProvider","WAYFORPAY","plan","trialStartAt","currency","salt","generateSalt","passwordHash","hashPassword","user","User","firstName","lastName","patronymic","role","UserRole","ORGANIZATION_OWNER","UserStatus","PENDING","position","barNumber","emailVerified","emailVerificationToken","generateToken","lastPasswordChangeAt","savedUser","getRepository","userId","step","completed","completedAt","percentage","commitTransaction","logBusinessEvent","auditService","log","action","entityType","entityId","newValues","organizationId","error","rollbackTransaction","logError","release","register","existingUser","userRepository","findOne","where","toLowerCase","length","ACTIVE","accessToken","jwtService","generateAccessToken","user_id","tenant_id","subscription_plan","refreshToken","generateRefreshToken","token_id","generateUuid","device_id","generateDeviceFingerprint","refreshTokenRepository","token","deviceInfo","userAgent","ipAddress","expiresAt","login","deletedAt","relations","UnauthorizedException","SUSPENDED","logSecurityEvent","DELETED","lockedUntil","remainingMinutes","Math","ceil","getTime","failedAttempts","failedLoginAttempts","passwordValid","verifyPassword","increment","updatedUser","update","metadata","mfaEnabled","mfaCode","mfaValid","verifyMfaCode","lastLoginAt","lastLoginIp","deviceId","limitRefreshTokens","expiresIn","toISOString","tokenLength","payload","verifyRefreshToken","refreshTokenEntity","revokedAt","newAccessToken","newRefreshToken","replacedBy","logout","logoutAllDevices","forgotPassword","passwordResetToken","passwordResetExpiresAt","resetPassword","substring","newPassword","changedFields","verifyEmail","emailVerifiedAt","enableMfa","secret","generateTotpSecret","backupCodes","generateMfaBackupCodes","mfaSecret","mfaBackupCodes","code","totp","require","totpInstance","digits","period","window","delta","validate","includes","updatedBackupCodes","filter","c","remainingCodes","maxTokens","tokens","find","order","createdAt","tokensToRevoke","slice","organizationRepository","subscriptionRepository","logger","Logger"],"mappings":"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"}
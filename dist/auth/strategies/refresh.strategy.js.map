{"version":3,"sources":["../../../src/auth/strategies/refresh.strategy.ts"],"sourcesContent":["import { Injectable, UnauthorizedException } from '@nestjs/common';\nimport { PassportStrategy } from '@nestjs/passport';\nimport { ExtractJwt, Strategy } from 'passport-jwt';\nimport { ConfigService } from '@nestjs/config';\nimport { RefreshTokenPayload } from '../interfaces/jwt.interface';\nimport { RefreshToken } from '../../database/entities/RefreshToken.entity';\nimport { InjectRepository } from '@nestjs/typeorm';\nimport { Repository } from 'typeorm';\n\n/**\n * Refresh Token Strategy\n */\n@Injectable()\nexport class RefreshStrategy extends PassportStrategy(Strategy, 'refresh') {\n    constructor(\n        private readonly configService: ConfigService,\n        @InjectRepository(RefreshToken)\n        private readonly refreshTokenRepository: Repository<RefreshToken>,\n    ) {\n        super({\n            jwtFromRequest: ExtractJwt.fromBodyField('refreshToken'),\n            ignoreExpiration: false,\n            secretOrKey: configService.get<string>('JWT_REFRESH_SECRET'),\n        });\n    }\n\n    async validate(\n        payload: RefreshTokenPayload & { iat: number; exp: number }\n    ): Promise<RefreshTokenPayload> {\n        // Find refresh token in database\n        const refreshToken = await this.refreshTokenRepository.findOne({\n            where: { token: payload.token_id },\n        });\n\n        if (!refreshToken) {\n            throw new UnauthorizedException('Refresh token not found');\n        }\n\n        if (refreshToken.revokedAt) {\n            throw new UnauthorizedException('Refresh token revoked');\n        }\n\n        if (refreshToken.expiresAt < new Date()) {\n            throw new UnauthorizedException('Refresh token expired');\n        }\n\n        return {\n            user_id: payload.user_id,\n            tenant_id: payload.tenant_id,\n            token_id: payload.token_id,\n            device_id: payload.device_id,\n        };\n    }\n}\n"],"names":["RefreshStrategy","PassportStrategy","Strategy","validate","payload","refreshToken","refreshTokenRepository","findOne","where","token","token_id","UnauthorizedException","revokedAt","expiresAt","Date","user_id","tenant_id","device_id","configService","jwtFromRequest","ExtractJwt","fromBodyField","ignoreExpiration","secretOrKey","get"],"mappings":";;;;+BAaaA;;;eAAAA;;;wBAbqC;0BACjB;6BACI;wBACP;oCAED;yBACI;0BACN;;;;;;;;;;;;;;;AAMpB,IAAA,AAAMA,kBAAN,MAAMA,wBAAwBC,IAAAA,0BAAgB,EAACC,qBAAQ,EAAE;IAa5D,MAAMC,SACFC,OAA2D,EAC/B;QAC5B,iCAAiC;QACjC,MAAMC,eAAe,MAAM,IAAI,CAACC,sBAAsB,CAACC,OAAO,CAAC;YAC3DC,OAAO;gBAAEC,OAAOL,QAAQM,QAAQ;YAAC;QACrC;QAEA,IAAI,CAACL,cAAc;YACf,MAAM,IAAIM,6BAAqB,CAAC;QACpC;QAEA,IAAIN,aAAaO,SAAS,EAAE;YACxB,MAAM,IAAID,6BAAqB,CAAC;QACpC;QAEA,IAAIN,aAAaQ,SAAS,GAAG,IAAIC,QAAQ;YACrC,MAAM,IAAIH,6BAAqB,CAAC;QACpC;QAEA,OAAO;YACHI,SAASX,QAAQW,OAAO;YACxBC,WAAWZ,QAAQY,SAAS;YAC5BN,UAAUN,QAAQM,QAAQ;YAC1BO,WAAWb,QAAQa,SAAS;QAChC;IACJ;IAtCA,YACI,AAAiBC,aAA4B,EAC7C,AACiBZ,sBAAgD,CACnE;QACE,KAAK,CAAC;YACFa,gBAAgBC,uBAAU,CAACC,aAAa,CAAC;YACzCC,kBAAkB;YAClBC,aAAaL,cAAcM,GAAG,CAAS;QAC3C,SARiBN,gBAAAA,oBAEAZ,yBAAAA;IAOrB;AA6BJ"}
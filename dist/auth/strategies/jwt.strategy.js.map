{"version":3,"sources":["../../../src/auth/strategies/jwt.strategy.ts"],"sourcesContent":["import { Injectable, UnauthorizedException } from '@nestjs/common';\nimport { PassportStrategy } from '@nestjs/passport';\nimport { ExtractJwt, Strategy } from 'passport-jwt';\nimport { ConfigService } from '@nestjs/config';\nimport { JwtPayload } from '../interfaces/jwt.interface';\nimport { User } from '../../database/entities/User.entity';\nimport { InjectRepository } from '@nestjs/typeorm';\nimport { Repository } from 'typeorm';\n\n/**\n * JWT Strategy for Access Tokens\n */\n@Injectable()\nexport class JwtStrategy extends PassportStrategy(Strategy, 'jwt') {\n    constructor(\n        private readonly configService: ConfigService,\n        @InjectRepository(User)\n        private readonly userRepository: Repository<User>,\n    ) {\n        super({\n            jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),\n            ignoreExpiration: false,\n            secretOrKey: configService.get<string>('JWT_SECRET'),\n        });\n    }\n\n    async validate(payload: JwtPayload & { jti: string; iat: number; exp: number }): Promise<JwtPayload> {\n        // Verify user still exists and is active\n        const user = await this.userRepository.findOne({\n            where: {\n                id: payload.user_id,\n                tenantId: payload.tenant_id,\n                deletedAt: null,\n            },\n        });\n\n        if (!user) {\n            throw new UnauthorizedException('User not found');\n        }\n\n        if (user.status !== 'active') {\n            throw new UnauthorizedException('User account is not active');\n        }\n\n        return {\n            user_id: payload.user_id,\n            tenant_id: payload.tenant_id,\n            role: payload.role,\n            subscription_plan: payload.subscription_plan,\n            email: payload.email,\n        };\n    }\n}\n"],"names":["JwtStrategy","PassportStrategy","Strategy","validate","payload","user","userRepository","findOne","where","id","user_id","tenantId","tenant_id","deletedAt","UnauthorizedException","status","role","subscription_plan","email","configService","jwtFromRequest","ExtractJwt","fromAuthHeaderAsBearerToken","ignoreExpiration","secretOrKey","get"],"mappings":";;;;+BAaaA;;;eAAAA;;;wBAbqC;0BACjB;6BACI;wBACP;4BAET;yBACY;0BACN;;;;;;;;;;;;;;;AAMpB,IAAA,AAAMA,cAAN,MAAMA,oBAAoBC,IAAAA,0BAAgB,EAACC,qBAAQ,EAAE;IAaxD,MAAMC,SAASC,OAA+D,EAAuB;QACjG,yCAAyC;QACzC,MAAMC,OAAO,MAAM,IAAI,CAACC,cAAc,CAACC,OAAO,CAAC;YAC3CC,OAAO;gBACHC,IAAIL,QAAQM,OAAO;gBACnBC,UAAUP,QAAQQ,SAAS;gBAC3BC,WAAW;YACf;QACJ;QAEA,IAAI,CAACR,MAAM;YACP,MAAM,IAAIS,6BAAqB,CAAC;QACpC;QAEA,IAAIT,KAAKU,MAAM,KAAK,UAAU;YAC1B,MAAM,IAAID,6BAAqB,CAAC;QACpC;QAEA,OAAO;YACHJ,SAASN,QAAQM,OAAO;YACxBE,WAAWR,QAAQQ,SAAS;YAC5BI,MAAMZ,QAAQY,IAAI;YAClBC,mBAAmBb,QAAQa,iBAAiB;YAC5CC,OAAOd,QAAQc,KAAK;QACxB;IACJ;IArCA,YACI,AAAiBC,aAA4B,EAC7C,AACiBb,cAAgC,CACnD;QACE,KAAK,CAAC;YACFc,gBAAgBC,uBAAU,CAACC,2BAA2B;YACtDC,kBAAkB;YAClBC,aAAaL,cAAcM,GAAG,CAAS;QAC3C,SARiBN,gBAAAA,oBAEAb,iBAAAA;IAOrB;AA4BJ"}
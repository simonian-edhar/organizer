{"version":3,"sources":["../../../src/auth/middleware/index.ts"],"sourcesContent":["import { Injectable, NestMiddleware, ForbiddenException, UnauthorizedException } from '@nestjs/common';\nimport { Request, Response, NextFunction } from 'express';\nimport { JwtPayload } from '../interfaces/jwt.interface';\nimport { generateRateLimitKey } from '../../common/utils/validation.util';\n\n/**\n * Rate Limiting Middleware\n */\n@Injectable()\nexport class RateLimitMiddleware implements NestMiddleware {\n    private rateLimitStore = new Map<string, { count: number; resetTime: number }>();\n\n    async use(req: Request, res: Response, next: NextFunction) {\n        const identifier = this.getIdentifier(req);\n        const action = this.getAction(req);\n        const tenantId = (req.user as JwtPayload)?.tenant_id;\n\n        const key = generateRateLimitKey(identifier, action, tenantId);\n        const now = Date.now();\n        const window = 15 * 60 * 1000; // 15 minutes\n        const maxAttempts = 5;\n\n        const record = this.rateLimitStore.get(key);\n\n        if (!record || now > record.resetTime) {\n            this.rateLimitStore.set(key, {\n                count: 1,\n                resetTime: now + window,\n            });\n            return next();\n        }\n\n        if (record.count >= maxAttempts) {\n            const remainingTime = Math.ceil((record.resetTime - now) / 1000 / 60);\n            throw new ForbiddenException(\n                `Забагато спроб. Спробуйте через ${remainingTime} хвилин.`\n            );\n        }\n\n        record.count++;\n        this.rateLimitStore.set(key, record);\n\n        // Add rate limit headers\n        res.setHeader('X-RateLimit-Limit', maxAttempts);\n        res.setHeader('X-RateLimit-Remaining', maxAttempts - record.count);\n        res.setHeader('X-RateLimit-Reset', record.resetTime);\n\n        next();\n    }\n\n    private getIdentifier(req: Request): string {\n        return (req.user as JwtPayload)?.user_id || req.ip || 'unknown';\n    }\n\n    private getAction(req: Request): string {\n        return `${req.method}:${req.route?.path || req.path}`;\n    }\n}\n\n/**\n * Tenant Context Middleware\n * Ensures all queries include tenant_id\n */\n@Injectable()\nexport class TenantContextMiddleware implements NestMiddleware {\n    use(req: Request, res: Response, next: NextFunction) {\n        const user = req.user as JwtPayload;\n\n        if (!user) {\n            return next();\n        }\n\n        // Set tenant context for downstream services\n        req.tenantId = user.tenant_id;\n        req.userId = user.user_id;\n        req.userRole = user.role;\n        req.subscriptionPlan = user.subscription_plan;\n\n        next();\n    }\n}\n\n/**\n * Request Logging Middleware\n */\n@Injectable()\nexport class RequestLoggingMiddleware implements NestMiddleware {\n    use(req: Request, res: Response, next: NextFunction) {\n        const start = Date.now();\n\n        res.on('finish', () => {\n            const duration = Date.now() - start;\n            const user = req.user as JwtPayload;\n\n            const logData = {\n                method: req.method,\n                path: req.path,\n                statusCode: res.statusCode,\n                duration: `${duration}ms`,\n                userId: user?.user_id,\n                tenantId: user?.tenant_id,\n                ip: req.ip,\n                userAgent: req.get('user-agent'),\n            };\n\n            console.log(JSON.stringify(logData));\n        });\n\n        next();\n    }\n}\n\n/**\n * XSS Protection Middleware\n */\n@Injectable()\nexport class XssProtectionMiddleware implements NestMiddleware {\n    use(req: Request, res: Response, next: NextFunction) {\n        // Set security headers\n        res.setHeader('X-XSS-Protection', '1; mode=block');\n        res.setHeader('X-Content-Type-Options', 'nosniff');\n        res.setHeader('X-Frame-Options', 'DENY');\n        res.setHeader('Content-Security-Policy', \"default-src 'self'\");\n        res.setHeader('Strict-Transport-Security', 'max-age=31536000; includeSubDomains');\n\n        next();\n    }\n}\n\n/**\n * Correlation ID Middleware\n * Adds unique ID to each request for tracing\n */\n@Injectable()\nexport class CorrelationIdMiddleware implements NestMiddleware {\n    use(req: Request, res: Response, next: NextFunction) {\n        const correlationId = req.headers['x-correlation-id'] as string ||\n            `req_${Date.now()}_${Math.random().toString(36).substring(7)}`;\n\n        req.correlationId = correlationId;\n        res.setHeader('X-Correlation-ID', correlationId);\n\n        next();\n    }\n}\n\n/**\n * Password Change Check Middleware\n */\n@Injectable()\nexport class PasswordChangeCheckMiddleware implements NestMiddleware {\n    use(req: Request, res: Response, next: NextFunction) {\n        const user = req.user as JwtPayload;\n        const userDetails = req.userDetails;\n\n        if (!userDetails) {\n            return next();\n        }\n\n        // Check if password was changed recently (e.g., 90 days)\n        if (userDetails.lastPasswordChangeAt) {\n            const daysSinceChange = Math.floor(\n                (Date.now() - userDetails.lastPasswordChangeAt.getTime()) /\n                    (1000 * 60 * 60 * 24)\n            );\n\n            if (daysSinceChange > 90) {\n                // Add warning header (don't block request)\n                res.setHeader('X-Password-Warning', 'password-expiring-soon');\n            }\n        }\n\n        next();\n    }\n}\n"],"names":["CorrelationIdMiddleware","PasswordChangeCheckMiddleware","RateLimitMiddleware","RequestLoggingMiddleware","TenantContextMiddleware","XssProtectionMiddleware","use","req","res","next","identifier","getIdentifier","action","getAction","tenantId","user","tenant_id","key","generateRateLimitKey","now","Date","window","maxAttempts","record","rateLimitStore","get","resetTime","set","count","remainingTime","Math","ceil","ForbiddenException","setHeader","user_id","ip","method","route","path","Map","userId","userRole","role","subscriptionPlan","subscription_plan","start","on","duration","logData","statusCode","userAgent","console","log","JSON","stringify","correlationId","headers","random","toString","substring","userDetails","lastPasswordChangeAt","daysSinceChange","floor","getTime"],"mappings":"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"}
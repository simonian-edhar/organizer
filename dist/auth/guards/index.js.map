{"version":3,"sources":["../../../src/auth/guards/index.ts"],"sourcesContent":["import { Injectable, CanActivate, ExecutionContext, ForbiddenException, UnauthorizedException } from '@nestjs/common';\nimport { Reflector } from '@nestjs/core';\nimport { AuthGuard } from '@nestjs/passport';\nimport { JwtPayload } from '../../auth/interfaces/jwt.interface';\n\n/**\n * JWT Auth Guard\n */\n@Injectable()\nexport class JwtAuthGuard extends AuthGuard('jwt') {}\n\n/**\n * Tenant Guard - Ensures requests include valid tenant_id\n */\n@Injectable()\nexport class TenantGuard implements CanActivate {\n    constructor(private reflector: Reflector) {}\n\n    canActivate(context: ExecutionContext): boolean {\n        const request = context.switchToHttp().getRequest();\n        const user: JwtPayload = request.user;\n\n        if (!user || !user.tenant_id) {\n            throw new UnauthorizedException('Tenant ID missing in JWT');\n        }\n\n        // Set tenant_id in request for downstream use\n        request.tenantId = user.tenant_id;\n\n        return true;\n    }\n}\n\n/**\n * RBAC Guard - Role-Based Access Control\n */\n@Injectable()\nexport class RbacGuard implements CanActivate {\n    constructor(private reflector: Reflector) {}\n\n    canActivate(context: ExecutionContext): boolean {\n        const requiredRoles = this.reflector.getAllAndOverride<string[]>('roles', [\n            context.getHandler(),\n            context.getClass(),\n        ]);\n\n        if (!requiredRoles || requiredRoles.length === 0) {\n            return true;\n        }\n\n        const request = context.switchToHttp().getRequest();\n        const user: JwtPayload = request.user;\n\n        if (!user || !user.role) {\n            throw new UnauthorizedException('Role missing in JWT');\n        }\n\n        const hasRole = requiredRoles.includes(user.role);\n\n        if (!hasRole) {\n            throw new ForbiddenException(\n                `Доступ заборонено. Необхідно: ${requiredRoles.join(', ')}, наявно: ${user.role}`\n            );\n        }\n\n        return true;\n    }\n}\n\n/**\n * Subscription Guard - Feature gating based on plan\n */\n@Injectable()\nexport class SubscriptionGuard implements CanActivate {\n    constructor(private reflector: Reflector) {}\n\n    canActivate(context: ExecutionContext): boolean {\n        const requiredPlan = this.reflector.getAllAndOverride<string>('requiredPlan', [\n            context.getHandler(),\n            context.getClass(),\n        ]);\n\n        if (!requiredPlan) {\n            return true;\n        }\n\n        const request = context.switchToHttp().getRequest();\n        const user: JwtPayload = request.user;\n\n        if (!user || !user.subscription_plan) {\n            throw new UnauthorizedException('Subscription plan missing in JWT');\n        }\n\n        // Plan hierarchy: basic < professional < enterprise\n        const planLevels = {\n            basic: 1,\n            professional: 2,\n            enterprise: 3,\n        };\n\n        const userLevel = planLevels[user.subscription_plan];\n        const requiredLevel = planLevels[requiredPlan];\n\n        if (userLevel < requiredLevel) {\n            throw new ForbiddenException(\n                `Ця функція доступна на тарифі ${requiredPlan}`\n            );\n        }\n\n        return true;\n    }\n}\n\n/**\n * Owner Guard - Only organization owner can access\n */\n@Injectable()\nexport class OwnerGuard implements CanActivate {\n    canActivate(context: ExecutionContext): boolean {\n        const request = context.switchToHttp().getRequest();\n        const user: JwtPayload = request.user;\n\n        if (!user || user.role !== 'organization_owner') {\n            throw new ForbiddenException(\n                'Тільки власник організації може виконувати цю дію'\n            );\n        }\n\n        return true;\n    }\n}\n\n/**\n * Email Verified Guard - Require verified email\n */\n@Injectable()\nexport class EmailVerifiedGuard implements CanActivate {\n    canActivate(context: ExecutionContext): boolean {\n        const request = context.switchToHttp().getRequest();\n        const user: JwtPayload = request.user;\n\n        if (!user) {\n            throw new UnauthorizedException('Unauthorized');\n        }\n\n        // Email verified status should be in JWT or fetched from DB\n        const emailVerified = request.userDetails?.emailVerified ?? false;\n\n        if (!emailVerified) {\n            throw new ForbiddenException(\n                'Будь ласка, підтвердіть свою електронну пошту'\n            );\n        }\n\n        return true;\n    }\n}\n\n/**\n * MFA Enabled Guard - Require MFA for sensitive operations\n */\n@Injectable()\nexport class MfaGuard implements CanActivate {\n    constructor(private reflector: Reflector) {}\n\n    canActivate(context: ExecutionContext): boolean {\n        const requireMfa = this.reflector.getAllAndOverride<boolean>('requireMfa', [\n            context.getHandler(),\n            context.getClass(),\n        ]);\n\n        if (!requireMfa) {\n            return true;\n        }\n\n        const request = context.switchToHttp().getRequest();\n        const user: JwtPayload = request.user;\n        const mfaEnabled = request.userDetails?.mfaEnabled ?? false;\n\n        if (!mfaEnabled) {\n            throw new ForbiddenException(\n                'Ця дія вимагає увімкненої двофакторної аутентифікації'\n            );\n        }\n\n        return true;\n    }\n}\n\n/**\n * Super Admin Guard - Only super admins\n */\n@Injectable()\nexport class SuperAdminGuard implements CanActivate {\n    canActivate(context: ExecutionContext): boolean {\n        const request = context.switchToHttp().getRequest();\n        const user: JwtPayload = request.user;\n\n        if (user.role !== 'super_admin') {\n            throw new ForbiddenException(\n                'Тільки супер адміністратор має доступ до цього ресурсу'\n            );\n        }\n\n        return true;\n    }\n}\n\n/**\n * Account Active Guard - Ensure account is not suspended/deleted\n */\n@Injectable()\nexport class AccountActiveGuard implements CanActivate {\n    canActivate(context: ExecutionContext): boolean {\n        const request = context.switchToHttp().getRequest();\n        const userDetails = request.userDetails;\n\n        if (!userDetails) {\n            throw new UnauthorizedException('User details missing');\n        }\n\n        const status = userDetails.status;\n\n        if (status === 'suspended') {\n            throw new ForbiddenException(\n                'Ваш акаунт призупинено. Зв\\'яжіться з підтримкою.'\n            );\n        }\n\n        if (status === 'deleted') {\n            throw new ForbiddenException(\n                'Ваш акаунт видалено.'\n            );\n        }\n\n        return true;\n    }\n}\n\n/**\n * Combined Guard - All guards must pass\n */\n@Injectable()\nexport class CombinedGuard implements CanActivate {\n    constructor(\n        private tenantGuard: TenantGuard,\n        private rbacGuard: RbacGuard,\n        private subscriptionGuard: SubscriptionGuard,\n    ) {}\n\n    async canActivate(context: ExecutionContext): Promise<boolean> {\n        const guards = [this.tenantGuard, this.rbacGuard, this.subscriptionGuard];\n\n        for (const guard of guards) {\n            const result = await guard.canActivate(context);\n            if (!result) {\n                return false;\n            }\n        }\n\n        return true;\n    }\n}\n"],"names":["AccountActiveGuard","CombinedGuard","EmailVerifiedGuard","JwtAuthGuard","MfaGuard","OwnerGuard","RbacGuard","SubscriptionGuard","SuperAdminGuard","TenantGuard","AuthGuard","canActivate","context","request","switchToHttp","getRequest","user","tenant_id","UnauthorizedException","tenantId","reflector","requiredRoles","getAllAndOverride","getHandler","getClass","length","role","hasRole","includes","ForbiddenException","join","requiredPlan","subscription_plan","planLevels","basic","professional","enterprise","userLevel","requiredLevel","emailVerified","userDetails","requireMfa","mfaEnabled","status","guards","tenantGuard","rbacGuard","subscriptionGuard","guard","result"],"mappings":"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"}
{"version":3,"sources":["../../../src/frontend/services/api.ts"],"sourcesContent":["import axios, { AxiosInstance, AxiosRequestConfig, AxiosResponse, AxiosError } from 'axios';\nimport { AuthResponse } from '../types/auth.types';\n\n// Extend axios config to include metadata for timing\ndeclare module 'axios' {\n    interface AxiosRequestConfig {\n        metadata?: { startTime: number };\n    }\n}\n\n// Import logger conditionally to avoid circular dependencies\nlet logger: any = null;\nconst getLogger = () => {\n    if (!logger) {\n        try {\n            logger = require('./logger.service').logger;\n        } catch {\n            // Fallback to console if logger not available\n            logger = {\n                apiCall: (method: string, url: string, duration: number, status: number, error?: string) => {\n                    console.log(`[API] ${method} ${url} - ${status} (${duration}ms)${error ? ` - ${error}` : ''}`);\n                },\n                error: (message: string, error?: Error) => {\n                    console.error(message, error);\n                },\n            };\n        }\n    }\n    return logger;\n};\n\n/**\n * API Client Configuration\n */\nconst BASE_URL = import.meta.env.VITE_API_URL || 'http://localhost:3000/v1';\n\nclass ApiClient {\n    private client: AxiosInstance;\n\n    constructor() {\n        this.client = axios.create({\n            baseURL: BASE_URL,\n            headers: {\n                'Content-Type': 'application/json',\n            },\n        });\n\n        this.setupInterceptors();\n    }\n\n    /**\n     * Setup request and response interceptors\n     */\n    private setupInterceptors(): void {\n        // Request interceptor - Add auth token and logging\n        this.client.interceptors.request.use(\n            (config) => {\n                // Add timestamp for duration tracking\n                config.metadata = { startTime: Date.now() };\n\n                // Add auth token\n                const token = localStorage.getItem('access_token');\n                if (token && config.headers) {\n                    config.headers.Authorization = `Bearer ${token}`;\n                }\n\n                // Log request in development\n                if (process.env.NODE_ENV === 'development') {\n                    console.log(`[API Request] ${config.method?.toUpperCase()} ${config.url}`, config.data);\n                }\n\n                return config;\n            },\n            (error) => {\n                getLogger().error('API request setup error', error, 'APIClient');\n                return Promise.reject(error);\n            }\n        );\n\n        // Response interceptor - Handle logging, errors, and token refresh\n        this.client.interceptors.response.use(\n            (response) => {\n                this.logResponse(response);\n                return response;\n            },\n            async (error: AxiosError) => {\n                return this.handleResponseError(error);\n            }\n        );\n    }\n\n    /**\n     * Log successful response\n     */\n    private logResponse(response: AxiosResponse): void {\n        const duration = Date.now() - (response.config.metadata?.startTime || Date.now());\n\n        getLogger().apiCall(\n            response.config.method?.toUpperCase() || 'GET',\n            response.config.url || '',\n            duration,\n            response.status\n        );\n    }\n\n    /**\n     * Handle response errors\n     */\n    private async handleResponseError(error: AxiosError): Promise<any> {\n        const originalRequest = error.config as any;\n        const duration = Date.now() - (originalRequest?.metadata?.startTime || Date.now());\n\n        // Log error\n        getLogger().apiCall(\n            originalRequest?.method?.toUpperCase() || 'GET',\n            originalRequest?.url || '',\n            duration,\n            error.response?.status || 0,\n            error.message\n        );\n\n        // Log detailed error info\n        if (error.response) {\n            getLogger().error(\n                `API Error: ${error.response.status}`,\n                new Error(error.message),\n                'APIClient',\n                {\n                    url: originalRequest?.url,\n                    method: originalRequest?.method,\n                    status: error.response.status,\n                    data: error.response.data,\n                }\n            );\n        } else if (error.request) {\n            getLogger().error(\n                'API Network Error',\n                error,\n                'APIClient',\n                {\n                    url: originalRequest?.url,\n                    method: originalRequest?.method,\n                }\n            );\n        }\n\n        // Handle 401 - Token refresh\n        if (\n            error.response?.status === 401 &&\n            !originalRequest._retry &&\n            originalRequest.url !== '/auth/login' &&\n            originalRequest.url !== '/auth/refresh'\n        ) {\n            return this.handleTokenRefresh(originalRequest);\n        }\n\n        // Handle common errors\n        this.handleCommonErrors(error);\n\n        return Promise.reject(error);\n    }\n\n    /**\n     * Handle token refresh for 401 errors\n     */\n    private async handleTokenRefresh(originalRequest: any): Promise<any> {\n        originalRequest._retry = true;\n\n        try {\n            const refreshToken = localStorage.getItem('refresh_token');\n            if (!refreshToken) {\n                throw new Error('No refresh token');\n            }\n\n            const response = await this.client.post<AuthResponse>(\n                '/auth/refresh',\n                { refreshToken }\n            );\n\n            const { accessToken, refreshToken: newRefreshToken } = response.data;\n\n            // Update tokens\n            localStorage.setItem('access_token', accessToken);\n            localStorage.setItem('refresh_token', newRefreshToken);\n\n            getLogger().info('Token refreshed successfully', 'APIClient');\n\n            // Retry original request with new token\n            originalRequest.headers.Authorization = `Bearer ${accessToken}`;\n            return this.client(originalRequest);\n        } catch (refreshError) {\n            getLogger().warn('Token refresh failed, redirecting to login', 'APIClient');\n\n            // Refresh failed, clear tokens and redirect to login\n            localStorage.removeItem('access_token');\n            localStorage.removeItem('refresh_token');\n            window.location.href = '/login';\n            return Promise.reject(refreshError);\n        }\n    }\n\n    /**\n     * Handle common HTTP errors\n     */\n    private handleCommonErrors(error: AxiosError): void {\n        const status = error.response?.status;\n\n        switch (status) {\n            case 403:\n                getLogger().warn('Access forbidden', 'APIClient', {\n                    url: error.config?.url,\n                });\n                break;\n            case 404:\n                getLogger().warn('Resource not found', 'APIClient', {\n                    url: error.config?.url,\n                });\n                break;\n            case 429:\n                getLogger().warn('Rate limit exceeded', 'APIClient');\n                break;\n            case 500:\n            case 502:\n            case 503:\n                getLogger().error(\n                    'Server error',\n                    new Error(`HTTP ${status}`),\n                    'APIClient',\n                    { url: error.config?.url }\n                );\n                break;\n        }\n    }\n\n    /**\n     * GET request\n     */\n    async get<T = any>(url: string, config?: AxiosRequestConfig): Promise<T> {\n        const response: AxiosResponse<T> = await this.client.get(url, config);\n        return response.data;\n    }\n\n    /**\n     * POST request\n     */\n    async post<T = any>(url: string, data?: any, config?: AxiosRequestConfig): Promise<T> {\n        const response: AxiosResponse<T> = await this.client.post(url, data, config);\n        return response.data;\n    }\n\n    /**\n     * PUT request\n     */\n    async put<T = any>(url: string, data?: any, config?: AxiosRequestConfig): Promise<T> {\n        const response: AxiosResponse<T> = await this.client.put(url, data, config);\n        return response.data;\n    }\n\n    /**\n     * PATCH request\n     */\n    async patch<T = any>(url: string, data?: any, config?: AxiosRequestConfig): Promise<T> {\n        const response: AxiosResponse<T> = await this.client.patch(url, data, config);\n        return response.data;\n    }\n\n    /**\n     * DELETE request\n     */\n    async delete<T = any>(url: string, config?: AxiosRequestConfig): Promise<T> {\n        const response: AxiosResponse<T> = await this.client.delete(url, config);\n        return response.data;\n    }\n\n    /**\n     * Upload file\n     */\n    async upload<T = any>(\n        url: string,\n        file: File,\n        onProgress?: (progress: number) => void\n    ): Promise<T> {\n        const formData = new FormData();\n        formData.append('file', file);\n\n        const response: AxiosResponse<T> = await this.client.post(url, formData, {\n            headers: {\n                'Content-Type': 'multipart/form-data',\n            },\n            onUploadProgress: (progressEvent) => {\n                if (onProgress && progressEvent.total) {\n                    const progress = Math.round((progressEvent.loaded * 100) / progressEvent.total);\n                    onProgress(progress);\n                }\n            },\n        });\n\n        return response.data;\n    }\n\n    /**\n     * Download file\n     */\n    async download(url: string, filename: string): Promise<void> {\n        const response = await this.client.get(url, {\n            responseType: 'blob',\n        });\n\n        const urlBlob = window.URL.createObjectURL(new Blob([response.data]));\n        const link = document.createElement('a');\n        link.href = urlBlob;\n        link.setAttribute('download', filename);\n        document.body.appendChild(link);\n        link.click();\n        link.remove();\n        window.URL.revokeObjectURL(urlBlob);\n    }\n}\n\nexport const api = new ApiClient();\nexport default api;\n"],"names":["api","logger","getLogger","require","apiCall","method","url","duration","status","error","console","log","message","BASE_URL","env","VITE_API_URL","ApiClient","setupInterceptors","client","interceptors","request","use","config","metadata","startTime","Date","now","token","localStorage","getItem","headers","Authorization","process","NODE_ENV","toUpperCase","data","Promise","reject","response","logResponse","handleResponseError","originalRequest","Error","_retry","handleTokenRefresh","handleCommonErrors","refreshToken","post","accessToken","newRefreshToken","setItem","info","refreshError","warn","removeItem","window","location","href","get","put","patch","delete","upload","file","onProgress","formData","FormData","append","onUploadProgress","progressEvent","total","progress","Math","round","loaded","download","filename","responseType","urlBlob","URL","createObjectURL","Blob","link","document","createElement","setAttribute","body","appendChild","click","remove","revokeObjectURL","axios","create","baseURL"],"mappings":";;;;;;;;;;;QA+TaA;eAAAA;;QACb;eAAA;;;8DAhUoF;;;;;;AAUpF,6DAA6D;AAC7D,IAAIC,SAAc;AAClB,MAAMC,YAAY;IACd,IAAI,CAACD,QAAQ;QACT,IAAI;YACAA,SAASE,QAAQ,oBAAoBF,MAAM;QAC/C,EAAE,OAAM;YACJ,8CAA8C;YAC9CA,SAAS;gBACLG,SAAS,CAACC,QAAgBC,KAAaC,UAAkBC,QAAgBC;oBACrEC,QAAQC,GAAG,CAAC,CAAC,MAAM,EAAEN,OAAO,CAAC,EAAEC,IAAI,GAAG,EAAEE,OAAO,EAAE,EAAED,SAAS,GAAG,EAAEE,QAAQ,CAAC,GAAG,EAAEA,OAAO,GAAG,IAAI;gBACjG;gBACAA,OAAO,CAACG,SAAiBH;oBACrBC,QAAQD,KAAK,CAACG,SAASH;gBAC3B;YACJ;QACJ;IACJ;IACA,OAAOR;AACX;AAEA;;CAEC,GACD,MAAMY,WAAW,YAAYC,GAAG,CAACC,YAAY,IAAI;AAEjD,IAAA,AAAMC,YAAN,MAAMA;IAcF;;KAEC,GACD,AAAQC,oBAA0B;QAC9B,mDAAmD;QACnD,IAAI,CAACC,MAAM,CAACC,YAAY,CAACC,OAAO,CAACC,GAAG,CAChC,CAACC;YACG,sCAAsC;YACtCA,OAAOC,QAAQ,GAAG;gBAAEC,WAAWC,KAAKC,GAAG;YAAG;YAE1C,iBAAiB;YACjB,MAAMC,QAAQC,aAAaC,OAAO,CAAC;YACnC,IAAIF,SAASL,OAAOQ,OAAO,EAAE;gBACzBR,OAAOQ,OAAO,CAACC,aAAa,GAAG,CAAC,OAAO,EAAEJ,OAAO;YACpD;YAEA,6BAA6B;YAC7B,IAAIK,QAAQlB,GAAG,CAACmB,QAAQ,KAAK,eAAe;gBACxCvB,QAAQC,GAAG,CAAC,CAAC,cAAc,EAAEW,OAAOjB,MAAM,EAAE6B,cAAc,CAAC,EAAEZ,OAAOhB,GAAG,EAAE,EAAEgB,OAAOa,IAAI;YAC1F;YAEA,OAAOb;QACX,GACA,CAACb;YACGP,YAAYO,KAAK,CAAC,2BAA2BA,OAAO;YACpD,OAAO2B,QAAQC,MAAM,CAAC5B;QAC1B;QAGJ,mEAAmE;QACnE,IAAI,CAACS,MAAM,CAACC,YAAY,CAACmB,QAAQ,CAACjB,GAAG,CACjC,CAACiB;YACG,IAAI,CAACC,WAAW,CAACD;YACjB,OAAOA;QACX,GACA,OAAO7B;YACH,OAAO,IAAI,CAAC+B,mBAAmB,CAAC/B;QACpC;IAER;IAEA;;KAEC,GACD,AAAQ8B,YAAYD,QAAuB,EAAQ;QAC/C,MAAM/B,WAAWkB,KAAKC,GAAG,KAAMY,CAAAA,SAAShB,MAAM,CAACC,QAAQ,EAAEC,aAAaC,KAAKC,GAAG,EAAC;QAE/ExB,YAAYE,OAAO,CACfkC,SAAShB,MAAM,CAACjB,MAAM,EAAE6B,iBAAiB,OACzCI,SAAShB,MAAM,CAAChB,GAAG,IAAI,IACvBC,UACA+B,SAAS9B,MAAM;IAEvB;IAEA;;KAEC,GACD,MAAcgC,oBAAoB/B,KAAiB,EAAgB;QAC/D,MAAMgC,kBAAkBhC,MAAMa,MAAM;QACpC,MAAMf,WAAWkB,KAAKC,GAAG,KAAMe,CAAAA,iBAAiBlB,UAAUC,aAAaC,KAAKC,GAAG,EAAC;QAEhF,YAAY;QACZxB,YAAYE,OAAO,CACfqC,iBAAiBpC,QAAQ6B,iBAAiB,OAC1CO,iBAAiBnC,OAAO,IACxBC,UACAE,MAAM6B,QAAQ,EAAE9B,UAAU,GAC1BC,MAAMG,OAAO;QAGjB,0BAA0B;QAC1B,IAAIH,MAAM6B,QAAQ,EAAE;YAChBpC,YAAYO,KAAK,CACb,CAAC,WAAW,EAAEA,MAAM6B,QAAQ,CAAC9B,MAAM,EAAE,EACrC,IAAIkC,MAAMjC,MAAMG,OAAO,GACvB,aACA;gBACIN,KAAKmC,iBAAiBnC;gBACtBD,QAAQoC,iBAAiBpC;gBACzBG,QAAQC,MAAM6B,QAAQ,CAAC9B,MAAM;gBAC7B2B,MAAM1B,MAAM6B,QAAQ,CAACH,IAAI;YAC7B;QAER,OAAO,IAAI1B,MAAMW,OAAO,EAAE;YACtBlB,YAAYO,KAAK,CACb,qBACAA,OACA,aACA;gBACIH,KAAKmC,iBAAiBnC;gBACtBD,QAAQoC,iBAAiBpC;YAC7B;QAER;QAEA,6BAA6B;QAC7B,IACII,MAAM6B,QAAQ,EAAE9B,WAAW,OAC3B,CAACiC,gBAAgBE,MAAM,IACvBF,gBAAgBnC,GAAG,KAAK,iBACxBmC,gBAAgBnC,GAAG,KAAK,iBAC1B;YACE,OAAO,IAAI,CAACsC,kBAAkB,CAACH;QACnC;QAEA,uBAAuB;QACvB,IAAI,CAACI,kBAAkB,CAACpC;QAExB,OAAO2B,QAAQC,MAAM,CAAC5B;IAC1B;IAEA;;KAEC,GACD,MAAcmC,mBAAmBH,eAAoB,EAAgB;QACjEA,gBAAgBE,MAAM,GAAG;QAEzB,IAAI;YACA,MAAMG,eAAelB,aAAaC,OAAO,CAAC;YAC1C,IAAI,CAACiB,cAAc;gBACf,MAAM,IAAIJ,MAAM;YACpB;YAEA,MAAMJ,WAAW,MAAM,IAAI,CAACpB,MAAM,CAAC6B,IAAI,CACnC,iBACA;gBAAED;YAAa;YAGnB,MAAM,EAAEE,WAAW,EAAEF,cAAcG,eAAe,EAAE,GAAGX,SAASH,IAAI;YAEpE,gBAAgB;YAChBP,aAAasB,OAAO,CAAC,gBAAgBF;YACrCpB,aAAasB,OAAO,CAAC,iBAAiBD;YAEtC/C,YAAYiD,IAAI,CAAC,gCAAgC;YAEjD,wCAAwC;YACxCV,gBAAgBX,OAAO,CAACC,aAAa,GAAG,CAAC,OAAO,EAAEiB,aAAa;YAC/D,OAAO,IAAI,CAAC9B,MAAM,CAACuB;QACvB,EAAE,OAAOW,cAAc;YACnBlD,YAAYmD,IAAI,CAAC,8CAA8C;YAE/D,qDAAqD;YACrDzB,aAAa0B,UAAU,CAAC;YACxB1B,aAAa0B,UAAU,CAAC;YACxBC,OAAOC,QAAQ,CAACC,IAAI,GAAG;YACvB,OAAOrB,QAAQC,MAAM,CAACe;QAC1B;IACJ;IAEA;;KAEC,GACD,AAAQP,mBAAmBpC,KAAiB,EAAQ;QAChD,MAAMD,SAASC,MAAM6B,QAAQ,EAAE9B;QAE/B,OAAQA;YACJ,KAAK;gBACDN,YAAYmD,IAAI,CAAC,oBAAoB,aAAa;oBAC9C/C,KAAKG,MAAMa,MAAM,EAAEhB;gBACvB;gBACA;YACJ,KAAK;gBACDJ,YAAYmD,IAAI,CAAC,sBAAsB,aAAa;oBAChD/C,KAAKG,MAAMa,MAAM,EAAEhB;gBACvB;gBACA;YACJ,KAAK;gBACDJ,YAAYmD,IAAI,CAAC,uBAAuB;gBACxC;YACJ,KAAK;YACL,KAAK;YACL,KAAK;gBACDnD,YAAYO,KAAK,CACb,gBACA,IAAIiC,MAAM,CAAC,KAAK,EAAElC,QAAQ,GAC1B,aACA;oBAAEF,KAAKG,MAAMa,MAAM,EAAEhB;gBAAI;gBAE7B;QACR;IACJ;IAEA;;KAEC,GACD,MAAMoD,IAAapD,GAAW,EAAEgB,MAA2B,EAAc;QACrE,MAAMgB,WAA6B,MAAM,IAAI,CAACpB,MAAM,CAACwC,GAAG,CAACpD,KAAKgB;QAC9D,OAAOgB,SAASH,IAAI;IACxB;IAEA;;KAEC,GACD,MAAMY,KAAczC,GAAW,EAAE6B,IAAU,EAAEb,MAA2B,EAAc;QAClF,MAAMgB,WAA6B,MAAM,IAAI,CAACpB,MAAM,CAAC6B,IAAI,CAACzC,KAAK6B,MAAMb;QACrE,OAAOgB,SAASH,IAAI;IACxB;IAEA;;KAEC,GACD,MAAMwB,IAAarD,GAAW,EAAE6B,IAAU,EAAEb,MAA2B,EAAc;QACjF,MAAMgB,WAA6B,MAAM,IAAI,CAACpB,MAAM,CAACyC,GAAG,CAACrD,KAAK6B,MAAMb;QACpE,OAAOgB,SAASH,IAAI;IACxB;IAEA;;KAEC,GACD,MAAMyB,MAAetD,GAAW,EAAE6B,IAAU,EAAEb,MAA2B,EAAc;QACnF,MAAMgB,WAA6B,MAAM,IAAI,CAACpB,MAAM,CAAC0C,KAAK,CAACtD,KAAK6B,MAAMb;QACtE,OAAOgB,SAASH,IAAI;IACxB;IAEA;;KAEC,GACD,MAAM0B,OAAgBvD,GAAW,EAAEgB,MAA2B,EAAc;QACxE,MAAMgB,WAA6B,MAAM,IAAI,CAACpB,MAAM,CAAC2C,MAAM,CAACvD,KAAKgB;QACjE,OAAOgB,SAASH,IAAI;IACxB;IAEA;;KAEC,GACD,MAAM2B,OACFxD,GAAW,EACXyD,IAAU,EACVC,UAAuC,EAC7B;QACV,MAAMC,WAAW,IAAIC;QACrBD,SAASE,MAAM,CAAC,QAAQJ;QAExB,MAAMzB,WAA6B,MAAM,IAAI,CAACpB,MAAM,CAAC6B,IAAI,CAACzC,KAAK2D,UAAU;YACrEnC,SAAS;gBACL,gBAAgB;YACpB;YACAsC,kBAAkB,CAACC;gBACf,IAAIL,cAAcK,cAAcC,KAAK,EAAE;oBACnC,MAAMC,WAAWC,KAAKC,KAAK,CAAC,AAACJ,cAAcK,MAAM,GAAG,MAAOL,cAAcC,KAAK;oBAC9EN,WAAWO;gBACf;YACJ;QACJ;QAEA,OAAOjC,SAASH,IAAI;IACxB;IAEA;;KAEC,GACD,MAAMwC,SAASrE,GAAW,EAAEsE,QAAgB,EAAiB;QACzD,MAAMtC,WAAW,MAAM,IAAI,CAACpB,MAAM,CAACwC,GAAG,CAACpD,KAAK;YACxCuE,cAAc;QAClB;QAEA,MAAMC,UAAUvB,OAAOwB,GAAG,CAACC,eAAe,CAAC,IAAIC,KAAK;YAAC3C,SAASH,IAAI;SAAC;QACnE,MAAM+C,OAAOC,SAASC,aAAa,CAAC;QACpCF,KAAKzB,IAAI,GAAGqB;QACZI,KAAKG,YAAY,CAAC,YAAYT;QAC9BO,SAASG,IAAI,CAACC,WAAW,CAACL;QAC1BA,KAAKM,KAAK;QACVN,KAAKO,MAAM;QACXlC,OAAOwB,GAAG,CAACW,eAAe,CAACZ;IAC/B;IArRA,aAAc;QACV,IAAI,CAAC5D,MAAM,GAAGyE,cAAK,CAACC,MAAM,CAAC;YACvBC,SAAShF;YACTiB,SAAS;gBACL,gBAAgB;YACpB;QACJ;QAEA,IAAI,CAACb,iBAAiB;IAC1B;AA6QJ;AAEO,MAAMjB,MAAM,IAAIgB;MACvB,WAAehB"}
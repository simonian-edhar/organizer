{"version":3,"sources":["../../../../src/enterprise/audit/interceptors/audit.interceptor.ts"],"sourcesContent":["import { Injectable, NestInterceptor, ExecutionContext, CallHandler } from '@nestjs/common';\nimport { Observable } from 'rxjs';\nimport { tap } from 'rxjs/operators';\nimport { WormAuditService } from '../services/worm-audit.service';\nimport { JwtPayload } from '../../../auth/interfaces/jwt.interface';\n\n/**\n * Audit Interceptor\n * Automatically logs audit events for controller actions\n */\n@Injectable()\nexport class AuditInterceptor implements NestInterceptor {\n    constructor(private readonly auditService: WormAuditService) {}\n\n    intercept(context: ExecutionContext, next: CallHandler): Observable<any> {\n        const request = context.switchToHttp().getRequest();\n        const user = request.user as JwtPayload;\n\n        if (!user?.tenant_id) {\n            return next.handle();\n        }\n\n        const handler = context.getHandler();\n        const className = context.getClass().name;\n        const method = request.method;\n        const path = request.route?.path || request.path;\n\n        return next.handle().pipe(\n            tap({\n                next: () => {\n                    // Log successful operation\n                    this.logOperation(request, user, className, method, path, 'success');\n                },\n                error: (error) => {\n                    // Log failed operation\n                    this.logOperation(request, user, className, method, path, 'failure', error.message);\n                },\n            })\n        );\n    }\n\n    private async logOperation(\n        request: any,\n        user: JwtPayload,\n        className: string,\n        method: string,\n        path: string,\n        status: 'success' | 'failure',\n        errorMessage?: string\n    ) {\n        try {\n            const action = this.mapMethodToAction(method);\n            const entityType = this.mapClassToEntity(className);\n\n            await this.auditService.log({\n                tenantId: user.tenant_id,\n                userId: user.user_id,\n                action,\n                entityType,\n                entityId: request.params?.id,\n                newValues: method === 'POST' || method === 'PUT' || method === 'PATCH'\n                    ? this.sanitizeBody(request.body)\n                    : undefined,\n                ipAddress: request.ip,\n                userAgent: request.headers['user-agent'],\n                requestId: request.correlationId,\n                metadata: {\n                    method,\n                    path,\n                    status,\n                    errorMessage,\n                },\n            });\n        } catch (error) {\n            // Don't fail the request if audit logging fails\n            console.error('Audit logging failed:', error);\n        }\n    }\n\n    private mapMethodToAction(method: string): any {\n        const mapping: Record<string, string> = {\n            POST: 'create',\n            PUT: 'update',\n            PATCH: 'update',\n            DELETE: 'delete',\n            GET: 'export',\n        };\n        return mapping[method] || 'update';\n    }\n\n    private mapClassToEntity(className: string): string {\n        // Map controller names to entity types\n        const mapping: Record<string, string> = {\n            ClientsController: 'client',\n            CasesController: 'case',\n            DocumentsController: 'document',\n            EventsController: 'event',\n            InvoicesController: 'invoice',\n            OrganizationController: 'organization',\n            AuthController: 'auth',\n            BillingController: 'subscription',\n        };\n        return mapping[className] || className.replace('Controller', '').toLowerCase();\n    }\n\n    private sanitizeBody(body: any): Record<string, any> {\n        if (!body) return {};\n\n        const sanitized = { ...body };\n        const sensitiveFields = ['password', 'passwordConfirm', 'currentPassword', 'token', 'secret'];\n\n        for (const field of sensitiveFields) {\n            if (sanitized[field]) {\n                sanitized[field] = '[REDACTED]';\n            }\n        }\n\n        return sanitized;\n    }\n}\n"],"names":["AuditInterceptor","intercept","context","next","request","switchToHttp","getRequest","user","tenant_id","handle","handler","getHandler","className","getClass","name","method","path","route","pipe","tap","logOperation","error","message","status","errorMessage","action","mapMethodToAction","entityType","mapClassToEntity","auditService","log","tenantId","userId","user_id","entityId","params","id","newValues","sanitizeBody","body","undefined","ipAddress","ip","userAgent","headers","requestId","correlationId","metadata","console","mapping","POST","PUT","PATCH","DELETE","GET","ClientsController","CasesController","DocumentsController","EventsController","InvoicesController","OrganizationController","AuthController","BillingController","replace","toLowerCase","sanitized","sensitiveFields","field"],"mappings":"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"}
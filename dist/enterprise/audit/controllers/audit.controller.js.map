{"version":3,"sources":["../../../../src/enterprise/audit/controllers/audit.controller.ts"],"sourcesContent":["import { Controller, Get, Post, Query, Param, UseGuards, Request, Response } from '@nestjs/common';\nimport { ApiTags, ApiOperation, ApiBearerAuth, ApiQuery } from '@nestjs/swagger';\nimport { WormAuditService } from '../services/worm-audit.service';\nimport { JwtAuthGuard } from '../../../auth/guards';\nimport { AuditActionType } from '../interfaces/worm-audit.interface';\n\n@ApiTags('Audit Logs')\n@ApiBearerAuth()\n@Controller('v1/audit')\n@UseGuards(JwtAuthGuard)\nexport class AuditController {\n    constructor(private readonly auditService: WormAuditService) {}\n\n    @Get()\n    @ApiOperation({ summary: 'Get audit logs' })\n    @ApiQuery({ name: 'userId', required: false })\n    @ApiQuery({ name: 'action', required: false })\n    @ApiQuery({ name: 'entityType', required: false })\n    @ApiQuery({ name: 'entityId', required: false })\n    @ApiQuery({ name: 'startDate', required: false })\n    @ApiQuery({ name: 'endDate', required: false })\n    @ApiQuery({ name: 'page', required: false, example: 1 })\n    @ApiQuery({ name: 'limit', required: false, example: 100 })\n    async getLogs(\n        @Request() req: any,\n        @Query('userId') userId?: string,\n        @Query('action') action?: AuditActionType,\n        @Query('entityType') entityType?: string,\n        @Query('entityId') entityId?: string,\n        @Query('startDate') startDate?: string,\n        @Query('endDate') endDate?: string,\n        @Query('page') page?: number,\n        @Query('limit') limit?: number,\n    ) {\n        return this.auditService.getLogs(req.user.tenant_id, {\n            userId,\n            action,\n            entityType,\n            entityId,\n            startDate: startDate ? new Date(startDate) : undefined,\n            endDate: endDate ? new Date(endDate) : undefined,\n            page: page || 1,\n            limit: limit || 100,\n        });\n    }\n\n    @Get('verify')\n    @ApiOperation({ summary: 'Verify audit chain integrity' })\n    async verifyChain(@Request() req: any) {\n        return this.auditService.verifyChainIntegrity(req.user.tenant_id);\n    }\n\n    @Get('export')\n    @ApiOperation({ summary: 'Export audit logs (for compliance)' })\n    @ApiQuery({ name: 'format', required: false, enum: ['json', 'csv'] })\n    @ApiQuery({ name: 'startDate', required: false })\n    @ApiQuery({ name: 'endDate', required: false })\n    async exportLogs(\n        @Request() req: any,\n        @Response() res: any,\n        @Query('format') format: 'json' | 'csv' = 'json',\n        @Query('startDate') startDate?: string,\n        @Query('endDate') endDate?: string,\n    ) {\n        const data = await this.auditService.exportLogs(req.user.tenant_id, format, {\n            startDate: startDate ? new Date(startDate) : undefined,\n            endDate: endDate ? new Date(endDate) : undefined,\n        });\n\n        const filename = `audit-export-${new Date().toISOString().split('T')[0]}.${format}`;\n        const contentType = format === 'json' ? 'application/json' : 'text/csv';\n\n        res.setHeader('Content-Type', contentType);\n        res.setHeader('Content-Disposition', `attachment; filename=\"${filename}\"`);\n        res.send(data);\n    }\n\n    @Get('retention')\n    @ApiOperation({ summary: 'Get audit retention period' })\n    async getRetention(@Request() req: any) {\n        const days = await this.auditService.getRetentionPeriod(req.user.tenant_id);\n        return {\n            retentionDays: days,\n            retentionYears: (days / 365).toFixed(1),\n        };\n    }\n}\n"],"names":["AuditController","getLogs","req","userId","action","entityType","entityId","startDate","endDate","page","limit","auditService","user","tenant_id","Date","undefined","verifyChain","verifyChainIntegrity","exportLogs","res","format","data","filename","toISOString","split","contentType","setHeader","send","getRetention","days","getRetentionPeriod","retentionDays","retentionYears","toFixed","summary","name","required","example","enum"],"mappings":";;;;+BAUaA;;;eAAAA;;;wBAVqE;yBACnB;kCAC9B;wBACJ;oCACG;;;;;;;;;;;;;;;AAMzB,IAAA,AAAMA,kBAAN,MAAMA;IAGT,MAUMC,QACF,AAAWC,GAAQ,EACnB,AAAiBC,MAAe,EAChC,AAAiBC,MAAwB,EACzC,AAAqBC,UAAmB,EACxC,AAAmBC,QAAiB,EACpC,AAAoBC,SAAkB,EACtC,AAAkBC,OAAgB,EAClC,AAAeC,IAAa,EAC5B,AAAgBC,KAAc,EAChC;QACE,OAAO,IAAI,CAACC,YAAY,CAACV,OAAO,CAACC,IAAIU,IAAI,CAACC,SAAS,EAAE;YACjDV;YACAC;YACAC;YACAC;YACAC,WAAWA,YAAY,IAAIO,KAAKP,aAAaQ;YAC7CP,SAASA,UAAU,IAAIM,KAAKN,WAAWO;YACvCN,MAAMA,QAAQ;YACdC,OAAOA,SAAS;QACpB;IACJ;IAEA,MAEMM,YAAY,AAAWd,GAAQ,EAAE;QACnC,OAAO,IAAI,CAACS,YAAY,CAACM,oBAAoB,CAACf,IAAIU,IAAI,CAACC,SAAS;IACpE;IAEA,MAKMK,WACF,AAAWhB,GAAQ,EACnB,AAAYiB,GAAQ,EACpB,AAAiBC,SAAyB,MAAM,EAChD,AAAoBb,SAAkB,EACtC,AAAkBC,OAAgB,EACpC;QACE,MAAMa,OAAO,MAAM,IAAI,CAACV,YAAY,CAACO,UAAU,CAAChB,IAAIU,IAAI,CAACC,SAAS,EAAEO,QAAQ;YACxEb,WAAWA,YAAY,IAAIO,KAAKP,aAAaQ;YAC7CP,SAASA,UAAU,IAAIM,KAAKN,WAAWO;QAC3C;QAEA,MAAMO,WAAW,CAAC,aAAa,EAAE,IAAIR,OAAOS,WAAW,GAAGC,KAAK,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC,EAAEJ,QAAQ;QACnF,MAAMK,cAAcL,WAAW,SAAS,qBAAqB;QAE7DD,IAAIO,SAAS,CAAC,gBAAgBD;QAC9BN,IAAIO,SAAS,CAAC,uBAAuB,CAAC,sBAAsB,EAAEJ,SAAS,CAAC,CAAC;QACzEH,IAAIQ,IAAI,CAACN;IACb;IAEA,MAEMO,aAAa,AAAW1B,GAAQ,EAAE;QACpC,MAAM2B,OAAO,MAAM,IAAI,CAAClB,YAAY,CAACmB,kBAAkB,CAAC5B,IAAIU,IAAI,CAACC,SAAS;QAC1E,OAAO;YACHkB,eAAeF;YACfG,gBAAgB,AAACH,CAAAA,OAAO,GAAE,EAAGI,OAAO,CAAC;QACzC;IACJ;IA1EA,YAAY,AAAiBtB,YAA8B,CAAE;aAAhCA,eAAAA;IAAiC;AA2ElE;;;;QAxEoBuB,SAAS;;;QACbC,MAAM;QAAUC,UAAU;;;QAC1BD,MAAM;QAAUC,UAAU;;;QAC1BD,MAAM;QAAcC,UAAU;;;QAC9BD,MAAM;QAAYC,UAAU;;;QAC5BD,MAAM;QAAaC,UAAU;;;QAC7BD,MAAM;QAAWC,UAAU;;;QAC3BD,MAAM;QAAQC,UAAU;QAAOC,SAAS;;;QACxCF,MAAM;QAASC,UAAU;QAAOC,SAAS;;;;;;;;;;;;;;;;;;;;;;;;;;;;QAyBrCH,SAAS;;;;;;;;;;;;QAMTA,SAAS;;;QACbC,MAAM;QAAUC,UAAU;QAAOE,MAAM;YAAC;YAAQ;SAAM;;;QACtDH,MAAM;QAAaC,UAAU;;;QAC7BD,MAAM;QAAWC,UAAU;;;;;;;;;;;;;;;;;;;;QAsBvBF,SAAS"}
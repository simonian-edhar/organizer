{"version":3,"sources":["../../../../src/enterprise/cdn/services/cdn.service.ts"],"sourcesContent":["import { Injectable, Logger } from '@nestjs/common';\nimport { ConfigService } from '@nestjs/config';\nimport axios, { AxiosInstance } from 'axios';\nimport {\n    CdnConfig,\n    CdnPurgeOptions,\n    CdnCacheRule,\n    DEFAULT_CDN_CONFIG,\n    CDN_CACHE_RULES,\n    CDN_CACHE_TAGS,\n} from '../interfaces/cdn.interface';\n\n/**\n * CDN Service\n * Manages CDN configuration, cache rules, and purging\n */\n@Injectable()\nexport class CdnService {\n    private readonly logger = new Logger(CdnService.name);\n    private readonly config: CdnConfig;\n    private readonly httpClient: AxiosInstance;\n\n    constructor(private readonly configService: ConfigService) {\n        this.config = {\n            ...DEFAULT_CDN_CONFIG,\n            enabled: this.configService.get('CDN_ENABLED', true),\n            provider: this.configService.get('CDN_PROVIDER', 'cloudflare'),\n            domain: this.configService.get('CDN_DOMAIN', ''),\n            baseUrl: this.configService.get('CDN_BASE_URL', ''),\n        };\n\n        this.httpClient = axios.create({\n            timeout: 30000,\n        });\n    }\n\n    /**\n     * Check if CDN is enabled\n     */\n    isEnabled(): boolean {\n        return this.config.enabled && !!this.config.domain;\n    }\n\n    /**\n     * Get CDN URL for asset\n     */\n    getCdnUrl(path: string): string {\n        if (!this.isEnabled()) {\n            return path;\n        }\n\n        // Ensure path starts with /\n        const normalizedPath = path.startsWith('/') ? path : `/${path}`;\n\n        return `${this.config.baseUrl}${normalizedPath}`;\n    }\n\n    /**\n     * Purge CDN cache\n     */\n    async purge(options: CdnPurgeOptions): Promise<{ success: boolean; purged: number }> {\n        if (!this.isEnabled()) {\n            return { success: true, purged: 0 };\n        }\n\n        try {\n            switch (this.config.provider) {\n                case 'cloudflare':\n                    return await this.purgeCloudflare(options);\n                case 'aws_cloudfront':\n                    return await this.purgeCloudFront(options);\n                case 'fastly':\n                    return await this.purgeFastly(options);\n                default:\n                    return await this.purgeCustom(options);\n            }\n        } catch (error) {\n            this.logger.error('CDN purge failed:', error);\n            return { success: false, purged: 0 };\n        }\n    }\n\n    /**\n     * Purge Cloudflare cache\n     */\n    private async purgeCloudflare(options: CdnPurgeOptions): Promise<{ success: boolean; purged: number }> {\n        const zoneId = this.configService.get('CLOUDFLARE_ZONE_ID');\n        const apiToken = this.configService.get('CLOUDFLARE_API_TOKEN');\n\n        if (!zoneId || !apiToken) {\n            this.logger.warn('Cloudflare credentials not configured');\n            return { success: false, purged: 0 };\n        }\n\n        const purgeData: any = {};\n\n        if (options.all) {\n            purgeData.purge_everything = true;\n        } else if (options.tags && options.tags.length > 0) {\n            purgeData.tags = options.tags;\n        } else if (options.urls && options.urls.length > 0) {\n            purgeData.files = options.urls.map(url =>\n                url.startsWith('http') ? url : `${this.config.baseUrl}${url}`\n            );\n        }\n\n        const response = await this.httpClient.post(\n            `https://api.cloudflare.com/client/v4/zones/${zoneId}/purge_cache`,\n            purgeData,\n            {\n                headers: {\n                    'Authorization': `Bearer ${apiToken}`,\n                    'Content-Type': 'application/json',\n                },\n            }\n        );\n\n        const success = response.data.success;\n        const purged = success ? (options.urls?.length || options.tags?.length || 1) : 0;\n\n        this.logger.log(`Cloudflare purge: ${success ? 'success' : 'failed'}, purged: ${purged}`);\n\n        return { success, purged };\n    }\n\n    /**\n     * Purge CloudFront cache\n     */\n    private async purgeCloudFront(options: CdnPurgeOptions): Promise<{ success: boolean; purged: number }> {\n        // CloudFront uses AWS SDK - this is a placeholder\n        // In production, use @aws-sdk/client-cloudfront\n        this.logger.log('CloudFront purge requested (implement with AWS SDK)');\n\n        if (options.all) {\n            // Create invalidation for all paths\n            return { success: true, purged: 1 };\n        }\n\n        const paths = options.urls?.map(url => url.startsWith('/') ? url : `/${url}`) || ['/*'];\n\n        return { success: true, purged: paths.length };\n    }\n\n    /**\n     * Purge Fastly cache\n     */\n    private async purgeFastly(options: CdnPurgeOptions): Promise<{ success: boolean; purged: number }> {\n        const serviceId = this.configService.get('FASTLY_SERVICE_ID');\n        const apiKey = this.configService.get('FASTLY_API_KEY');\n\n        if (!serviceId || !apiKey) {\n            this.logger.warn('Fastly credentials not configured');\n            return { success: false, purged: 0 };\n        }\n\n        if (options.all) {\n            await this.httpClient.post(\n                `https://api.fastly.com/service/${serviceId}/purge_all`,\n                {},\n                {\n                    headers: {\n                        'Fastly-Key': apiKey,\n                        'Accept': 'application/json',\n                    },\n                }\n            );\n            return { success: true, purged: 1 };\n        }\n\n        if (options.tags && options.tags.length > 0) {\n            await this.httpClient.post(\n                `https://api.fastly.com/service/${serviceId}/purge`,\n                { surrogate_keys: options.tags },\n                {\n                    headers: {\n                        'Fastly-Key': apiKey,\n                        'Accept': 'application/json',\n                    },\n                }\n            );\n            return { success: true, purged: options.tags.length };\n        }\n\n        // Purge individual URLs\n        let purged = 0;\n        for (const url of options.urls || []) {\n            await this.httpClient.request({\n                method: 'PURGE',\n                url: url.startsWith('http') ? url : `${this.config.baseUrl}${url}`,\n            });\n            purged++;\n        }\n\n        return { success: true, purged };\n    }\n\n    /**\n     * Purge custom CDN cache\n     */\n    private async purgeCustom(options: CdnPurgeOptions): Promise<{ success: boolean; purged: number }> {\n        const purgeEndpoint = this.configService.get('CDN_PURGE_ENDPOINT');\n\n        if (!purgeEndpoint) {\n            this.logger.warn('Custom CDN purge endpoint not configured');\n            return { success: false, purged: 0 };\n        }\n\n        const response = await this.httpClient.post(purgeEndpoint, {\n            urls: options.urls,\n            tags: options.tags,\n            all: options.all,\n        });\n\n        return {\n            success: response.status === 200,\n            purged: response.data?.purged || options.urls?.length || 0,\n        };\n    }\n\n    /**\n     * Purge tenant cache\n     */\n    async purgeTenantCache(tenantId: string): Promise<{ success: boolean; purged: number }> {\n        const tags = [\n            CDN_CACHE_TAGS.TENANT(tenantId),\n            CDN_CACHE_TAGS.CLIENTS(tenantId),\n            CDN_CACHE_TAGS.CASES(tenantId),\n            CDN_CACHE_TAGS.DOCUMENTS(tenantId),\n        ];\n\n        return this.purge({ tags });\n    }\n\n    /**\n     * Purge static assets cache\n     */\n    async purgeStaticCache(): Promise<{ success: boolean; purged: number }> {\n        return this.purge({\n            urls: ['/static/*', '/assets/*'],\n        });\n    }\n\n    /**\n     * Get cache headers for response\n     */\n    getCacheHeaders(path: string, tenantId?: string): Record<string, string> {\n        const rule = this.findMatchingRule(path);\n        const headers: Record<string, string> = {};\n\n        if (rule) {\n            headers['Cache-Control'] = `public, max-age=${rule.ttl}`;\n\n            if (tenantId) {\n                headers['Surrogate-Key'] = `${CDN_CACHE_TAGS.TENANT(tenantId)}`;\n            }\n        } else {\n            // Default: short cache for API responses\n            headers['Cache-Control'] = `public, max-age=${this.config.apiCacheTtl}`;\n        }\n\n        // Add CDN-specific headers\n        if (this.config.provider === 'cloudflare') {\n            headers['CF-Cache-Status'] = 'HIT';\n        }\n\n        return headers;\n    }\n\n    /**\n     * Find matching cache rule for path\n     */\n    private findMatchingRule(path: string): CdnCacheRule | undefined {\n        return CDN_CACHE_RULES.find(rule => {\n            const pattern = rule.pathPattern.replace(/\\*/g, '.*');\n            const regex = new RegExp(`^${pattern}$`);\n            return regex.test(path);\n        });\n    }\n\n    /**\n     * Generate cache key for request\n     */\n    generateCacheKey(\n        path: string,\n        tenantId: string,\n        queryString?: Record<string, string>\n    ): string {\n        const rule = this.findMatchingRule(path);\n\n        let key = `${tenantId}:${path}`;\n\n        if (queryString && rule) {\n            const { queryStringBehavior, queryStringList } = rule;\n\n            switch (queryStringBehavior) {\n                case 'include-all':\n                    key += `:${JSON.stringify(queryString)}`;\n                    break;\n                case 'include-list':\n                    if (queryStringList?.length) {\n                        const filtered = queryStringList.reduce((acc, param) => {\n                            if (queryString[param] !== undefined) {\n                                acc[param] = queryString[param];\n                            }\n                            return acc;\n                        }, {} as Record<string, string>);\n                        key += `:${JSON.stringify(filtered)}`;\n                    }\n                    break;\n                // exclude-all and exclude-list: don't include query string\n            }\n        }\n\n        return key;\n    }\n\n    /**\n     * Get CDN configuration\n     */\n    getConfig(): CdnConfig {\n        return { ...this.config };\n    }\n\n    /**\n     * Prefetch URLs to warm cache\n     */\n    async warmCache(urls: string[]): Promise<{ success: boolean; warmed: number }> {\n        if (!this.isEnabled()) {\n            return { success: true, warmed: 0 };\n        }\n\n        let warmed = 0;\n\n        for (const url of urls) {\n            try {\n                await this.httpClient.get(\n                    url.startsWith('http') ? url : `${this.config.baseUrl}${url}`\n                );\n                warmed++;\n            } catch (error) {\n                this.logger.warn(`Cache warm failed for ${url}`);\n            }\n        }\n\n        return { success: true, warmed };\n    }\n}\n"],"names":["CdnService","isEnabled","config","enabled","domain","getCdnUrl","path","normalizedPath","startsWith","baseUrl","purge","options","success","purged","provider","purgeCloudflare","purgeCloudFront","purgeFastly","purgeCustom","error","logger","zoneId","configService","get","apiToken","warn","purgeData","all","purge_everything","tags","length","urls","files","map","url","response","httpClient","post","headers","data","log","paths","serviceId","apiKey","surrogate_keys","request","method","purgeEndpoint","status","purgeTenantCache","tenantId","CDN_CACHE_TAGS","TENANT","CLIENTS","CASES","DOCUMENTS","purgeStaticCache","getCacheHeaders","rule","findMatchingRule","ttl","apiCacheTtl","CDN_CACHE_RULES","find","pattern","pathPattern","replace","regex","RegExp","test","generateCacheKey","queryString","key","queryStringBehavior","queryStringList","JSON","stringify","filtered","reduce","acc","param","undefined","getConfig","warmCache","warmed","Logger","name","DEFAULT_CDN_CONFIG","axios","create","timeout"],"mappings":"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"}
{"version":3,"sources":["../../../../src/enterprise/cdn/interceptors/cdn-headers.interceptor.ts"],"sourcesContent":["import { Injectable, NestInterceptor, ExecutionContext, CallHandler } from '@nestjs/common';\nimport { Observable } from 'rxjs';\nimport { tap } from 'rxjs/operators';\nimport { CdnService } from '../services/cdn.service';\nimport { JwtPayload } from '../../../auth/interfaces/jwt.interface';\nimport { Request, Response } from 'express';\n\n/**\n * CDN Headers Interceptor\n * Adds appropriate cache headers to responses\n */\n@Injectable()\nexport class CdnHeadersInterceptor implements NestInterceptor {\n    constructor(private readonly cdnService: CdnService) {}\n\n    intercept(context: ExecutionContext, next: CallHandler): Observable<any> {\n        const request = context.switchToHttp().getRequest<Request>();\n        const response = context.switchToHttp().getResponse<Response>();\n        const user = request.user as JwtPayload;\n\n        return next.handle().pipe(\n            tap(() => {\n                if (!this.cdnService.isEnabled()) {\n                    return;\n                }\n\n                const path = request.route?.path || request.path;\n                const cacheHeaders = this.cdnService.getCacheHeaders(\n                    path,\n                    user?.tenant_id\n                );\n\n                // Set cache headers\n                for (const [key, value] of Object.entries(cacheHeaders)) {\n                    response.setHeader(key, value);\n                }\n\n                // Set surrogate keys for granular purging\n                if (user?.tenant_id) {\n                    const keys = this.getSurrogateKeys(path, user.tenant_id);\n                    if (keys.length > 0) {\n                        response.setHeader('Surrogate-Key', keys.join(' '));\n                    }\n                }\n\n                // Add ETag for conditional requests\n                response.setHeader('Vary', 'Accept-Encoding, Authorization');\n            })\n        );\n    }\n\n    /**\n     * Get surrogate keys for path\n     */\n    private getSurrogateKeys(path: string, tenantId: string): string[] {\n        const keys: string[] = [`tenant:${tenantId}`];\n\n        if (path.includes('/clients')) {\n            keys.push(`clients:${tenantId}`);\n        }\n        if (path.includes('/cases')) {\n            keys.push(`cases:${tenantId}`);\n        }\n        if (path.includes('/documents')) {\n            keys.push(`documents:${tenantId}`);\n        }\n        if (path.includes('/events')) {\n            keys.push(`events:${tenantId}`);\n        }\n\n        return keys;\n    }\n}\n"],"names":["CdnHeadersInterceptor","intercept","context","next","request","switchToHttp","getRequest","response","getResponse","user","handle","pipe","tap","cdnService","isEnabled","path","route","cacheHeaders","getCacheHeaders","tenant_id","key","value","Object","entries","setHeader","keys","getSurrogateKeys","length","join","tenantId","includes","push"],"mappings":";;;;+BAYaA;;;eAAAA;;;wBAZ8D;2BAEvD;4BACO;;;;;;;;;;AASpB,IAAA,AAAMA,wBAAN,MAAMA;IAGTC,UAAUC,OAAyB,EAAEC,IAAiB,EAAmB;QACrE,MAAMC,UAAUF,QAAQG,YAAY,GAAGC,UAAU;QACjD,MAAMC,WAAWL,QAAQG,YAAY,GAAGG,WAAW;QACnD,MAAMC,OAAOL,QAAQK,IAAI;QAEzB,OAAON,KAAKO,MAAM,GAAGC,IAAI,CACrBC,IAAAA,cAAG,EAAC;YACA,IAAI,CAAC,IAAI,CAACC,UAAU,CAACC,SAAS,IAAI;gBAC9B;YACJ;YAEA,MAAMC,OAAOX,QAAQY,KAAK,EAAED,QAAQX,QAAQW,IAAI;YAChD,MAAME,eAAe,IAAI,CAACJ,UAAU,CAACK,eAAe,CAChDH,MACAN,MAAMU;YAGV,oBAAoB;YACpB,KAAK,MAAM,CAACC,KAAKC,MAAM,IAAIC,OAAOC,OAAO,CAACN,cAAe;gBACrDV,SAASiB,SAAS,CAACJ,KAAKC;YAC5B;YAEA,0CAA0C;YAC1C,IAAIZ,MAAMU,WAAW;gBACjB,MAAMM,OAAO,IAAI,CAACC,gBAAgB,CAACX,MAAMN,KAAKU,SAAS;gBACvD,IAAIM,KAAKE,MAAM,GAAG,GAAG;oBACjBpB,SAASiB,SAAS,CAAC,iBAAiBC,KAAKG,IAAI,CAAC;gBAClD;YACJ;YAEA,oCAAoC;YACpCrB,SAASiB,SAAS,CAAC,QAAQ;QAC/B;IAER;IAEA;;KAEC,GACD,AAAQE,iBAAiBX,IAAY,EAAEc,QAAgB,EAAY;QAC/D,MAAMJ,OAAiB;YAAC,CAAC,OAAO,EAAEI,UAAU;SAAC;QAE7C,IAAId,KAAKe,QAAQ,CAAC,aAAa;YAC3BL,KAAKM,IAAI,CAAC,CAAC,QAAQ,EAAEF,UAAU;QACnC;QACA,IAAId,KAAKe,QAAQ,CAAC,WAAW;YACzBL,KAAKM,IAAI,CAAC,CAAC,MAAM,EAAEF,UAAU;QACjC;QACA,IAAId,KAAKe,QAAQ,CAAC,eAAe;YAC7BL,KAAKM,IAAI,CAAC,CAAC,UAAU,EAAEF,UAAU;QACrC;QACA,IAAId,KAAKe,QAAQ,CAAC,YAAY;YAC1BL,KAAKM,IAAI,CAAC,CAAC,OAAO,EAAEF,UAAU;QAClC;QAEA,OAAOJ;IACX;IA1DA,YAAY,AAAiBZ,UAAsB,CAAE;aAAxBA,aAAAA;IAAyB;AA2D1D"}
{"version":3,"sources":["../../../../src/enterprise/domains/middleware/domain-routing.middleware.ts"],"sourcesContent":["import { Injectable, NestMiddleware } from '@nestjs/common';\nimport { Request, Response, NextFunction } from '@nestjs/common';\nimport { CustomDomainService } from '../services/custom-domain.service';\nimport { Organization } from '../../../database/entities/Organization.entity';\n\n/**\n * Domain Routing Middleware\n * Routes requests based on custom domain\n */\n@Injectable()\nexport class DomainRoutingMiddleware {\n    constructor(private readonly customDomainService: CustomDomainService) {}\n\n    async use(req: Request, res: Response, next: NextFunction) {\n        const host = req.headers.host?.split(':')[0]; // Remove port\n\n        if (!host) {\n            return next();\n        }\n\n        // Check if it's a custom domain (not the base domain)\n        const baseDomain = process.env.BASE_DOMAIN || 'law-organizer.ua';\n\n        if (!host.endsWith(baseDomain)) {\n            // This might be a custom domain\n            const organization = await this.customDomainService.getTenantByDomain(host);\n\n            if (organization) {\n                // Attach tenant info to request\n                (req as any).tenantFromDomain = organization;\n                (req as any).isCustomDomain = true;\n            }\n        }\n\n        next();\n    }\n}\n"],"names":["DomainRoutingMiddleware","use","req","res","next","host","headers","split","baseDomain","process","env","BASE_DOMAIN","endsWith","organization","customDomainService","getTenantByDomain","tenantFromDomain","isCustomDomain"],"mappings":";;;;+BAUaA;;;eAAAA;;;wBAV8B;qCAEP;;;;;;;;;;AAQ7B,IAAA,AAAMA,0BAAN,MAAMA;IAGT,MAAMC,IAAIC,GAAY,EAAEC,GAAa,EAAEC,IAAkB,EAAE;QACvD,MAAMC,OAAOH,IAAII,OAAO,CAACD,IAAI,EAAEE,MAAM,IAAI,CAAC,EAAE,EAAE,cAAc;QAE5D,IAAI,CAACF,MAAM;YACP,OAAOD;QACX;QAEA,sDAAsD;QACtD,MAAMI,aAAaC,QAAQC,GAAG,CAACC,WAAW,IAAI;QAE9C,IAAI,CAACN,KAAKO,QAAQ,CAACJ,aAAa;YAC5B,gCAAgC;YAChC,MAAMK,eAAe,MAAM,IAAI,CAACC,mBAAmB,CAACC,iBAAiB,CAACV;YAEtE,IAAIQ,cAAc;gBACd,gCAAgC;gBAC/BX,IAAYc,gBAAgB,GAAGH;gBAC/BX,IAAYe,cAAc,GAAG;YAClC;QACJ;QAEAb;IACJ;IAxBA,YAAY,AAAiBU,mBAAwC,CAAE;aAA1CA,sBAAAA;IAA2C;AAyB5E"}
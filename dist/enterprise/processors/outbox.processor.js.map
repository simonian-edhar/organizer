{"version":3,"sources":["../../../src/enterprise/processors/outbox.processor.ts"],"sourcesContent":["import { Injectable, Logger } from '@nestjs/common';\nimport { Cron, CronExpression } from '@nestjs/schedule';\nimport { InjectRepository } from '@nestjs/typeorm';\nimport { Repository } from 'typeorm';\nimport { Outbox } from '../entities/Outbox.entity';\n\n/**\n * Outbox Processor\n * Processes pending events in the outbox table\n */\n@Injectable()\nexport class OutboxProcessor {\n    private readonly logger = new Logger(OutboxProcessor.name);\n    private readonly MAX_RETRIES = 3;\n    private readonly BATCH_SIZE = 100;\n\n    constructor(\n        @InjectRepository(Outbox)\n        private readonly outboxRepository: Repository<Outbox>,\n        private readonly eventPublisher: EventPublisher,\n    ) {}\n\n    /**\n     * Process outbox events every minute\n     */\n    @Cron(CronExpression.EVERY_MINUTE)\n    async processOutbox(): Promise<void> {\n        this.logger.debug('Processing outbox events');\n\n        try {\n            // Get pending events\n            const events = await this.outboxRepository.find({\n                where: { processed: false },\n                order: { createdAt: 'ASC' },\n                take: this.BATCH_SIZE,\n            });\n\n            if (events.length === 0) {\n                return;\n            }\n\n            this.logger.log(`Processing ${events.length} outbox events`);\n\n            // Process each event\n            for (const event of events) {\n                await this.processEvent(event);\n            }\n        } catch (error) {\n            this.logger.error('Failed to process outbox events:', error);\n        }\n    }\n\n    /**\n     * Process a single event\n     */\n    private async processEvent(event: Outbox): Promise<void> {\n        try {\n            // Publish event to event bus\n            switch (event.eventType) {\n                case 'UserCreatedEvent':\n                    await this.eventPublisher.publish(event.payload);\n                    break;\n                case 'UserUpdatedEvent':\n                    await this.eventPublisher.publish(event.payload);\n                    break;\n                case 'AuditLogEvent':\n                    await this.eventPublisher.publish(event.payload);\n                    break;\n                // Add more event types as needed\n                default:\n                    this.logger.warn(`Unknown event type: ${event.eventType}`);\n                    return;\n            }\n\n            // Mark as processed\n            await this.outboxRepository.update(\n                { id: event.id },\n                {\n                    processed: true,\n                    processedAt: new Date(),\n                    lastError: null,\n                }\n            );\n\n            this.logger.debug(`Event ${event.id} processed successfully`);\n        } catch (error) {\n            const newRetryCount = event.retryCount + 1;\n\n            // Update retry count\n            await this.outboxRepository.update(\n                { id: event.id },\n                {\n                    retryCount: newRetryCount,\n                    lastError: {\n                        message: error.message,\n                        stack: error.stack,\n                        timestamp: new Date(),\n                    },\n                }\n            );\n\n            this.logger.error(\n                `Failed to process event ${event.id} (attempt ${newRetryCount}):`,\n                error\n            );\n\n            // Move to dead letter queue if max retries reached\n            if (newRetryCount >= this.MAX_RETRIES) {\n                await this.moveToDeadLetterQueue(event);\n            }\n        }\n    }\n\n    /**\n     * Move failed event to dead letter queue\n     */\n    private async moveToDeadLetterQueue(event: Outbox): Promise<void> {\n        this.logger.warn(`Moving event ${event.id} to dead letter queue`);\n\n        // TODO: Implement dead letter queue\n        await this.outboxRepository.delete({ id: event.id });\n    }\n}\n"],"names":["OutboxProcessor","processOutbox","logger","debug","events","outboxRepository","find","where","processed","order","createdAt","take","BATCH_SIZE","length","log","event","processEvent","error","eventType","eventPublisher","publish","payload","warn","update","id","processedAt","Date","lastError","newRetryCount","retryCount","message","stack","timestamp","MAX_RETRIES","moveToDeadLetterQueue","delete","Logger","name","EVERY_MINUTE"],"mappings":"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"}
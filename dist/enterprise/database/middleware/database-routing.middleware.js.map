{"version":3,"sources":["../../../../src/enterprise/database/middleware/database-routing.middleware.ts"],"sourcesContent":["import { Injectable, NestMiddleware, UnauthorizedException } from '@nestjs/common';\nimport { Request, Response, NextFunction } from 'express';\nimport { TenantDatabaseService } from '../services/tenant-database.service';\nimport { JwtPayload } from '../../../auth/interfaces/jwt.interface';\n\n/**\n * Database Routing Middleware\n * Routes requests to appropriate tenant database\n */\n@Injectable()\nexport class DatabaseRoutingMiddleware implements NestMiddleware {\n    constructor(private readonly tenantDatabaseService: TenantDatabaseService) {}\n\n    async use(req: Request, res: Response, next: NextFunction) {\n        const user = req.user as JwtPayload;\n\n        if (!user?.tenant_id) {\n            return next();\n        }\n\n        try {\n            // Get appropriate database connection for tenant\n            const dataSource = await this.tenantDatabaseService.getConnection(user.tenant_id);\n\n            // Attach connection to request for use in services\n            (req as any).tenantDataSource = dataSource;\n\n            next();\n        } catch (error) {\n            throw new UnauthorizedException('Unable to connect to tenant database');\n        }\n    }\n}\n"],"names":["DatabaseRoutingMiddleware","use","req","res","next","user","tenant_id","dataSource","tenantDatabaseService","getConnection","tenantDataSource","error","UnauthorizedException"],"mappings":";;;;+BAUaA;;;eAAAA;;;wBAVqD;uCAE5B;;;;;;;;;;AAQ/B,IAAA,AAAMA,4BAAN,MAAMA;IAGT,MAAMC,IAAIC,GAAY,EAAEC,GAAa,EAAEC,IAAkB,EAAE;QACvD,MAAMC,OAAOH,IAAIG,IAAI;QAErB,IAAI,CAACA,MAAMC,WAAW;YAClB,OAAOF;QACX;QAEA,IAAI;YACA,iDAAiD;YACjD,MAAMG,aAAa,MAAM,IAAI,CAACC,qBAAqB,CAACC,aAAa,CAACJ,KAAKC,SAAS;YAEhF,mDAAmD;YAClDJ,IAAYQ,gBAAgB,GAAGH;YAEhCH;QACJ,EAAE,OAAOO,OAAO;YACZ,MAAM,IAAIC,6BAAqB,CAAC;QACpC;IACJ;IApBA,YAAY,AAAiBJ,qBAA4C,CAAE;aAA9CA,wBAAAA;IAA+C;AAqBhF"}
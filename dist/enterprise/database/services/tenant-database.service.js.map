{"version":3,"sources":["../../../../src/enterprise/database/services/tenant-database.service.ts"],"sourcesContent":["import { Injectable, Logger, OnModuleInit, OnModuleDestroy } from '@nestjs/common';\nimport { ConfigService } from '@nestjs/config';\nimport { DataSource, DataSourceOptions } from 'typeorm';\nimport { InjectRepository } from '@nestjs/typeorm';\nimport { Repository } from 'typeorm';\nimport { Organization } from '../../../database/entities/Organization.entity';\nimport { SubscriptionPlan } from '../../../database/entities/enums/subscription.enum';\nimport {\n    TenantDatabaseConfig,\n    DatabasePoolOptions,\n    DEFAULT_POOL_OPTIONS,\n    ENTERPRISE_POOL_OPTIONS,\n} from '../interfaces/tenant-database.interface';\n\n/**\n * Tenant Database Service\n * Manages dedicated database connections per tenant for Enterprise plans\n */\n@Injectable()\nexport class TenantDatabaseService implements OnModuleInit, OnModuleDestroy {\n    private readonly logger = new Logger(TenantDatabaseService.name);\n    private readonly tenantConnections: Map<string, DataSource> = new Map();\n    private readonly sharedDataSource: DataSource;\n\n    constructor(\n        private readonly configService: ConfigService,\n        @InjectRepository(Organization)\n        private readonly organizationRepository: Repository<Organization>,\n    ) {\n        // Shared database for non-enterprise tenants\n        this.sharedDataSource = this.createSharedDataSource();\n    }\n\n    async onModuleInit() {\n        await this.initializeTenantDatabases();\n    }\n\n    async onModuleDestroy() {\n        await this.closeAllConnections();\n    }\n\n    /**\n     * Get database connection for tenant\n     * Returns dedicated connection for Enterprise, shared for others\n     */\n    async getConnection(tenantId: string): Promise<DataSource> {\n        // Check if tenant has dedicated database\n        const hasDedicatedDb = await this.hasDedicatedDatabase(tenantId);\n\n        if (hasDedicatedDb) {\n            return this.getOrCreateDedicatedConnection(tenantId);\n        }\n\n        return this.sharedDataSource;\n    }\n\n    /**\n     * Check if tenant should use dedicated database\n     */\n    private async hasDedicatedDatabase(tenantId: string): Promise<boolean> {\n        const organization = await this.organizationRepository.findOne({\n            where: { id: tenantId },\n            select: ['subscriptionPlan', 'settings'],\n        });\n\n        if (!organization) {\n            return false;\n        }\n\n        // Enterprise plan with dedicated database setting\n        return (\n            organization.subscriptionPlan === SubscriptionPlan.ENTERPRISE &&\n            organization.settings?.dedicatedDatabase === true\n        );\n    }\n\n    /**\n     * Get or create dedicated connection for tenant\n     */\n    private async getOrCreateDedicatedConnection(tenantId: string): Promise<DataSource> {\n        let connection = this.tenantConnections.get(tenantId);\n\n        if (!connection || !connection.isInitialized) {\n            connection = await this.createDedicatedConnection(tenantId);\n            this.tenantConnections.set(tenantId, connection);\n        }\n\n        return connection;\n    }\n\n    /**\n     * Create dedicated database connection for tenant\n     */\n    private async createDedicatedConnection(tenantId: string): Promise<DataSource> {\n        const config = await this.getTenantDatabaseConfig(tenantId);\n        const poolOptions = this.getPoolOptions(config.tenantId);\n\n        const options: DataSourceOptions = {\n            type: 'postgres',\n            host: config.host,\n            port: config.port,\n            username: config.username,\n            password: config.password,\n            database: config.database,\n            ssl: config.ssl ? { rejectUnauthorized: false } : false,\n            entities: [__dirname + '/../../**/*.entity{.ts,.js}'],\n            synchronize: false,\n            logging: this.configService.get('NODE_ENV') === 'development',\n            poolSize: poolOptions.max,\n            extra: {\n                min: poolOptions.min,\n                idleTimeoutMillis: poolOptions.idleTimeoutMillis,\n                connectionTimeoutMillis: poolOptions.connectionTimeoutMillis,\n            },\n        };\n\n        const dataSource = new DataSource(options);\n        await dataSource.initialize();\n\n        this.logger.log(`Dedicated database connection established for tenant: ${tenantId}`);\n\n        return dataSource;\n    }\n\n    /**\n     * Get tenant database configuration\n     */\n    private async getTenantDatabaseConfig(tenantId: string): Promise<TenantDatabaseConfig> {\n        const organization = await this.organizationRepository.findOne({\n            where: { id: tenantId },\n        });\n\n        // Check for custom database settings in organization metadata\n        const dbConfig = organization?.metadata?.databaseConfig || {};\n\n        return {\n            tenantId,\n            host: dbConfig.host || this.configService.get('DB_HOST', 'localhost'),\n            port: dbConfig.port || this.configService.get('DB_PORT', 5432),\n            username: dbConfig.username || `tenant_${tenantId.substring(0, 8)}`,\n            password: dbConfig.password || this.configService.get('DB_PASSWORD'),\n            database: dbConfig.database || `law_organizer_${tenantId.substring(0, 8)}`,\n            ssl: dbConfig.ssl ?? this.configService.get('DB_SSL', true),\n            poolSize: dbConfig.poolSize,\n        };\n    }\n\n    /**\n     * Get pool options based on tenant plan\n     */\n    private getPoolOptions(tenantId: string): DatabasePoolOptions {\n        // For enterprise tenants, return larger pool\n        return ENTERPRISE_POOL_OPTIONS;\n    }\n\n    /**\n     * Create shared data source for non-enterprise tenants (postgres only; when DB is sqlite, main connection is used)\n     */\n    private createSharedDataSource(): DataSource {\n        const dbType = this.configService.get<string>('DB_TYPE', 'sqlite');\n        if (dbType === 'sqlite') {\n            return new DataSource({\n                type: 'better-sqlite3',\n                database: this.configService.get('DB_NAME', 'law_organizer.db'),\n                entities: [__dirname + '/../../**/*.entity{.ts,.js}'],\n                synchronize: false,\n                logging: this.configService.get('NODE_ENV') === 'development',\n            });\n        }\n        return new DataSource({\n            type: 'postgres',\n            host: this.configService.get('DATABASE_HOST') || this.configService.get('DB_HOST', 'localhost'),\n            port: this.configService.get('DATABASE_PORT') ?? this.configService.get('DB_PORT', 5432),\n            username: this.configService.get('DATABASE_USER') || this.configService.get('DB_USER'),\n            password: this.configService.get('DATABASE_PASSWORD') ?? this.configService.get('DB_PASSWORD'),\n            database: this.configService.get('DATABASE_NAME') || this.configService.get('DB_NAME', 'law_organizer'),\n            entities: [__dirname + '/../../**/*.entity{.ts,.js}'],\n            synchronize: false,\n            logging: this.configService.get('NODE_ENV') === 'development',\n            poolSize: DEFAULT_POOL_OPTIONS.max,\n            extra: {\n                min: DEFAULT_POOL_OPTIONS.min,\n                idleTimeoutMillis: DEFAULT_POOL_OPTIONS.idleTimeoutMillis,\n                connectionTimeoutMillis: DEFAULT_POOL_OPTIONS.connectionTimeoutMillis,\n            },\n        });\n    }\n\n    /**\n     * Initialize all tenant databases on startup\n     */\n    private async initializeTenantDatabases(): Promise<void> {\n        const enterprises = await this.organizationRepository.find({\n            where: {\n                subscriptionPlan: SubscriptionPlan.ENTERPRISE,\n                status: 'active',\n            },\n        });\n\n        for (const org of enterprises) {\n            if (org.settings?.dedicatedDatabase) {\n                try {\n                    await this.getOrCreateDedicatedConnection(org.id);\n                    this.logger.log(`Initialized dedicated DB for tenant: ${org.id}`);\n                } catch (error) {\n                    this.logger.error(`Failed to initialize dedicated DB for tenant ${org.id}:`, error);\n                }\n            }\n        }\n    }\n\n    /**\n     * Close all tenant connections\n     */\n    private async closeAllConnections(): Promise<void> {\n        for (const [tenantId, connection] of this.tenantConnections) {\n            try {\n                if (connection.isInitialized) {\n                    await connection.destroy();\n                    this.logger.log(`Closed connection for tenant: ${tenantId}`);\n                }\n            } catch (error) {\n                this.logger.error(`Failed to close connection for tenant ${tenantId}:`, error);\n            }\n        }\n\n        if (this.sharedDataSource.isInitialized) {\n            await this.sharedDataSource.destroy();\n        }\n    }\n\n    /**\n     * Provision new dedicated database for tenant\n     */\n    async provisionDedicatedDatabase(tenantId: string): Promise<TenantDatabaseConfig> {\n        const dbSuffix = tenantId.substring(0, 8);\n        const dbName = `law_organizer_${dbSuffix}`;\n        const dbUser = `tenant_${dbSuffix}`;\n        const dbPassword = this.generateSecurePassword();\n\n        // Get admin connection to create database\n        const adminConnection = await this.getAdminConnection();\n\n        try {\n            // Create database\n            await adminConnection.query(`CREATE DATABASE \"${dbName}\"`);\n\n            // Create user\n            await adminConnection.query(`CREATE USER \"${dbUser}\" WITH PASSWORD '${dbPassword}'`);\n\n            // Grant privileges\n            await adminConnection.query(`GRANT ALL PRIVILEGES ON DATABASE \"${dbName}\" TO \"${dbUser}\"`);\n\n            // Switch to new database and grant schema privileges\n            const tenantDb = new DataSource({\n                type: 'postgres',\n                host: this.configService.get('DB_HOST', 'localhost'),\n                port: this.configService.get('DB_PORT', 5432),\n                username: this.configService.get('DB_USER'),\n                password: this.configService.get('DB_PASSWORD'),\n                database: dbName,\n            });\n\n            await tenantDb.initialize();\n            await tenantDb.query(`GRANT ALL ON SCHEMA public TO \"${dbUser}\"`);\n            await tenantDb.destroy();\n\n            // Update organization metadata\n            await this.organizationRepository.update(\n                { id: tenantId },\n                {\n                    settings: {\n                        dedicatedDatabase: true,\n                    },\n                    metadata: {\n                        databaseConfig: {\n                            database: dbName,\n                            username: dbUser,\n                            host: this.configService.get('DB_HOST', 'localhost'),\n                            port: this.configService.get('DB_PORT', 5432),\n                        },\n                    },\n                }\n            );\n\n            this.logger.log(`Provisioned dedicated database for tenant: ${tenantId}`);\n\n            return {\n                tenantId,\n                host: this.configService.get('DB_HOST', 'localhost'),\n                port: this.configService.get('DB_PORT', 5432),\n                username: dbUser,\n                password: dbPassword,\n                database: dbName,\n                ssl: true,\n            };\n        } catch (error) {\n            this.logger.error(`Failed to provision database for tenant ${tenantId}:`, error);\n            throw error;\n        } finally {\n            await adminConnection.destroy();\n        }\n    }\n\n    /**\n     * Get admin connection for database management\n     */\n    private async getAdminConnection(): Promise<DataSource> {\n        const adminDs = new DataSource({\n            type: 'postgres',\n            host: this.configService.get('DB_HOST', 'localhost'),\n            port: this.configService.get('DB_PORT', 5432),\n            username: this.configService.get('DB_ADMIN_USER', this.configService.get('DB_USER')),\n            password: this.configService.get('DB_ADMIN_PASSWORD', this.configService.get('DB_PASSWORD')),\n            database: 'postgres',\n        });\n\n        await adminDs.initialize();\n        return adminDs;\n    }\n\n    /**\n     * Generate secure password for database user\n     */\n    private generateSecurePassword(): string {\n        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';\n        let password = '';\n        for (let i = 0; i < 32; i++) {\n            password += chars.charAt(Math.floor(Math.random() * chars.length));\n        }\n        return password;\n    }\n\n    /**\n     * Get connection statistics\n     */\n    getConnectionStats(): { tenantId: string; isInitialized: boolean }[] {\n        const stats = [];\n\n        for (const [tenantId, connection] of this.tenantConnections) {\n            stats.push({\n                tenantId,\n                isInitialized: connection.isInitialized,\n            });\n        }\n\n        return stats;\n    }\n}\n"],"names":["TenantDatabaseService","onModuleInit","initializeTenantDatabases","onModuleDestroy","closeAllConnections","getConnection","tenantId","hasDedicatedDb","hasDedicatedDatabase","getOrCreateDedicatedConnection","sharedDataSource","organization","organizationRepository","findOne","where","id","select","subscriptionPlan","SubscriptionPlan","ENTERPRISE","settings","dedicatedDatabase","connection","tenantConnections","get","isInitialized","createDedicatedConnection","set","config","getTenantDatabaseConfig","poolOptions","getPoolOptions","options","type","host","port","username","password","database","ssl","rejectUnauthorized","entities","__dirname","synchronize","logging","configService","poolSize","max","extra","min","idleTimeoutMillis","connectionTimeoutMillis","dataSource","DataSource","initialize","logger","log","dbConfig","metadata","databaseConfig","substring","ENTERPRISE_POOL_OPTIONS","createSharedDataSource","dbType","DEFAULT_POOL_OPTIONS","enterprises","find","status","org","error","destroy","provisionDedicatedDatabase","dbSuffix","dbName","dbUser","dbPassword","generateSecurePassword","adminConnection","getAdminConnection","query","tenantDb","update","adminDs","chars","i","charAt","Math","floor","random","length","getConnectionStats","stats","push","Logger","name","Map"],"mappings":"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"}
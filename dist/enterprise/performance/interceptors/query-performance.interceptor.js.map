{"version":3,"sources":["../../../../src/enterprise/performance/interceptors/query-performance.interceptor.ts"],"sourcesContent":["import { Injectable, NestInterceptor, ExecutionContext, CallHandler } from '@nestjs/common';\nimport { Observable } from 'rxjs';\nimport { tap } from 'rxjs/operators';\nimport { QueryOptimizationService } from '../services/query-optimization.service';\nimport { JwtPayload } from '../../../auth/interfaces/jwt.interface';\nimport { Request } from 'express';\n\n/**\n * Query Performance Interceptor\n * Monitors and logs slow database queries\n */\n@Injectable()\nexport class QueryPerformanceInterceptor implements NestInterceptor {\n    private readonly slowQueryThreshold: number;\n\n    constructor(private readonly queryOptimizationService: QueryOptimizationService) {\n        this.slowQueryThreshold = parseInt(process.env.SLOW_QUERY_THRESHOLD || '1000', 10);\n    }\n\n    intercept(context: ExecutionContext, next: CallHandler): Observable<any> {\n        const request = context.switchToHttp().getRequest<Request>();\n        const user = request.user as JwtPayload;\n        const startTime = Date.now();\n\n        return next.handle().pipe(\n            tap({\n                complete: () => {\n                    const duration = Date.now() - startTime;\n\n                    if (duration > this.slowQueryThreshold) {\n                        this.logSlowRequest(request, duration, user);\n                    }\n                },\n            })\n        );\n    }\n\n    /**\n     * Log slow request for analysis\n     */\n    private logSlowRequest(request: Request, duration: number, user?: JwtPayload): void {\n        const requestInfo = {\n            method: request.method,\n            path: request.route?.path || request.path,\n            query: request.query,\n            params: request.params,\n            userAgent: request.headers['user-agent'],\n        };\n\n        console.warn({\n            type: 'slow_request',\n            duration,\n            tenantId: user?.tenant_id,\n            userId: user?.user_id,\n            request: requestInfo,\n            timestamp: new Date().toISOString(),\n        });\n    }\n}\n"],"names":["QueryPerformanceInterceptor","intercept","context","next","request","switchToHttp","getRequest","user","startTime","Date","now","handle","pipe","tap","complete","duration","slowQueryThreshold","logSlowRequest","requestInfo","method","path","route","query","params","userAgent","headers","console","warn","type","tenantId","tenant_id","userId","user_id","timestamp","toISOString","queryOptimizationService","parseInt","process","env","SLOW_QUERY_THRESHOLD"],"mappings":";;;;+BAYaA;;;eAAAA;;;wBAZ8D;2BAEvD;0CACqB;;;;;;;;;;AASlC,IAAA,AAAMA,8BAAN,MAAMA;IAOTC,UAAUC,OAAyB,EAAEC,IAAiB,EAAmB;QACrE,MAAMC,UAAUF,QAAQG,YAAY,GAAGC,UAAU;QACjD,MAAMC,OAAOH,QAAQG,IAAI;QACzB,MAAMC,YAAYC,KAAKC,GAAG;QAE1B,OAAOP,KAAKQ,MAAM,GAAGC,IAAI,CACrBC,IAAAA,cAAG,EAAC;YACAC,UAAU;gBACN,MAAMC,WAAWN,KAAKC,GAAG,KAAKF;gBAE9B,IAAIO,WAAW,IAAI,CAACC,kBAAkB,EAAE;oBACpC,IAAI,CAACC,cAAc,CAACb,SAASW,UAAUR;gBAC3C;YACJ;QACJ;IAER;IAEA;;KAEC,GACD,AAAQU,eAAeb,OAAgB,EAAEW,QAAgB,EAAER,IAAiB,EAAQ;QAChF,MAAMW,cAAc;YAChBC,QAAQf,QAAQe,MAAM;YACtBC,MAAMhB,QAAQiB,KAAK,EAAED,QAAQhB,QAAQgB,IAAI;YACzCE,OAAOlB,QAAQkB,KAAK;YACpBC,QAAQnB,QAAQmB,MAAM;YACtBC,WAAWpB,QAAQqB,OAAO,CAAC,aAAa;QAC5C;QAEAC,QAAQC,IAAI,CAAC;YACTC,MAAM;YACNb;YACAc,UAAUtB,MAAMuB;YAChBC,QAAQxB,MAAMyB;YACd5B,SAASc;YACTe,WAAW,IAAIxB,OAAOyB,WAAW;QACrC;IACJ;IA1CA,YAAY,AAAiBC,wBAAkD,CAAE;aAApDA,2BAAAA;QACzB,IAAI,CAACnB,kBAAkB,GAAGoB,SAASC,QAAQC,GAAG,CAACC,oBAAoB,IAAI,QAAQ;IACnF;AAyCJ"}
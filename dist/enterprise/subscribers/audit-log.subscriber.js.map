{"version":3,"sources":["../../../src/enterprise/subscribers/audit-log.subscriber.ts"],"sourcesContent":["import { Injectable } from '@nestjs/common';\nimport { EventBus, EventSubscriber, IEventSubscriber } from '@nestjs/cqrs';\nimport { InjectRepository } from '@nestjs/typeorm';\nimport { Repository } from 'typeorm';\nimport { AuditLog } from '../../database/entities/AuditLog.entity';\nimport { AuditLogEvent } from '../events/user.events';\n\n/**\n * Audit Log Event Subscriber\n * Processes audit log events asynchronously\n */\n@EventSubscriber(AuditLogEvent)\nexport class AuditLogSubscriber implements IEventSubscriber<AuditLogEvent> {\n    constructor(\n        private readonly eventBus: EventBus,\n        @InjectRepository(AuditLog)\n        private readonly auditLogRepository: Repository<AuditLog>,\n    ) {\n        this.eventBus.subscribe(AuditLogEvent, this.handleAuditLogEvent.bind(this));\n    }\n\n    async handleAuditLogEvent(event: AuditLogEvent): Promise<void> {\n        try {\n            const auditLog = this.auditLogRepository.create({\n                tenantId: event.tenantId,\n                userId: event.userId,\n                action: event.action as any,\n                entityType: event.entityType,\n                entityId: event.entityId,\n                newValues: event.newValues,\n                oldValues: event.oldValues,\n                changedFields: event.changedFields,\n                createdAt: event.timestamp,\n            });\n\n            await this.auditLogRepository.save(auditLog);\n\n            // Stream to SIEM (Enterprise feature)\n            if (this.isEnterpriseEnabled()) {\n                await this.streamToSIEM(auditLog);\n            }\n\n            // Send to WebSocket for real-time updates\n            if (this.isRealTimeEnabled()) {\n                await this.sendToWebSocket(event.tenantId, auditLog);\n            }\n        } catch (error) {\n            console.error('Failed to process audit log event:', error);\n            // TODO: Add to dead letter queue\n        }\n    }\n\n    private isEnterpriseEnabled(): boolean {\n        return process.env.ENTERPRISE_MODE === 'true';\n    }\n\n    private isRealTimeEnabled(): boolean {\n        return process.env.ENABLE_REAL_TIME_AUDIT === 'true';\n    }\n\n    private async streamToSIEM(auditLog: AuditLog): Promise<void> {\n        // TODO: Implement SIEM streaming (Elasticsearch, Splunk, etc.)\n    }\n\n    private async sendToWebSocket(tenantId: string, auditLog: AuditLog): Promise<void> {\n        // TODO: Implement WebSocket notification\n    }\n}\n"],"names":["AuditLogSubscriber","handleAuditLogEvent","event","auditLog","auditLogRepository","create","tenantId","userId","action","entityType","entityId","newValues","oldValues","changedFields","createdAt","timestamp","save","isEnterpriseEnabled","streamToSIEM","isRealTimeEnabled","sendToWebSocket","error","console","process","env","ENTERPRISE_MODE","ENABLE_REAL_TIME_AUDIT","eventBus","subscribe","AuditLogEvent","bind"],"mappings":";;;;+BAYaA;;;eAAAA;;;sBAX+C;yBAC3B;0BACN;gCACF;4BACK;;;;;;;;;;;;;;;AAOvB,IAAA,AAAMA,qBAAN,MAAMA;IAST,MAAMC,oBAAoBC,KAAoB,EAAiB;QAC3D,IAAI;YACA,MAAMC,WAAW,IAAI,CAACC,kBAAkB,CAACC,MAAM,CAAC;gBAC5CC,UAAUJ,MAAMI,QAAQ;gBACxBC,QAAQL,MAAMK,MAAM;gBACpBC,QAAQN,MAAMM,MAAM;gBACpBC,YAAYP,MAAMO,UAAU;gBAC5BC,UAAUR,MAAMQ,QAAQ;gBACxBC,WAAWT,MAAMS,SAAS;gBAC1BC,WAAWV,MAAMU,SAAS;gBAC1BC,eAAeX,MAAMW,aAAa;gBAClCC,WAAWZ,MAAMa,SAAS;YAC9B;YAEA,MAAM,IAAI,CAACX,kBAAkB,CAACY,IAAI,CAACb;YAEnC,sCAAsC;YACtC,IAAI,IAAI,CAACc,mBAAmB,IAAI;gBAC5B,MAAM,IAAI,CAACC,YAAY,CAACf;YAC5B;YAEA,0CAA0C;YAC1C,IAAI,IAAI,CAACgB,iBAAiB,IAAI;gBAC1B,MAAM,IAAI,CAACC,eAAe,CAAClB,MAAMI,QAAQ,EAAEH;YAC/C;QACJ,EAAE,OAAOkB,OAAO;YACZC,QAAQD,KAAK,CAAC,sCAAsCA;QACpD,iCAAiC;QACrC;IACJ;IAEQJ,sBAA+B;QACnC,OAAOM,QAAQC,GAAG,CAACC,eAAe,KAAK;IAC3C;IAEQN,oBAA6B;QACjC,OAAOI,QAAQC,GAAG,CAACE,sBAAsB,KAAK;IAClD;IAEA,MAAcR,aAAaf,QAAkB,EAAiB;IAC1D,+DAA+D;IACnE;IAEA,MAAciB,gBAAgBd,QAAgB,EAAEH,QAAkB,EAAiB;IAC/E,yCAAyC;IAC7C;IArDA,YACI,AAAiBwB,QAAkB,EACnC,AACiBvB,kBAAwC,CAC3D;aAHmBuB,WAAAA;aAEAvB,qBAAAA;QAEjB,IAAI,CAACuB,QAAQ,CAACC,SAAS,CAACC,yBAAa,EAAE,IAAI,CAAC5B,mBAAmB,CAAC6B,IAAI,CAAC,IAAI;IAC7E;AAgDJ"}
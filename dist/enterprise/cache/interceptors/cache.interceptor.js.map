{"version":3,"sources":["../../../../src/enterprise/cache/interceptors/cache.interceptor.ts"],"sourcesContent":["import { Injectable, NestInterceptor, ExecutionContext, CallHandler } from '@nestjs/common';\nimport { Observable, of } from 'rxjs';\nimport { tap } from 'rxjs/operators';\nimport { RedisCacheService } from '../services/redis-cache.service';\nimport { JwtPayload } from '../../../auth/interfaces/jwt.interface';\nimport { Request } from 'express';\n\n/**\n * Cache Interceptor\n * Automatically caches GET responses\n */\n@Injectable()\nexport class CacheInterceptor implements NestInterceptor {\n    constructor(private readonly cacheService: RedisCacheService) {}\n\n    intercept(context: ExecutionContext, next: CallHandler): Observable<any> {\n        const request = context.switchToHttp().getRequest<Request>();\n        const user = request.user as JwtPayload;\n\n        // Only cache GET requests\n        if (request.method !== 'GET') {\n            return next.handle();\n        }\n\n        // Skip caching for non-authenticated requests\n        if (!user?.tenant_id) {\n            return next.handle();\n        }\n\n        // Build cache key\n        const cacheKey = this.buildCacheKey(request, user.tenant_id);\n\n        // Check for cache bypass header\n        if (request.headers['cache-control'] === 'no-cache') {\n            return next.handle().pipe(\n                tap((response) => {\n                    this.cacheService.set(cacheKey, response, this.getTTL(request));\n                })\n            );\n        }\n\n        // Try to get from cache first\n        return new Observable((subscriber) => {\n            this.cacheService.get(cacheKey).then((cached) => {\n                if (cached !== null) {\n                    subscriber.next(cached);\n                    subscriber.complete();\n                } else {\n                    // Cache miss, execute handler and cache result\n                    next.handle().pipe(\n                        tap((response) => {\n                            this.cacheService.set(\n                                cacheKey,\n                                response,\n                                this.getTTL(request),\n                                this.getTags(request, user.tenant_id)\n                            );\n                        })\n                    ).subscribe(subscriber);\n                }\n            });\n        });\n    }\n\n    /**\n     * Build cache key from request\n     */\n    private buildCacheKey(request: Request, tenantId: string): string {\n        const path = request.route?.path || request.path;\n        const query = Object.keys(request.query).length > 0\n            ? JSON.stringify(request.query)\n            : '';\n        const params = Object.keys(request.params).length > 0\n            ? JSON.stringify(request.params)\n            : '';\n\n        return `api:${tenantId}:${path}:${params}:${query}`;\n    }\n\n    /**\n     * Get TTL based on endpoint\n     */\n    private getTTL(request: Request): number {\n        const path = request.route?.path || request.path;\n\n        // Dashboard stats - short TTL\n        if (path.includes('/dashboard')) {\n            return 60; // 1 minute\n        }\n\n        // List endpoints - medium TTL\n        if (path.includes('/list') || request.query.page) {\n            return 300; // 5 minutes\n        }\n\n        // Default TTL\n        return 3600; // 1 hour\n    }\n\n    /**\n     * Get cache tags for invalidation\n     */\n    private getTags(request: Request, tenantId: string): string[] {\n        const path = request.route?.path || request.path;\n        const tags: string[] = [];\n\n        // Add entity-based tags\n        if (path.includes('/clients')) {\n            tags.push(`clients:${tenantId}`);\n        }\n        if (path.includes('/cases')) {\n            tags.push(`cases:${tenantId}`);\n        }\n        if (path.includes('/documents')) {\n            tags.push(`documents:${tenantId}`);\n        }\n        if (path.includes('/events')) {\n            tags.push(`events:${tenantId}`);\n        }\n\n        return tags;\n    }\n}\n"],"names":["CacheInterceptor","intercept","context","next","request","switchToHttp","getRequest","user","method","handle","tenant_id","cacheKey","buildCacheKey","headers","pipe","tap","response","cacheService","set","getTTL","Observable","subscriber","get","then","cached","complete","getTags","subscribe","tenantId","path","route","query","Object","keys","length","JSON","stringify","params","includes","page","tags","push"],"mappings":"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"}
{"version":3,"sources":["../../../../src/enterprise/cache/interceptors/cache-invalidation.interceptor.ts"],"sourcesContent":["import { Injectable, NestInterceptor, ExecutionContext, CallHandler } from '@nestjs/common';\nimport { Observable } from 'rxjs';\nimport { tap } from 'rxjs/operators';\nimport { RedisCacheService } from '../services/redis-cache.service';\nimport { JwtPayload } from '../../../auth/interfaces/jwt.interface';\nimport { Request } from 'express';\n\n/**\n * Cache Invalidation Interceptor\n * Automatically invalidates cache on data mutations\n */\n@Injectable()\nexport class CacheInvalidationInterceptor implements NestInterceptor {\n    constructor(private readonly cacheService: RedisCacheService) {}\n\n    intercept(context: ExecutionContext, next: CallHandler): Observable<any> {\n        const request = context.switchToHttp().getRequest<Request>();\n        const user = request.user as JwtPayload;\n\n        return next.handle().pipe(\n            tap(async () => {\n                if (!user?.tenant_id) return;\n\n                // Invalidate based on method and path\n                await this.invalidateCache(request, user.tenant_id);\n            })\n        );\n    }\n\n    /**\n     * Invalidate relevant cache entries\n     */\n    private async invalidateCache(request: Request, tenantId: string): Promise<void> {\n        const method = request.method;\n        const path = request.route?.path || request.path;\n\n        // Only invalidate on mutations\n        if (!['POST', 'PUT', 'PATCH', 'DELETE'].includes(method)) {\n            return;\n        }\n\n        // Invalidate by entity type\n        if (path.includes('/clients')) {\n            await this.cacheService.invalidateByTag(`clients:${tenantId}`);\n        }\n        if (path.includes('/cases')) {\n            await this.cacheService.invalidateByTag(`cases:${tenantId}`);\n        }\n        if (path.includes('/documents')) {\n            await this.cacheService.invalidateByTag(`documents:${tenantId}`);\n        }\n        if (path.includes('/events')) {\n            await this.cacheService.invalidateByTag(`events:${tenantId}`);\n        }\n        if (path.includes('/invoices')) {\n            await this.cacheService.invalidateByTag(`invoices:${tenantId}`);\n        }\n        if (path.includes('/calculations')) {\n            await this.cacheService.invalidateByTag(`calculations:${tenantId}`);\n        }\n\n        // Always invalidate dashboard stats on any mutation\n        await this.cacheService.del(`api:${tenantId}:/v1/dashboard:`);\n    }\n}\n"],"names":["CacheInvalidationInterceptor","intercept","context","next","request","switchToHttp","getRequest","user","handle","pipe","tap","tenant_id","invalidateCache","tenantId","method","path","route","includes","cacheService","invalidateByTag","del"],"mappings":";;;;+BAYaA;;;eAAAA;;;wBAZ8D;2BAEvD;mCACc;;;;;;;;;;AAS3B,IAAA,AAAMA,+BAAN,MAAMA;IAGTC,UAAUC,OAAyB,EAAEC,IAAiB,EAAmB;QACrE,MAAMC,UAAUF,QAAQG,YAAY,GAAGC,UAAU;QACjD,MAAMC,OAAOH,QAAQG,IAAI;QAEzB,OAAOJ,KAAKK,MAAM,GAAGC,IAAI,CACrBC,IAAAA,cAAG,EAAC;YACA,IAAI,CAACH,MAAMI,WAAW;YAEtB,sCAAsC;YACtC,MAAM,IAAI,CAACC,eAAe,CAACR,SAASG,KAAKI,SAAS;QACtD;IAER;IAEA;;KAEC,GACD,MAAcC,gBAAgBR,OAAgB,EAAES,QAAgB,EAAiB;QAC7E,MAAMC,SAASV,QAAQU,MAAM;QAC7B,MAAMC,OAAOX,QAAQY,KAAK,EAAED,QAAQX,QAAQW,IAAI;QAEhD,+BAA+B;QAC/B,IAAI,CAAC;YAAC;YAAQ;YAAO;YAAS;SAAS,CAACE,QAAQ,CAACH,SAAS;YACtD;QACJ;QAEA,4BAA4B;QAC5B,IAAIC,KAAKE,QAAQ,CAAC,aAAa;YAC3B,MAAM,IAAI,CAACC,YAAY,CAACC,eAAe,CAAC,CAAC,QAAQ,EAAEN,UAAU;QACjE;QACA,IAAIE,KAAKE,QAAQ,CAAC,WAAW;YACzB,MAAM,IAAI,CAACC,YAAY,CAACC,eAAe,CAAC,CAAC,MAAM,EAAEN,UAAU;QAC/D;QACA,IAAIE,KAAKE,QAAQ,CAAC,eAAe;YAC7B,MAAM,IAAI,CAACC,YAAY,CAACC,eAAe,CAAC,CAAC,UAAU,EAAEN,UAAU;QACnE;QACA,IAAIE,KAAKE,QAAQ,CAAC,YAAY;YAC1B,MAAM,IAAI,CAACC,YAAY,CAACC,eAAe,CAAC,CAAC,OAAO,EAAEN,UAAU;QAChE;QACA,IAAIE,KAAKE,QAAQ,CAAC,cAAc;YAC5B,MAAM,IAAI,CAACC,YAAY,CAACC,eAAe,CAAC,CAAC,SAAS,EAAEN,UAAU;QAClE;QACA,IAAIE,KAAKE,QAAQ,CAAC,kBAAkB;YAChC,MAAM,IAAI,CAACC,YAAY,CAACC,eAAe,CAAC,CAAC,aAAa,EAAEN,UAAU;QACtE;QAEA,oDAAoD;QACpD,MAAM,IAAI,CAACK,YAAY,CAACE,GAAG,CAAC,CAAC,IAAI,EAAEP,SAAS,eAAe,CAAC;IAChE;IAlDA,YAAY,AAAiBK,YAA+B,CAAE;aAAjCA,eAAAA;IAAkC;AAmDnE"}
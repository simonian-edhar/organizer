{"version":3,"sources":["../../../../src/enterprise/cache/services/redis-cache.service.ts"],"sourcesContent":["import { Injectable, Logger, OnModuleInit, OnModuleDestroy } from '@nestjs/common';\nimport { ConfigService } from '@nestjs/config';\nimport { createClient, RedisClientType } from 'redis';\nimport {\n    CacheConfig,\n    CacheEntry,\n    CacheStats,\n    DEFAULT_TTL,\n    CACHE_KEYS,\n} from '../interfaces/cache.interface';\n\n/**\n * Redis Cache Service\n * High-performance caching layer with tenant isolation\n */\n@Injectable()\nexport class RedisCacheService implements OnModuleInit, OnModuleDestroy {\n    private readonly logger = new Logger(RedisCacheService.name);\n    private client: RedisClientType | null = null;\n    private subscriber: RedisClientType | null = null;\n    private publisher: RedisClientType | null = null;\n    private readonly config: CacheConfig;\n    private stats = { hits: 0, misses: 0 };\n    private enabled = false;\n\n    constructor(private readonly configService: ConfigService) {\n        this.config = {\n            host: this.configService.get('REDIS_HOST', 'localhost'),\n            port: this.configService.get('REDIS_PORT', 6379),\n            password: this.configService.get('REDIS_PASSWORD'),\n            db: this.configService.get('REDIS_DB', 0),\n            keyPrefix: this.configService.get('REDIS_PREFIX', 'law-org:'),\n            ttl: DEFAULT_TTL,\n        };\n    }\n\n    async onModuleInit() {\n        const nodeEnv = this.configService.get<string>('NODE_ENV', 'development');\n        const defaultRedis = nodeEnv === 'production' ? 'true' : 'false';\n        const redisEnabled = this.configService.get<string>('REDIS_ENABLED', defaultRedis);\n        if (redisEnabled === 'false' || redisEnabled === '0') {\n            this.logger.log('Redis cache disabled. Using no-op cache.');\n            return;\n        }\n        try {\n            await Promise.race([\n                this.initializeClients(),\n                new Promise((_, reject) => setTimeout(() => reject(new Error('Redis connection timeout 3s')), 3000)),\n            ]);\n            this.enabled = true;\n        } catch (err) {\n            this.logger.warn('Redis unavailable; cache disabled. Set REDIS_ENABLED=false to suppress.');\n        }\n    }\n\n    async onModuleDestroy() {\n        await this.closeClients();\n    }\n\n    /**\n     * Initialize Redis clients\n     */\n    private async initializeClients(): Promise<void> {\n        const clientConfig = {\n            socket: {\n                host: this.config.host,\n                port: this.config.port,\n                connectTimeout: 3000,\n                reconnectStrategy: (retries: number) => {\n                    if (retries > 5) {\n                        return new Error('Redis connection failed');\n                    }\n                    return Math.min(retries * 100, 2000);\n                },\n            },\n            password: this.config.password,\n            database: this.config.db,\n        };\n\n        this.client = createClient(clientConfig) as RedisClientType;\n        this.subscriber = createClient(clientConfig) as RedisClientType;\n        this.publisher = createClient(clientConfig) as RedisClientType;\n\n        this.client.on('error', (err) => this.logger.error('Redis Client Error:', err));\n        this.client.on('connect', () => this.logger.log('Redis Client Connected'));\n\n        await Promise.all([\n            this.client.connect(),\n            this.subscriber.connect(),\n            this.publisher.connect(),\n        ]);\n    }\n\n    /**\n     * Close Redis clients\n     */\n    private async closeClients(): Promise<void> {\n        if (!this.enabled) return;\n        await Promise.all([\n            this.client?.quit().catch(() => {}),\n            this.subscriber?.quit().catch(() => {}),\n            this.publisher?.quit().catch(() => {}),\n        ]);\n        this.client = this.subscriber = this.publisher = null;\n        this.enabled = false;\n    }\n\n    /**\n     * Get value from cache\n     */\n    async get<T>(key: string): Promise<T | null> {\n        if (!this.enabled || !this.client) return null;\n        try {\n            const fullKey = this.getFullKey(key);\n            const data = await this.client.get(fullKey);\n\n            if (!data) {\n                this.stats.misses++;\n                return null;\n            }\n\n            this.stats.hits++;\n            const entry: CacheEntry<T> = JSON.parse(data);\n\n            // Check if entry has expired (additional check)\n            if (entry.timestamp + entry.ttl < Date.now()) {\n                await this.client.del(fullKey);\n                return null;\n            }\n\n            return entry.data;\n        } catch (error) {\n            this.logger.error(`Cache get error for key ${key}:`, error);\n            return null;\n        }\n    }\n\n    /**\n     * Set value in cache\n     */\n    async set<T>(key: string, value: T, ttl: number = this.config.ttl || DEFAULT_TTL, tags: string[] = []): Promise<boolean> {\n        if (!this.enabled || !this.client) return false;\n        try {\n            const fullKey = this.getFullKey(key);\n            const entry: CacheEntry<T> = {\n                data: value,\n                timestamp: Date.now(),\n                ttl: ttl * 1000, // Convert to milliseconds\n                tags,\n            };\n\n            await this.client.setEx(fullKey, ttl, JSON.stringify(entry));\n\n            // Store tag references for invalidation\n            if (tags.length > 0) {\n                for (const tag of tags) {\n                    await this.client.sAdd(this.getTagKey(tag), fullKey);\n                }\n            }\n\n            return true;\n        } catch (error) {\n            this.logger.error(`Cache set error for key ${key}:`, error);\n            return false;\n        }\n    }\n\n    /**\n     * Delete key from cache\n     */\n    async del(key: string): Promise<boolean> {\n        if (!this.enabled || !this.client) return false;\n        try {\n            const fullKey = this.getFullKey(key);\n            await this.client.del(fullKey);\n            return true;\n        } catch (error) {\n            this.logger.error(`Cache del error for key ${key}:`, error);\n            return false;\n        }\n    }\n\n    /**\n     * Delete multiple keys by pattern\n     */\n    async delByPattern(pattern: string): Promise<number> {\n        if (!this.enabled || !this.client) return 0;\n        try {\n            const fullPattern = this.getFullKey(pattern);\n            const keys = await this.client.keys(fullPattern);\n\n            if (keys.length === 0) {\n                return 0;\n            }\n\n            await this.client.del(keys);\n            return keys.length;\n        } catch (error) {\n            this.logger.error(`Cache delByPattern error for pattern ${pattern}:`, error);\n            return 0;\n        }\n    }\n\n    /**\n     * Invalidate cache by tag\n     */\n    async invalidateByTag(tag: string): Promise<number> {\n        if (!this.enabled || !this.client) return 0;\n        try {\n            const tagKey = this.getTagKey(tag);\n            const keys = await this.client.sMembers(tagKey);\n\n            if (keys.length === 0) {\n                return 0;\n            }\n\n            await this.client.del(keys);\n            await this.client.del(tagKey);\n\n            return keys.length;\n        } catch (error) {\n            this.logger.error(`Cache invalidateByTag error for tag ${tag}:`, error);\n            return 0;\n        }\n    }\n\n    /**\n     * Invalidate all cache for tenant\n     */\n    async invalidateTenantCache(tenantId: string): Promise<number> {\n        return this.delByPattern(`*:${tenantId}:*`);\n    }\n\n    /**\n     * Get or set pattern (cache-aside)\n     */\n    async getOrSet<T>(\n        key: string,\n        factory: () => Promise<T>,\n        ttl: number = this.config.ttl || DEFAULT_TTL,\n        tags: string[] = []\n    ): Promise<T> {\n        const cached = await this.get<T>(key);\n\n        if (cached !== null) {\n            return cached;\n        }\n\n        const value = await factory();\n        await this.set(key, value, ttl, tags);\n\n        return value;\n    }\n\n    /**\n     * Increment counter\n     */\n    async incr(key: string): Promise<number> {\n        if (!this.enabled || !this.client) return 0;\n        const fullKey = this.getFullKey(key);\n        return this.client.incr(fullKey);\n    }\n\n    /**\n     * Set with expiration (for rate limiting)\n     */\n    async setEx(key: string, value: string, ttl: number): Promise<boolean> {\n        if (!this.enabled || !this.client) return false;\n        try {\n            const fullKey = this.getFullKey(key);\n            await this.client.setEx(fullKey, ttl, value);\n            return true;\n        } catch (error) {\n            this.logger.error(`Cache setEx error for key ${key}:`, error);\n            return false;\n        }\n    }\n\n    /**\n     * Get TTL for key\n     */\n    async getTtl(key: string): Promise<number> {\n        if (!this.enabled || !this.client) return -1;\n        const fullKey = this.getFullKey(key);\n        return this.client.ttl(fullKey);\n    }\n\n    /**\n     * Check if key exists\n     */\n    async exists(key: string): Promise<boolean> {\n        if (!this.enabled || !this.client) return false;\n        const fullKey = this.getFullKey(key);\n        const result = await this.client.exists(fullKey);\n        return result === 1;\n    }\n\n    /**\n     * Publish message to channel\n     */\n    async publish(channel: string, message: any): Promise<number> {\n        if (!this.enabled || !this.publisher) return 0;\n        return this.publisher.publish(channel, JSON.stringify(message));\n    }\n\n    /**\n     * Subscribe to channel\n     */\n    async subscribe(channel: string, callback: (message: any) => void): Promise<void> {\n        if (!this.enabled || !this.subscriber) return;\n        await this.subscriber.subscribe(channel, (message) => {\n            try {\n                callback(JSON.parse(message));\n            } catch (error) {\n                this.logger.error(`Subscribe callback error for channel ${channel}:`, error);\n            }\n        });\n    }\n\n    /**\n     * Get cache statistics\n     */\n    async getStats(): Promise<CacheStats> {\n        if (!this.enabled || !this.client) {\n            return { hits: 0, misses: 0, hitRate: 0, totalKeys: 0, memoryUsage: 0 };\n        }\n        const info = await this.client.info('memory');\n        const memoryMatch = info.match(/used_memory:(\\d+)/);\n        const memoryUsage = memoryMatch ? parseInt(memoryMatch[1]) : 0;\n\n        const dbSize = await this.client.dbSize();\n\n        return {\n            hits: this.stats.hits,\n            misses: this.stats.misses,\n            hitRate: this.stats.hits + this.stats.misses > 0\n                ? this.stats.hits / (this.stats.hits + this.stats.misses)\n                : 0,\n            totalKeys: dbSize,\n            memoryUsage,\n        };\n    }\n\n    /**\n     * Reset statistics\n     */\n    resetStats(): void {\n        this.stats = { hits: 0, misses: 0 };\n    }\n\n    /**\n     * Flush all cache (use with caution)\n     */\n    async flushAll(): Promise<void> {\n        if (!this.enabled || !this.client) return;\n        await this.client.flushDb();\n        this.logger.warn('Cache flushed');\n    }\n\n    /**\n     * Build full key with prefix\n     */\n    private getFullKey(key: string): string {\n        return `${this.config.keyPrefix}${key}`;\n    }\n\n    /**\n     * Get tag key for storage\n     */\n    private getTagKey(tag: string): string {\n        return this.getFullKey(`tag:${tag}`);\n    }\n\n    /**\n     * Get raw Redis client for advanced operations\n     */\n    getClient(): RedisClientType | null {\n        return this.client;\n    }\n}\n"],"names":["RedisCacheService","onModuleInit","nodeEnv","configService","get","defaultRedis","redisEnabled","logger","log","Promise","race","initializeClients","_","reject","setTimeout","Error","enabled","err","warn","onModuleDestroy","closeClients","clientConfig","socket","host","config","port","connectTimeout","reconnectStrategy","retries","Math","min","password","database","db","client","createClient","subscriber","publisher","on","error","all","connect","quit","catch","key","fullKey","getFullKey","data","stats","misses","hits","entry","JSON","parse","timestamp","ttl","Date","now","del","set","value","DEFAULT_TTL","tags","setEx","stringify","length","tag","sAdd","getTagKey","delByPattern","pattern","fullPattern","keys","invalidateByTag","tagKey","sMembers","invalidateTenantCache","tenantId","getOrSet","factory","cached","incr","getTtl","exists","result","publish","channel","message","subscribe","callback","getStats","hitRate","totalKeys","memoryUsage","info","memoryMatch","match","parseInt","dbSize","resetStats","flushAll","flushDb","keyPrefix","getClient","Logger","name"],"mappings":"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"}
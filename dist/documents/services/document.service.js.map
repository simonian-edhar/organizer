{"version":3,"sources":["../../../src/documents/services/document.service.ts"],"sourcesContent":["import { Injectable, NotFoundException, BadRequestException, ForbiddenException } from '@nestjs/common';\nimport { InjectRepository } from '@nestjs/typeorm';\nimport { Repository } from 'typeorm';\nimport { Document } from '../../database/entities/Document.entity';\nimport { UploadDocumentDto, UpdateDocumentDto, DocumentFiltersDto, SignDocumentDto, GenerateSignedUrlDto } from '../dto/document.dto';\nimport { validateFileUpload } from '../../common/utils/validation.util';\nimport { FileStorageService } from '../../file-storage/services/file-storage.service';\nimport * as crypto from 'crypto';\n\n/**\n * Document Service\n */\n@Injectable()\nexport class DocumentService {\n    constructor(\n        @InjectRepository(Document)\n        private readonly documentRepository: Repository<Document>,\n        private readonly fileStorageService: FileStorageService,\n    ) {}\n\n    /**\n     * Get all documents with filters\n     */\n    async findAll(\n        tenantId: string,\n        filters: DocumentFiltersDto = {}\n    ): Promise<{ data: Document[]; total: number; page: number; limit: number }> {\n        const query = this.documentRepository\n            .createQueryBuilder('document')\n            .where('document.tenantId = :tenantId AND document.deletedAt IS NULL', { tenantId });\n\n        // Filter by case\n        if (filters.caseId) {\n            query.andWhere('document.caseId = :caseId', { caseId: filters.caseId });\n        }\n\n        // Filter by client\n        if (filters.clientId) {\n            query.andWhere('document.clientId = :clientId', { clientId: filters.clientId });\n        }\n\n        // Filter by type\n        if (filters.type) {\n            query.andWhere('document.type = :type', { type: filters.type });\n        }\n\n        // Filter by status\n        if (filters.status) {\n            query.andWhere('document.status = :status', { status: filters.status });\n        }\n\n        // Filter by access level\n        if (filters.accessLevel) {\n            query.andWhere('document.accessLevel = :accessLevel', { accessLevel: filters.accessLevel });\n        }\n\n        // Search\n        if (filters.search) {\n            query.andWhere(\n                '(document.fileName ILIKE :search OR ' +\n                'document.description ILIKE :search OR ' +\n                'document.originalName ILIKE :search)',\n                { search: `%${filters.search}%` }\n            );\n        }\n\n        // Sorting\n        const sortBy = filters.sortBy || 'uploadedAt';\n        const sortOrder = filters.sortOrder || 'DESC';\n        query.orderBy(`document.${sortBy}`, sortOrder);\n\n        // Pagination\n        const page = filters.page || 1;\n        const limit = filters.limit || 20;\n        const skip = (page - 1) * limit;\n\n        query.skip(skip).take(limit);\n\n        // Include relations\n        query.leftJoinAndSelect('document.uploadedByUser', 'uploadedByUser');\n        query.leftJoinAndSelect('document.case', 'case');\n\n        const [data, total] = await query.getManyAndCount();\n\n        return {\n            data,\n            total,\n            page,\n            limit,\n        };\n    }\n\n    /**\n     * Get document by ID\n     */\n    async findById(tenantId: string, id: string): Promise<Document> {\n        const document = await this.documentRepository.findOne({\n            where: {\n                id,\n                tenantId,\n                deletedAt: null,\n            },\n            relations: ['uploadedByUser', 'case', 'signedByUser'],\n        });\n\n        if (!document) {\n            throw new NotFoundException('Документ не знайдено');\n        }\n\n        return document;\n    }\n\n    /**\n     * Upload document\n     */\n    async upload(\n        tenantId: string,\n        userId: string,\n        file: Express.Multer.File,\n        dto: UploadDocumentDto\n    ): Promise<Document> {\n        // Validate file\n        const allowedMimeTypes = [\n            'application/pdf',\n            'application/msword',\n            'application/vnd.openxmlformats-officedocument.wordprocessingml.document',\n            'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',\n            'image/jpeg',\n            'image/png',\n            'image/jpg',\n        ];\n\n        const maxSize = 50 * 1024 * 1024; // 50 MB\n\n        const validation = validateFileUpload(file, allowedMimeTypes, maxSize);\n        if (!validation.valid) {\n            throw new BadRequestException(validation.error);\n        }\n\n        // Upload file using file storage service\n        const uploadResult = await this.fileStorageService.uploadFile(tenantId, userId, file, {\n            caseId: dto.caseId,\n            clientId: dto.clientId,\n            folder: 'documents',\n            isPublic: false,\n            metadata: {\n                documentType: dto.type,\n                description: dto.description || '',\n            },\n        });\n\n        const document = this.documentRepository.create({\n            tenantId,\n            caseId: dto.caseId,\n            clientId: dto.clientId,\n            fileName: uploadResult.path.split('/').pop() || uploadResult.path,\n            originalName: file.originalname,\n            type: dto.type,\n            description: dto.description,\n            mimeType: file.mimetype,\n            fileSize: file.size,\n            status: 'draft',\n            storagePath: uploadResult.path,\n            cdnUrl: uploadResult.url,\n            accessLevel: dto.accessLevel || 'internal',\n            uploadedBy: userId,\n            uploadedAt: new Date(),\n            createdBy: userId,\n            updatedBy: userId,\n        });\n\n        const savedDocument = await this.documentRepository.save(document);\n\n        return savedDocument;\n    }\n\n    /**\n     * Update document metadata\n     */\n    async update(\n        tenantId: string,\n        id: string,\n        userId: string,\n        dto: UpdateDocumentDto\n    ): Promise<Document> {\n        const document = await this.findById(tenantId, id);\n\n        Object.assign(document, dto, {\n            updatedBy: userId,\n        });\n\n        return this.documentRepository.save(document);\n    }\n\n    /**\n     * Sign document\n     */\n    async sign(\n        tenantId: string,\n        id: string,\n        userId: string,\n        dto: SignDocumentDto\n    ): Promise<Document> {\n        const document = await this.findById(tenantId, id);\n\n        // TODO: Verify signature hash\n        // This would integrate with the e-signature service\n\n        document.status = 'signed';\n        document.signatureHash = dto.signatureHash;\n        document.signatureAlgorithm = dto.signatureAlgorithm || 'ECDSA';\n        document.signedAt = new Date();\n        document.signedBy = userId;\n        document.updatedBy = userId;\n        document.version += 1;\n\n        return this.documentRepository.save(document);\n    }\n\n    /**\n     * Generate signed URL (time-limited)\n     */\n    async generateSignedUrl(\n        tenantId: string,\n        id: string,\n        dto: GenerateSignedUrlDto\n    ): Promise<{ url: string; expiresAt: Date }> {\n        const document = await this.findById(tenantId, id);\n\n        const expiresAt = new Date(Date.now() + (dto.expiresIn || 7 * 24 * 60 * 60 * 1000));\n        const expiresIn = Math.floor((expiresAt.getTime() - Date.now()) / 1000);\n\n        // Generate signed URL using storage service\n        const signedUrl = await this.fileStorageService.generateSignedUrl(tenantId, document.storagePath, {\n            expiresIn,\n            disposition: 'attachment',\n        });\n\n        // Store signed URL info in metadata\n        document.signedUrl = signedUrl;\n        document.metadata = {\n            ...document.metadata,\n            signedUrlExpiresAt: expiresAt.toISOString(),\n        };\n\n        await this.documentRepository.save(document);\n\n        return {\n            url: signedUrl,\n            expiresAt,\n        };\n    }\n\n    /**\n     * Delete document (soft delete)\n     */\n    async delete(tenantId: string, id: string, userId: string): Promise<void> {\n        const document = await this.findById(tenantId, id);\n\n        // Delete file from storage\n        if (document.storagePath) {\n            await this.fileStorageService.deleteFile(tenantId, document.storagePath);\n        }\n\n        await this.documentRepository.update(\n            { id, tenantId },\n            {\n                deletedAt: new Date(),\n                updatedBy: userId,\n            }\n        );\n    }\n\n    /**\n     * Bulk upload documents\n     */\n    async bulkUpload(\n        tenantId: string,\n        userId: string,\n        files: Express.Multer.File[],\n        dtos: UploadDocumentDto[]\n    ): Promise<{ success: number; failed: number; documents: Document[] }> {\n        const results = {\n            success: 0,\n            failed: 0,\n            documents: [] as Document[],\n        };\n\n        for (let i = 0; i < files.length && i < dtos.length; i++) {\n            try {\n                const document = await this.upload(tenantId, userId, files[i], dtos[i]);\n                results.success++;\n                results.documents.push(document);\n            } catch (error) {\n                results.failed++;\n            }\n        }\n\n        return results;\n    }\n\n    /**\n     * Get document statistics\n     */\n    async getStatistics(tenantId: string): Promise<{\n        total: number;\n        byType: Record<string, number>;\n        byStatus: Record<string, number>;\n        totalSize: number;\n    }> {\n        const [total] = await this.documentRepository\n            .createQueryBuilder('document')\n            .select('COUNT(*)')\n            .where('document.tenantId = :tenantId AND document.deletedAt IS NULL', { tenantId })\n            .getRawMany();\n\n        const [totalSize] = await this.documentRepository\n            .createQueryBuilder('document')\n            .select('SUM(document.fileSize)')\n            .where('document.tenantId = :tenantId AND document.deletedAt IS NULL', { tenantId })\n            .getRawMany();\n\n        const byType = await this.documentRepository\n            .createQueryBuilder('document')\n            .select('document.type', 'COUNT(*) as count')\n            .where('document.tenantId = :tenantId AND document.deletedAt IS NULL', { tenantId })\n            .groupBy('document.type')\n            .getRawMany();\n\n        const byStatus = await this.documentRepository\n            .createQueryBuilder('document')\n            .select('document.status', 'COUNT(*) as count')\n            .where('document.tenantId = :tenantId AND document.deletedAt IS NULL', { tenantId })\n            .groupBy('document.status')\n            .getRawMany();\n\n        return {\n            total: parseInt(total[0].count),\n            totalSize: parseInt(totalSize[0].sum) || 0,\n            byType: byType.reduce((acc, row) => {\n                acc[row.type] = parseInt(row.count);\n                return acc;\n            }, {} as Record<string, number>),\n            byStatus: byStatus.reduce((acc, row) => {\n                acc[row.status] = parseInt(row.count);\n                return acc;\n            }, {} as Record<string, number>),\n        };\n    }\n}\n"],"names":["DocumentService","findAll","tenantId","filters","query","documentRepository","createQueryBuilder","where","caseId","andWhere","clientId","type","status","accessLevel","search","sortBy","sortOrder","orderBy","page","limit","skip","take","leftJoinAndSelect","data","total","getManyAndCount","findById","id","document","findOne","deletedAt","relations","NotFoundException","upload","userId","file","dto","allowedMimeTypes","maxSize","validation","validateFileUpload","valid","BadRequestException","error","uploadResult","fileStorageService","uploadFile","folder","isPublic","metadata","documentType","description","create","fileName","path","split","pop","originalName","originalname","mimeType","mimetype","fileSize","size","storagePath","cdnUrl","url","uploadedBy","uploadedAt","Date","createdBy","updatedBy","savedDocument","save","update","Object","assign","sign","signatureHash","signatureAlgorithm","signedAt","signedBy","version","generateSignedUrl","expiresAt","now","expiresIn","Math","floor","getTime","signedUrl","disposition","signedUrlExpiresAt","toISOString","delete","deleteFile","bulkUpload","files","dtos","results","success","failed","documents","i","length","push","getStatistics","select","getRawMany","totalSize","byType","groupBy","byStatus","parseInt","count","sum","reduce","acc","row"],"mappings":";;;;+BAaaA;;;eAAAA;;;wBAb0E;yBACtD;0BACN;gCACF;gCAEU;oCACA;;;;;;;;;;;;;;;AAO5B,IAAA,AAAMA,kBAAN,MAAMA;IAOT;;KAEC,GACD,MAAMC,QACFC,QAAgB,EAChBC,UAA8B,CAAC,CAAC,EACyC;QACzE,MAAMC,QAAQ,IAAI,CAACC,kBAAkB,CAChCC,kBAAkB,CAAC,YACnBC,KAAK,CAAC,gEAAgE;YAAEL;QAAS;QAEtF,iBAAiB;QACjB,IAAIC,QAAQK,MAAM,EAAE;YAChBJ,MAAMK,QAAQ,CAAC,6BAA6B;gBAAED,QAAQL,QAAQK,MAAM;YAAC;QACzE;QAEA,mBAAmB;QACnB,IAAIL,QAAQO,QAAQ,EAAE;YAClBN,MAAMK,QAAQ,CAAC,iCAAiC;gBAAEC,UAAUP,QAAQO,QAAQ;YAAC;QACjF;QAEA,iBAAiB;QACjB,IAAIP,QAAQQ,IAAI,EAAE;YACdP,MAAMK,QAAQ,CAAC,yBAAyB;gBAAEE,MAAMR,QAAQQ,IAAI;YAAC;QACjE;QAEA,mBAAmB;QACnB,IAAIR,QAAQS,MAAM,EAAE;YAChBR,MAAMK,QAAQ,CAAC,6BAA6B;gBAAEG,QAAQT,QAAQS,MAAM;YAAC;QACzE;QAEA,yBAAyB;QACzB,IAAIT,QAAQU,WAAW,EAAE;YACrBT,MAAMK,QAAQ,CAAC,uCAAuC;gBAAEI,aAAaV,QAAQU,WAAW;YAAC;QAC7F;QAEA,SAAS;QACT,IAAIV,QAAQW,MAAM,EAAE;YAChBV,MAAMK,QAAQ,CACV,yCACA,2CACA,wCACA;gBAAEK,QAAQ,CAAC,CAAC,EAAEX,QAAQW,MAAM,CAAC,CAAC,CAAC;YAAC;QAExC;QAEA,UAAU;QACV,MAAMC,SAASZ,QAAQY,MAAM,IAAI;QACjC,MAAMC,YAAYb,QAAQa,SAAS,IAAI;QACvCZ,MAAMa,OAAO,CAAC,CAAC,SAAS,EAAEF,QAAQ,EAAEC;QAEpC,aAAa;QACb,MAAME,OAAOf,QAAQe,IAAI,IAAI;QAC7B,MAAMC,QAAQhB,QAAQgB,KAAK,IAAI;QAC/B,MAAMC,OAAO,AAACF,CAAAA,OAAO,CAAA,IAAKC;QAE1Bf,MAAMgB,IAAI,CAACA,MAAMC,IAAI,CAACF;QAEtB,oBAAoB;QACpBf,MAAMkB,iBAAiB,CAAC,2BAA2B;QACnDlB,MAAMkB,iBAAiB,CAAC,iBAAiB;QAEzC,MAAM,CAACC,MAAMC,MAAM,GAAG,MAAMpB,MAAMqB,eAAe;QAEjD,OAAO;YACHF;YACAC;YACAN;YACAC;QACJ;IACJ;IAEA;;KAEC,GACD,MAAMO,SAASxB,QAAgB,EAAEyB,EAAU,EAAqB;QAC5D,MAAMC,WAAW,MAAM,IAAI,CAACvB,kBAAkB,CAACwB,OAAO,CAAC;YACnDtB,OAAO;gBACHoB;gBACAzB;gBACA4B,WAAW;YACf;YACAC,WAAW;gBAAC;gBAAkB;gBAAQ;aAAe;QACzD;QAEA,IAAI,CAACH,UAAU;YACX,MAAM,IAAII,yBAAiB,CAAC;QAChC;QAEA,OAAOJ;IACX;IAEA;;KAEC,GACD,MAAMK,OACF/B,QAAgB,EAChBgC,MAAc,EACdC,IAAyB,EACzBC,GAAsB,EACL;QACjB,gBAAgB;QAChB,MAAMC,mBAAmB;YACrB;YACA;YACA;YACA;YACA;YACA;YACA;SACH;QAED,MAAMC,UAAU,KAAK,OAAO,MAAM,QAAQ;QAE1C,MAAMC,aAAaC,IAAAA,kCAAkB,EAACL,MAAME,kBAAkBC;QAC9D,IAAI,CAACC,WAAWE,KAAK,EAAE;YACnB,MAAM,IAAIC,2BAAmB,CAACH,WAAWI,KAAK;QAClD;QAEA,yCAAyC;QACzC,MAAMC,eAAe,MAAM,IAAI,CAACC,kBAAkB,CAACC,UAAU,CAAC5C,UAAUgC,QAAQC,MAAM;YAClF3B,QAAQ4B,IAAI5B,MAAM;YAClBE,UAAU0B,IAAI1B,QAAQ;YACtBqC,QAAQ;YACRC,UAAU;YACVC,UAAU;gBACNC,cAAcd,IAAIzB,IAAI;gBACtBwC,aAAaf,IAAIe,WAAW,IAAI;YACpC;QACJ;QAEA,MAAMvB,WAAW,IAAI,CAACvB,kBAAkB,CAAC+C,MAAM,CAAC;YAC5ClD;YACAM,QAAQ4B,IAAI5B,MAAM;YAClBE,UAAU0B,IAAI1B,QAAQ;YACtB2C,UAAUT,aAAaU,IAAI,CAACC,KAAK,CAAC,KAAKC,GAAG,MAAMZ,aAAaU,IAAI;YACjEG,cAActB,KAAKuB,YAAY;YAC/B/C,MAAMyB,IAAIzB,IAAI;YACdwC,aAAaf,IAAIe,WAAW;YAC5BQ,UAAUxB,KAAKyB,QAAQ;YACvBC,UAAU1B,KAAK2B,IAAI;YACnBlD,QAAQ;YACRmD,aAAanB,aAAaU,IAAI;YAC9BU,QAAQpB,aAAaqB,GAAG;YACxBpD,aAAauB,IAAIvB,WAAW,IAAI;YAChCqD,YAAYhC;YACZiC,YAAY,IAAIC;YAChBC,WAAWnC;YACXoC,WAAWpC;QACf;QAEA,MAAMqC,gBAAgB,MAAM,IAAI,CAAClE,kBAAkB,CAACmE,IAAI,CAAC5C;QAEzD,OAAO2C;IACX;IAEA;;KAEC,GACD,MAAME,OACFvE,QAAgB,EAChByB,EAAU,EACVO,MAAc,EACdE,GAAsB,EACL;QACjB,MAAMR,WAAW,MAAM,IAAI,CAACF,QAAQ,CAACxB,UAAUyB;QAE/C+C,OAAOC,MAAM,CAAC/C,UAAUQ,KAAK;YACzBkC,WAAWpC;QACf;QAEA,OAAO,IAAI,CAAC7B,kBAAkB,CAACmE,IAAI,CAAC5C;IACxC;IAEA;;KAEC,GACD,MAAMgD,KACF1E,QAAgB,EAChByB,EAAU,EACVO,MAAc,EACdE,GAAoB,EACH;QACjB,MAAMR,WAAW,MAAM,IAAI,CAACF,QAAQ,CAACxB,UAAUyB;QAE/C,8BAA8B;QAC9B,oDAAoD;QAEpDC,SAAShB,MAAM,GAAG;QAClBgB,SAASiD,aAAa,GAAGzC,IAAIyC,aAAa;QAC1CjD,SAASkD,kBAAkB,GAAG1C,IAAI0C,kBAAkB,IAAI;QACxDlD,SAASmD,QAAQ,GAAG,IAAIX;QACxBxC,SAASoD,QAAQ,GAAG9C;QACpBN,SAAS0C,SAAS,GAAGpC;QACrBN,SAASqD,OAAO,IAAI;QAEpB,OAAO,IAAI,CAAC5E,kBAAkB,CAACmE,IAAI,CAAC5C;IACxC;IAEA;;KAEC,GACD,MAAMsD,kBACFhF,QAAgB,EAChByB,EAAU,EACVS,GAAyB,EACgB;QACzC,MAAMR,WAAW,MAAM,IAAI,CAACF,QAAQ,CAACxB,UAAUyB;QAE/C,MAAMwD,YAAY,IAAIf,KAAKA,KAAKgB,GAAG,KAAMhD,CAAAA,IAAIiD,SAAS,IAAI,IAAI,KAAK,KAAK,KAAK,IAAG;QAChF,MAAMA,YAAYC,KAAKC,KAAK,CAAC,AAACJ,CAAAA,UAAUK,OAAO,KAAKpB,KAAKgB,GAAG,EAAC,IAAK;QAElE,4CAA4C;QAC5C,MAAMK,YAAY,MAAM,IAAI,CAAC5C,kBAAkB,CAACqC,iBAAiB,CAAChF,UAAU0B,SAASmC,WAAW,EAAE;YAC9FsB;YACAK,aAAa;QACjB;QAEA,oCAAoC;QACpC9D,SAAS6D,SAAS,GAAGA;QACrB7D,SAASqB,QAAQ,GAAG;YAChB,GAAGrB,SAASqB,QAAQ;YACpB0C,oBAAoBR,UAAUS,WAAW;QAC7C;QAEA,MAAM,IAAI,CAACvF,kBAAkB,CAACmE,IAAI,CAAC5C;QAEnC,OAAO;YACHqC,KAAKwB;YACLN;QACJ;IACJ;IAEA;;KAEC,GACD,MAAMU,OAAO3F,QAAgB,EAAEyB,EAAU,EAAEO,MAAc,EAAiB;QACtE,MAAMN,WAAW,MAAM,IAAI,CAACF,QAAQ,CAACxB,UAAUyB;QAE/C,2BAA2B;QAC3B,IAAIC,SAASmC,WAAW,EAAE;YACtB,MAAM,IAAI,CAAClB,kBAAkB,CAACiD,UAAU,CAAC5F,UAAU0B,SAASmC,WAAW;QAC3E;QAEA,MAAM,IAAI,CAAC1D,kBAAkB,CAACoE,MAAM,CAChC;YAAE9C;YAAIzB;QAAS,GACf;YACI4B,WAAW,IAAIsC;YACfE,WAAWpC;QACf;IAER;IAEA;;KAEC,GACD,MAAM6D,WACF7F,QAAgB,EAChBgC,MAAc,EACd8D,KAA4B,EAC5BC,IAAyB,EAC0C;QACnE,MAAMC,UAAU;YACZC,SAAS;YACTC,QAAQ;YACRC,WAAW,EAAE;QACjB;QAEA,IAAK,IAAIC,IAAI,GAAGA,IAAIN,MAAMO,MAAM,IAAID,IAAIL,KAAKM,MAAM,EAAED,IAAK;YACtD,IAAI;gBACA,MAAM1E,WAAW,MAAM,IAAI,CAACK,MAAM,CAAC/B,UAAUgC,QAAQ8D,KAAK,CAACM,EAAE,EAAEL,IAAI,CAACK,EAAE;gBACtEJ,QAAQC,OAAO;gBACfD,QAAQG,SAAS,CAACG,IAAI,CAAC5E;YAC3B,EAAE,OAAOe,OAAO;gBACZuD,QAAQE,MAAM;YAClB;QACJ;QAEA,OAAOF;IACX;IAEA;;KAEC,GACD,MAAMO,cAAcvG,QAAgB,EAKjC;QACC,MAAM,CAACsB,MAAM,GAAG,MAAM,IAAI,CAACnB,kBAAkB,CACxCC,kBAAkB,CAAC,YACnBoG,MAAM,CAAC,YACPnG,KAAK,CAAC,gEAAgE;YAAEL;QAAS,GACjFyG,UAAU;QAEf,MAAM,CAACC,UAAU,GAAG,MAAM,IAAI,CAACvG,kBAAkB,CAC5CC,kBAAkB,CAAC,YACnBoG,MAAM,CAAC,0BACPnG,KAAK,CAAC,gEAAgE;YAAEL;QAAS,GACjFyG,UAAU;QAEf,MAAME,SAAS,MAAM,IAAI,CAACxG,kBAAkB,CACvCC,kBAAkB,CAAC,YACnBoG,MAAM,CAAC,iBAAiB,qBACxBnG,KAAK,CAAC,gEAAgE;YAAEL;QAAS,GACjF4G,OAAO,CAAC,iBACRH,UAAU;QAEf,MAAMI,WAAW,MAAM,IAAI,CAAC1G,kBAAkB,CACzCC,kBAAkB,CAAC,YACnBoG,MAAM,CAAC,mBAAmB,qBAC1BnG,KAAK,CAAC,gEAAgE;YAAEL;QAAS,GACjF4G,OAAO,CAAC,mBACRH,UAAU;QAEf,OAAO;YACHnF,OAAOwF,SAASxF,KAAK,CAAC,EAAE,CAACyF,KAAK;YAC9BL,WAAWI,SAASJ,SAAS,CAAC,EAAE,CAACM,GAAG,KAAK;YACzCL,QAAQA,OAAOM,MAAM,CAAC,CAACC,KAAKC;gBACxBD,GAAG,CAACC,IAAI1G,IAAI,CAAC,GAAGqG,SAASK,IAAIJ,KAAK;gBAClC,OAAOG;YACX,GAAG,CAAC;YACJL,UAAUA,SAASI,MAAM,CAAC,CAACC,KAAKC;gBAC5BD,GAAG,CAACC,IAAIzG,MAAM,CAAC,GAAGoG,SAASK,IAAIJ,KAAK;gBACpC,OAAOG;YACX,GAAG,CAAC;QACR;IACJ;IA9UA,YACI,AACiB/G,kBAAwC,EACzD,AAAiBwC,kBAAsC,CACzD;aAFmBxC,qBAAAA;aACAwC,qBAAAA;IAClB;AA2UP"}
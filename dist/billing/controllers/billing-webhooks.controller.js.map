{"version":3,"sources":["../../../src/billing/controllers/billing-webhooks.controller.ts"],"sourcesContent":["import {\n    Controller,\n    Post,\n    Body,\n    Req,\n    Request,\n    HttpCode,\n    HttpStatus,\n    Logger,\n} from '@nestjs/common';\nimport { ApiTags, ApiOperation, ApiResponse } from '@nestjs/swagger';\nimport { StripeService } from '../services/stripe.service';\nimport { WayForPayService } from '../services/wayforpay.service';\n\n/**\n * Billing Webhooks Controller\n */\n@ApiTags('Billing Webhooks')\n@Controller('billing/webhooks')\nexport class BillingWebhooksController {\n    private readonly logger = new Logger(BillingWebhooksController.name);\n\n    constructor(\n        private readonly stripeService: StripeService,\n        private readonly wayForPayService: WayForPayService,\n    ) {}\n\n    @Post('stripe')\n    @HttpCode(HttpStatus.OK)\n    @ApiOperation({ summary: 'Stripe webhook' })\n    @ApiResponse({ status: 200, description: 'Webhook processed' })\n    async handleStripeWebhook(\n        @Body() body: any,\n        @Req() req: Request,\n    ): Promise<void> {\n        const signature = req.headers['stripe-signature'] as string;\n        const payload = JSON.stringify(body);\n\n        await this.stripeService.handleWebhook(payload, signature);\n    }\n\n    @Post('wayforpay')\n    @HttpCode(HttpStatus.OK)\n    @ApiOperation({ summary: 'WayForPay webhook callback' })\n    @ApiResponse({ status: 200, description: 'Webhook processed' })\n    async handleWayForPayWebhook(@Body() payload: any): Promise<{ status: string }> {\n        this.logger.log(`Received WayForPay webhook for order: ${payload.orderReference}`);\n\n        const result = await this.wayForPayService.handleWebhook(payload);\n\n        // Return response in WayForPay expected format\n        return {\n            status: result.status,\n        };\n    }\n\n    @Post('wayforpay/service')\n    @HttpCode(HttpStatus.OK)\n    @ApiOperation({ summary: 'WayForPay service callback (alternative endpoint)' })\n    @ApiResponse({ status: 200, description: 'Service callback processed' })\n    async handleWayForPayServiceCallback(@Body() payload: any): Promise<{\n        orderReference: string;\n        status: string;\n        time: number;\n        signature?: string;\n    }> {\n        this.logger.log(`Received WayForPay service callback for order: ${payload.orderReference}`);\n\n        try {\n            const result = await this.wayForPayService.handleWebhook(payload);\n\n            // Generate response signature\n            const signature = this.wayForPayService.generateCallbackResponse(\n                payload.orderReference,\n                result.status === 'ok' ? 'accept' : 'decline'\n            );\n\n            return {\n                orderReference: payload.orderReference,\n                status: result.status === 'ok' ? 'accept' : 'decline',\n                time: Math.floor(Date.now() / 1000),\n                signature,\n            };\n        } catch (error) {\n            this.logger.error(`Failed to process WayForPay service callback: ${error.message}`);\n\n            return {\n                orderReference: payload.orderReference,\n                status: 'decline',\n                time: Math.floor(Date.now() / 1000),\n            };\n        }\n    }\n}\n"],"names":["BillingWebhooksController","handleStripeWebhook","body","req","signature","headers","payload","JSON","stringify","stripeService","handleWebhook","handleWayForPayWebhook","logger","log","orderReference","result","wayForPayService","status","handleWayForPayServiceCallback","generateCallbackResponse","time","Math","floor","Date","now","error","message","Logger","name","OK","summary","description"],"mappings":";;;;+BAmBaA;;;eAAAA;;;wBAVN;yBAC4C;+BACrB;kCACG;;;;;;;;;;;;;;;AAO1B,IAAA,AAAMA,4BAAN,MAAMA;IAQT,MAIMC,oBACF,AAAQC,IAAS,EACjB,AAAOC,GAAY,EACN;QACb,MAAMC,YAAYD,IAAIE,OAAO,CAAC,mBAAmB;QACjD,MAAMC,UAAUC,KAAKC,SAAS,CAACN;QAE/B,MAAM,IAAI,CAACO,aAAa,CAACC,aAAa,CAACJ,SAASF;IACpD;IAEA,MAIMO,uBAAuB,AAAQL,OAAY,EAA+B;QAC5E,IAAI,CAACM,MAAM,CAACC,GAAG,CAAC,CAAC,sCAAsC,EAAEP,QAAQQ,cAAc,EAAE;QAEjF,MAAMC,SAAS,MAAM,IAAI,CAACC,gBAAgB,CAACN,aAAa,CAACJ;QAEzD,+CAA+C;QAC/C,OAAO;YACHW,QAAQF,OAAOE,MAAM;QACzB;IACJ;IAEA,MAIMC,+BAA+B,AAAQZ,OAAY,EAKtD;QACC,IAAI,CAACM,MAAM,CAACC,GAAG,CAAC,CAAC,+CAA+C,EAAEP,QAAQQ,cAAc,EAAE;QAE1F,IAAI;YACA,MAAMC,SAAS,MAAM,IAAI,CAACC,gBAAgB,CAACN,aAAa,CAACJ;YAEzD,8BAA8B;YAC9B,MAAMF,YAAY,IAAI,CAACY,gBAAgB,CAACG,wBAAwB,CAC5Db,QAAQQ,cAAc,EACtBC,OAAOE,MAAM,KAAK,OAAO,WAAW;YAGxC,OAAO;gBACHH,gBAAgBR,QAAQQ,cAAc;gBACtCG,QAAQF,OAAOE,MAAM,KAAK,OAAO,WAAW;gBAC5CG,MAAMC,KAAKC,KAAK,CAACC,KAAKC,GAAG,KAAK;gBAC9BpB;YACJ;QACJ,EAAE,OAAOqB,OAAO;YACZ,IAAI,CAACb,MAAM,CAACa,KAAK,CAAC,CAAC,8CAA8C,EAAEA,MAAMC,OAAO,EAAE;YAElF,OAAO;gBACHZ,gBAAgBR,QAAQQ,cAAc;gBACtCG,QAAQ;gBACRG,MAAMC,KAAKC,KAAK,CAACC,KAAKC,GAAG,KAAK;YAClC;QACJ;IACJ;IAtEA,YACI,AAAiBf,aAA4B,EAC7C,AAAiBO,gBAAkC,CACrD;aAFmBP,gBAAAA;aACAO,mBAAAA;aAJJJ,SAAS,IAAIe,cAAM,CAAC3B,0BAA0B4B,IAAI;IAKhE;AAoEP;;;6CAjEyBC;;QACLC,SAAS;;;QACVb,QAAQ;QAAKc,aAAa;;;;;;;;;;;;;6CAYpBF;;QACLC,SAAS;;;QACVb,QAAQ;QAAKc,aAAa;;;;;;;;;;;6CAapBF;;QACLC,SAAS;;;QACVb,QAAQ;QAAKc,aAAa"}
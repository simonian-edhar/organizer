{"version":3,"sources":["../../../src/billing/controllers/billing.controller.ts"],"sourcesContent":["import {\n    Controller,\n    Post,\n    Get,\n    Body,\n    Req,\n    Request,\n    UseGuards,\n    HttpCode,\n    HttpStatus,\n} from '@nestjs/common';\nimport { ApiTags, ApiOperation, ApiResponse, ApiBearerAuth } from '@nestjs/swagger';\nimport { BillingService } from '../services/billing.service';\nimport { StripeService } from '../services/stripe.service';\nimport { WayForPayService } from '../services/wayforpay.service';\nimport { CreateCheckoutSessionDto, CancelSubscriptionDto, ResumeSubscriptionDto } from '../dto/billing.dto';\nimport { JwtAuthGuard } from '../../auth/guards';\n\n/**\n * Billing Controller\n */\n@ApiTags('Billing')\n@Controller('billing')\n@UseGuards(JwtAuthGuard)\n@ApiBearerAuth()\nexport class BillingController {\n    constructor(\n        private readonly billingService: BillingService,\n        private readonly stripeService: StripeService,\n        private readonly wayForPayService: WayForPayService,\n    ) {}\n\n    @Post('checkout')\n    @ApiOperation({ summary: 'Create checkout session' })\n    @ApiResponse({ status: 200, description: 'Checkout session created' })\n    async createCheckoutSession(\n        @Body() dto: CreateCheckoutSessionDto,\n        @Req() req: Request,\n    ): Promise<{ checkoutUrl: string; sessionId: string }> {\n        const tenantId = (req as any).user?.tenant_id;\n\n        if (dto.provider === 'stripe') {\n            return this.stripeService.createCheckoutSession(tenantId, dto);\n        } else {\n            return this.wayForPayService.createCheckoutSession(tenantId, dto);\n        }\n    }\n\n    @Post('portal')\n    @ApiOperation({ summary: 'Create customer portal session' })\n    @ApiResponse({ status: 200, description: 'Portal session created' })\n    async createPortalSession(\n        @Body() body: { returnUrl: string },\n        @Req() req: Request,\n    ): Promise<{ url: string }> {\n        const tenantId = (req as any).user?.tenant_id;\n        return this.stripeService.createPortalSession(tenantId, body.returnUrl);\n    }\n\n    @Post('cancel')\n    @HttpCode(HttpStatus.NO_CONTENT)\n    @ApiOperation({ summary: 'Cancel subscription' })\n    @ApiResponse({ status: 204, description: 'Subscription canceled' })\n    async cancelSubscription(\n        @Body() dto: CancelSubscriptionDto,\n        @Req() req: Request,\n    ): Promise<void> {\n        const tenantId = (req as any).user?.tenant_id;\n        await this.billingService.cancelSubscription(\n            tenantId,\n            dto.atPeriodEnd ?? true\n        );\n    }\n\n    @Post('resume')\n    @HttpCode(HttpStatus.NO_CONTENT)\n    @ApiOperation({ summary: 'Resume subscription' })\n    @ApiResponse({ status: 204, description: 'Subscription resumed' })\n    async resumeSubscription(\n        @Body() dto: ResumeSubscriptionDto,\n        @Req() req: Request,\n    ): Promise<void> {\n        const tenantId = (req as any).user?.tenant_id;\n        await this.billingService.resumeSubscription(tenantId, dto.plan);\n    }\n\n    @Get('subscription')\n    @ApiOperation({ summary: 'Get subscription details' })\n    @ApiResponse({ status: 200, description: 'Subscription details' })\n    async getSubscription(@Req() req: Request): Promise<any> {\n        const tenantId = (req as any).user?.tenant_id;\n        return this.billingService.getSubscription(tenantId);\n    }\n\n    @Get('invoices')\n    @ApiOperation({ summary: 'Get invoices' })\n    @ApiResponse({ status: 200, description: 'Invoices retrieved' })\n    async getInvoices(@Req() req: Request): Promise<any[]> {\n        const tenantId = (req as any).user?.tenant_id;\n        return this.billingService.getInvoices(tenantId);\n    }\n\n    @Get('payment-methods')\n    @ApiOperation({ summary: 'Get payment methods' })\n    @ApiResponse({ status: 200, description: 'Payment methods retrieved' })\n    async getPaymentMethods(@Req() req: Request): Promise<any[]> {\n        const tenantId = (req as any).user?.tenant_id;\n        return this.billingService.getPaymentMethods(tenantId);\n    }\n}\n"],"names":["BillingController","createCheckoutSession","dto","req","tenantId","user","tenant_id","provider","stripeService","wayForPayService","createPortalSession","body","returnUrl","cancelSubscription","billingService","atPeriodEnd","resumeSubscription","plan","getSubscription","getInvoices","getPaymentMethods","summary","status","description","NO_CONTENT"],"mappings":";;;;+BAyBaA;;;eAAAA;;;wBAfN;yBAC2D;gCACnC;+BACD;kCACG;4BACsD;wBAC1D;;;;;;;;;;;;;;;AAStB,IAAA,AAAMA,oBAAN,MAAMA;IAOT,MAGMC,sBACF,AAAQC,GAA6B,EACrC,AAAOC,GAAY,EACgC;QACnD,MAAMC,WAAW,AAACD,IAAYE,IAAI,EAAEC;QAEpC,IAAIJ,IAAIK,QAAQ,KAAK,UAAU;YAC3B,OAAO,IAAI,CAACC,aAAa,CAACP,qBAAqB,CAACG,UAAUF;QAC9D,OAAO;YACH,OAAO,IAAI,CAACO,gBAAgB,CAACR,qBAAqB,CAACG,UAAUF;QACjE;IACJ;IAEA,MAGMQ,oBACF,AAAQC,IAA2B,EACnC,AAAOR,GAAY,EACK;QACxB,MAAMC,WAAW,AAACD,IAAYE,IAAI,EAAEC;QACpC,OAAO,IAAI,CAACE,aAAa,CAACE,mBAAmB,CAACN,UAAUO,KAAKC,SAAS;IAC1E;IAEA,MAIMC,mBACF,AAAQX,GAA0B,EAClC,AAAOC,GAAY,EACN;QACb,MAAMC,WAAW,AAACD,IAAYE,IAAI,EAAEC;QACpC,MAAM,IAAI,CAACQ,cAAc,CAACD,kBAAkB,CACxCT,UACAF,IAAIa,WAAW,IAAI;IAE3B;IAEA,MAIMC,mBACF,AAAQd,GAA0B,EAClC,AAAOC,GAAY,EACN;QACb,MAAMC,WAAW,AAACD,IAAYE,IAAI,EAAEC;QACpC,MAAM,IAAI,CAACQ,cAAc,CAACE,kBAAkB,CAACZ,UAAUF,IAAIe,IAAI;IACnE;IAEA,MAGMC,gBAAgB,AAAOf,GAAY,EAAgB;QACrD,MAAMC,WAAW,AAACD,IAAYE,IAAI,EAAEC;QACpC,OAAO,IAAI,CAACQ,cAAc,CAACI,eAAe,CAACd;IAC/C;IAEA,MAGMe,YAAY,AAAOhB,GAAY,EAAkB;QACnD,MAAMC,WAAW,AAACD,IAAYE,IAAI,EAAEC;QACpC,OAAO,IAAI,CAACQ,cAAc,CAACK,WAAW,CAACf;IAC3C;IAEA,MAGMgB,kBAAkB,AAAOjB,GAAY,EAAkB;QACzD,MAAMC,WAAW,AAACD,IAAYE,IAAI,EAAEC;QACpC,OAAO,IAAI,CAACQ,cAAc,CAACM,iBAAiB,CAAChB;IACjD;IAlFA,YACI,AAAiBU,cAA8B,EAC/C,AAAiBN,aAA4B,EAC7C,AAAiBC,gBAAkC,CACrD;aAHmBK,iBAAAA;aACAN,gBAAAA;aACAC,mBAAAA;IAClB;AA+EP;;;;QA5EoBY,SAAS;;;QACVC,QAAQ;QAAKC,aAAa;;;;;;;;;;;;;;QAezBF,SAAS;;;QACVC,QAAQ;QAAKC,aAAa;;;;;;;;;;;;;6CAUpBC;;QACLH,SAAS;;;QACVC,QAAQ;QAAKC,aAAa;;;;;;;;;;;;;6CAapBC;;QACLH,SAAS;;;QACVC,QAAQ;QAAKC,aAAa;;;;;;;;;;;;;;QAUzBF,SAAS;;;QACVC,QAAQ;QAAKC,aAAa;;;;;;;;;;;;QAOzBF,SAAS;;;QACVC,QAAQ;QAAKC,aAAa;;;;;;;;;;;;QAOzBF,SAAS;;;QACVC,QAAQ;QAAKC,aAAa"}
{"version":3,"sources":["../../../src/billing/services/billing.service.ts"],"sourcesContent":["import { Injectable } from '@nestjs/common';\nimport { InjectRepository } from '@nestjs/typeorm';\nimport { Repository } from 'typeorm';\nimport { Subscription } from '../../database/entities/Subscription.entity';\nimport { SubscriptionStatus, SubscriptionPlan } from '../../database/entities/enums/subscription.enum';\nimport { SubscriptionProvider } from '../../database/entities/enums/subscription.enum';\nimport { StripeService } from './stripe.service';\n\n/**\n * Billing Service (Orchestrator)\n */\n@Injectable()\nexport class BillingService {\n    constructor(\n        @InjectRepository(Subscription)\n        private readonly subscriptionRepository: Repository<Subscription>,\n        private readonly stripeService: StripeService,\n    ) {}\n\n    /**\n     * Get subscription by tenant\n     */\n    async getSubscription(tenantId: string): Promise<Subscription> {\n        return this.subscriptionRepository.findOne({\n            where: { tenantId },\n        });\n    }\n\n    /**\n     * Cancel subscription\n     */\n    async cancelSubscription(tenantId: string, atPeriodEnd: boolean): Promise<void> {\n        const subscription = await this.getSubscription(tenantId);\n\n        if (subscription.provider === 'stripe' && subscription.subscriptionExternalId) {\n            await this.stripeService.cancelSubscription(\n                subscription.subscriptionExternalId,\n                atPeriodEnd\n            );\n        }\n\n        // Update local status\n        if (!atPeriodEnd) {\n            await this.subscriptionRepository.update(\n                { id: subscription.id },\n                {\n                    status: SubscriptionStatus.CANCELED,\n                    canceledAt: new Date(),\n                }\n            );\n        } else {\n            await this.subscriptionRepository.update(\n                { id: subscription.id },\n                {\n                    cancelAtPeriodEnd: true,\n                }\n            );\n        }\n    }\n\n    /**\n     * Resume subscription\n     */\n    async resumeSubscription(tenantId: string, newPlan?: SubscriptionPlan): Promise<void> {\n        const subscription = await this.getSubscription(tenantId);\n\n        if (subscription.provider === 'stripe' && subscription.subscriptionExternalId) {\n            await this.stripeService.resumeSubscription(subscription.subscriptionExternalId);\n\n            if (newPlan) {\n                await this.stripeService.updateSubscriptionPlan(\n                    subscription.subscriptionExternalId,\n                    newPlan\n                );\n            }\n        }\n\n        // Update local status\n        await this.subscriptionRepository.update(\n            { id: subscription.id },\n            {\n                status: SubscriptionStatus.ACTIVE,\n                plan: newPlan || subscription.plan,\n                cancelAtPeriodEnd: false,\n                canceledAt: null,\n            }\n        );\n    }\n\n    /**\n     * Get invoices\n     */\n    async getInvoices(tenantId: string): Promise<any[]> {\n        const subscription = await this.getSubscription(tenantId);\n\n        if (subscription.provider === 'stripe' && subscription.externalId) {\n            // TODO: Get invoices from Stripe\n            return [];\n        }\n\n        return [];\n    }\n\n    /**\n     * Get payment methods\n     */\n    async getPaymentMethods(tenantId: string): Promise<any[]> {\n        const subscription = await this.getSubscription(tenantId);\n\n        if (subscription.provider === 'stripe' && subscription.externalId) {\n            // TODO: Get payment methods from Stripe\n            return [];\n        }\n\n        return [];\n    }\n\n    /**\n     * Update subscription from webhook\n     */\n    async updateSubscriptionFromWebhook(\n        externalId: string,\n        provider: SubscriptionProvider,\n        data: {\n            status?: SubscriptionStatus;\n            plan?: SubscriptionPlan;\n            currentPeriodEndAt?: Date;\n            trialEndAt?: Date;\n            cancelAtPeriodEnd?: boolean;\n            canceledAt?: Date;\n            amountCents?: number;\n            currency?: string;\n        },\n    ): Promise<void> {\n        await this.subscriptionRepository.update(\n            { subscriptionExternalId: externalId, provider },\n            {\n                ...data,\n                lastSyncedAt: new Date(),\n            }\n        );\n    }\n\n    /**\n     * Create subscription from webhook\n     */\n    async createSubscriptionFromWebhook(\n        tenantId: string,\n        externalId: string,\n        provider: SubscriptionProvider,\n        data: {\n            plan: SubscriptionPlan;\n            status: SubscriptionStatus;\n            trialStartAt?: Date;\n            trialEndAt?: Date;\n            currentPeriodStartAt?: Date;\n            currentPeriodEndAt?: Date;\n            amountCents?: number;\n            currency?: string;\n        },\n    ): Promise<void> {\n        await this.subscriptionRepository.save({\n            tenantId,\n            provider,\n            externalId,\n            subscriptionExternalId: externalId,\n            ...data,\n            lastSyncedAt: new Date(),\n        });\n    }\n}\n"],"names":["BillingService","getSubscription","tenantId","subscriptionRepository","findOne","where","cancelSubscription","atPeriodEnd","subscription","provider","subscriptionExternalId","stripeService","update","id","status","SubscriptionStatus","CANCELED","canceledAt","Date","cancelAtPeriodEnd","resumeSubscription","newPlan","updateSubscriptionPlan","ACTIVE","plan","getInvoices","externalId","getPaymentMethods","updateSubscriptionFromWebhook","data","lastSyncedAt","createSubscriptionFromWebhook","save"],"mappings":"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"}
{"version":3,"sources":["../../../src/common/utils/crypto.util.ts"],"sourcesContent":["import * as crypto from 'crypto';\nimport { scrypt, randomBytes, createCipheriv, createDecipheriv } from 'crypto';\n\n/**\n * Generate a random salt\n */\nexport async function generateSalt(length: number = 32): Promise<string> {\n    return randomBytes(length).toString('hex');\n}\n\n/**\n * Hash password using scrypt\n */\nexport async function hashPassword(\n    password: string,\n    salt: string,\n    keylen: number = 64\n): Promise<string> {\n    return new Promise((resolve, reject) => {\n        scrypt(password, salt, keylen, (err, derivedKey) => {\n            if (err) reject(err);\n            else resolve(derivedKey.toString('hex'));\n        });\n    });\n}\n\n/**\n * Verify password\n */\nexport async function verifyPassword(\n    password: string,\n    salt: string,\n    hash: string\n): Promise<boolean> {\n    const computedHash = await hashPassword(password, salt);\n    const expectedHash = Buffer.from(hash, 'hex');\n    const computedHashBuffer = Buffer.from(computedHash, 'hex');\n\n    // Constant-time comparison to prevent timing attacks\n    return crypto.timingSafeEqual(expectedHash, computedHashBuffer);\n}\n\n/**\n * Generate a random token\n */\nexport function generateToken(length: number = 32): string {\n    return randomBytes(length).toString('hex');\n}\n\n/**\n * Generate a secure UUID v4\n */\nexport function generateUuid(): string {\n    return crypto.randomUUID();\n}\n\n/**\n * Generate JWT secret\n */\nexport function generateJwtSecret(): string {\n    return randomBytes(64).toString('hex');\n}\n\n/**\n * Encrypt sensitive data (field-level encryption)\n */\nexport function encrypt(text: string, key: string): { iv: string; data: string } {\n    const iv = randomBytes(16);\n    const cipher = createCipheriv(\n        'aes-256-gcm',\n        Buffer.from(key, 'hex'),\n        iv\n    );\n\n    let encrypted = cipher.update(text, 'utf8', 'hex');\n    encrypted += cipher.final('hex');\n\n    const authTag = cipher.getAuthTag();\n\n    return {\n        iv: iv.toString('hex'),\n        data: encrypted + ':' + authTag.toString('hex'),\n    };\n}\n\n/**\n * Decrypt sensitive data\n */\nexport function decrypt(encryptedData: string, key: string): string {\n    const [encrypted, authTag] = encryptedData.split(':');\n    const iv = Buffer.from(encryptedData.substring(0, 32), 'hex');\n    const decipher = createDecipheriv(\n        'aes-256-gcm',\n        Buffer.from(key, 'hex'),\n        iv\n    );\n\n    decipher.setAuthTag(Buffer.from(authTag, 'hex'));\n\n    let decrypted = decipher.update(encrypted, 'hex', 'utf8');\n    decrypted += decipher.final('utf8');\n\n    return decrypted;\n}\n\n/**\n * Generate a hash for data integrity\n */\nexport function generateHash(data: string, algorithm: string = 'sha256'): string {\n    return crypto.createHash(algorithm).update(data).digest('hex');\n}\n\n/**\n * Verify data integrity\n */\nexport function verifyHash(data: string, hash: string): boolean {\n    const computedHash = generateHash(data);\n    const expectedHash = Buffer.from(hash, 'hex');\n    const computedHashBuffer = Buffer.from(computedHash, 'hex');\n\n    return crypto.timingSafeEqual(expectedHash, computedHashBuffer);\n}\n\n/**\n * Generate TOTP secret for MFA\n */\nexport function generateTotpSecret(): string {\n    const buffer = randomBytes(20);\n    const base32Chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';\n    let secret = '';\n\n    for (let i = 0; i < buffer.length; i += 5) {\n        const chunk = buffer.slice(i, i + 5);\n        secret += base32Chars[(chunk[0] & 0xF8) >> 3];\n        secret += base32Chars[((chunk[0] & 0x07) << 2) | ((chunk[1] & 0xC0) >> 6)];\n        secret += base32Chars[(chunk[1] & 0x3E) >> 1];\n        secret += base32Chars[((chunk[1] & 0x01) << 4) | ((chunk[2] & 0xF0) >> 4)];\n        secret += base32Chars[((chunk[2] & 0x0F) << 1) | ((chunk[3] & 0x80) >> 7)];\n        secret += base32Chars[(chunk[3] & 0x7C) >> 2];\n        secret += base32Chars[((chunk[3] & 0x03) << 3) | ((chunk[4] & 0xE0) >> 5)];\n        secret += base32Chars[chunk[4] & 0x1F];\n    }\n\n    return secret;\n}\n\n/**\n * Generate backup codes for MFA\n */\nexport function generateMfaBackupCodes(count: number = 10): string[] {\n    const codes: string[] = [];\n    for (let i = 0; i < count; i++) {\n        const code = randomBytes(4).toString('hex').toUpperCase();\n        codes.push(`${code.substring(0, 4)}-${code.substring(4, 8)}`);\n    }\n    return codes;\n}\n\n/**\n * Generate HMAC signature for webhooks\n */\nexport function generateHmacSignature(\n    payload: string,\n    secret: string,\n    algorithm: string = 'sha256'\n): string {\n    return crypto\n        .createHmac(algorithm, secret)\n        .update(payload)\n        .digest('hex');\n}\n\n/**\n * Verify HMAC signature\n */\nexport function verifyHmacSignature(\n    payload: string,\n    signature: string,\n    secret: string,\n    algorithm: string = 'sha256'\n): boolean {\n    const expectedSignature = generateHmacSignature(payload, secret, algorithm);\n    return crypto.timingSafeEqual(\n        Buffer.from(signature),\n        Buffer.from(expectedSignature)\n    );\n}\n\n/**\n * Generate a random ID for short-lived tokens\n */\nexport function generateShortId(length: number = 16): string {\n    return randomBytes(Math.ceil(length / 2))\n        .toString('hex')\n        .substring(0, length);\n}\n\n/**\n * Generate a device fingerprint\n */\nexport function generateDeviceFingerprint(userAgent: string, ip: string): string {\n    const data = `${userAgent}-${ip}-${Date.now()}`;\n    return generateHash(data);\n}\n"],"names":["decrypt","encrypt","generateDeviceFingerprint","generateHash","generateHmacSignature","generateJwtSecret","generateMfaBackupCodes","generateSalt","generateShortId","generateToken","generateTotpSecret","generateUuid","hashPassword","verifyHash","verifyHmacSignature","verifyPassword","length","randomBytes","toString","password","salt","keylen","Promise","resolve","reject","scrypt","err","derivedKey","hash","computedHash","expectedHash","Buffer","from","computedHashBuffer","crypto","timingSafeEqual","randomUUID","text","key","iv","cipher","createCipheriv","encrypted","update","final","authTag","getAuthTag","data","encryptedData","split","substring","decipher","createDecipheriv","setAuthTag","decrypted","algorithm","createHash","digest","buffer","base32Chars","secret","i","chunk","slice","count","codes","code","toUpperCase","push","payload","createHmac","signature","expectedSignature","Math","ceil","userAgent","ip","Date","now"],"mappings":"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"}
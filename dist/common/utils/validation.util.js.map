{"version":3,"sources":["../../../src/common/utils/validation.util.ts"],"sourcesContent":["import { validate, Validator } from 'class-validator';\nimport { plainToClass, ClassConstructor } from 'class-transformer';\n\nconst validator = new Validator();\n\n/**\n * Generic validation function\n */\nexport async function validateDto<T extends object>(\n    dtoClass: ClassConstructor<T>,\n    data: any\n): Promise<{ errors: any[]; valid: boolean }> {\n    const dto = plainToClass(dtoClass, data);\n    const errors = await validate(dto, {\n        whitelist: true,\n        forbidNonWhitelisted: true,\n        forbidUnknownValues: true,\n    });\n\n    const formattedErrors = errors.map(error => ({\n        field: error.property,\n        constraints: error.constraints,\n        value: error.value,\n    }));\n\n    return {\n        errors: formattedErrors,\n        valid: errors.length === 0,\n    };\n}\n\n/**\n * Password strength validation\n */\nexport function validatePasswordStrength(password: string): {\n    valid: boolean;\n    score: number;\n    errors: string[];\n} {\n    const errors: string[] = [];\n    let score = 0;\n\n    if (password.length < 8) {\n        errors.push('Пароль повинен містити мінімум 8 символів');\n    } else {\n        score += 20;\n    }\n\n    if (!/[a-z]/.test(password)) {\n        errors.push('Пароль повинен містити маленькі літери');\n    } else {\n        score += 20;\n    }\n\n    if (!/[A-Z]/.test(password)) {\n        errors.push('Пароль повинен містити великі літери');\n    } else {\n        score += 20;\n    }\n\n    if (!/[0-9]/.test(password)) {\n        errors.push('Пароль повинен містити цифри');\n    } else {\n        score += 20;\n    }\n\n    if (!/[^a-zA-Z0-9]/.test(password)) {\n        errors.push('Пароль повинен містити спеціальні символи');\n    } else {\n        score += 20;\n    }\n\n    return {\n        valid: errors.length === 0 && score >= 80,\n        score,\n        errors,\n    };\n}\n\n/**\n * Email validation (strict)\n */\nexport function validateEmail(email: string): boolean {\n    const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$/;\n    return emailRegex.test(email);\n}\n\n/**\n * Phone validation (Ukrainian format)\n */\nexport function validatePhone(phone: string): boolean {\n    const phoneRegex = /^\\+380\\d{9}$/;\n    return phoneRegex.test(phone);\n}\n\n/**\n * EDRPOU validation (Ukrainian company code)\n */\nexport function validateEdrpou(edrpou: string): boolean {\n    return /^\\d{8}$/.test(edrpou);\n}\n\n/**\n * Tax number validation (Ukrainian INN)\n */\nexport function validateTaxNumber(taxNumber: string): boolean {\n    return /^\\d{10,12}$/.test(taxNumber);\n}\n\n/**\n * Sanitize user input\n */\nexport function sanitizeInput(input: string): string {\n    return input\n        .replace(/[<>]/g, '') // Remove < and >\n        .trim()\n        .substring(0, 1000); // Limit length\n}\n\n/**\n * Validate UUID\n */\nexport function validateUuid(uuid: string): boolean {\n    const uuidRegex =\n        /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;\n    return uuidRegex.test(uuid);\n}\n\n/**\n * Check for SQL injection patterns\n */\nexport function detectSqlInjection(input: string): boolean {\n    const sqlPatterns = [\n        /(\\b(SELECT|INSERT|UPDATE|DELETE|DROP|ALTER|CREATE|TRUNCATE|UNION|EXEC)\\b)/i,\n        /(--|\\/\\*|\\*\\/|;)/,\n        /(\\bOR\\b|\\bAND\\b)\\s+\\d+\\s*=\\s*\\d+/i,\n        /(\\bOR\\b|\\bAND\\b)\\s+['\"][^'\"]*['\"]\\s*=\\s*['\"][^'\"]*['\"]/i,\n    ];\n\n    return sqlPatterns.some(pattern => pattern.test(input));\n}\n\n/**\n * Validate file upload\n */\nexport function validateFileUpload(\n    file: Express.Multer.File,\n    allowedMimeTypes: string[],\n    maxSizeInBytes: number\n): { valid: boolean; error?: string } {\n    if (!file) {\n        return { valid: false, error: 'Файл не завантажено' };\n    }\n\n    if (!allowedMimeTypes.includes(file.mimetype)) {\n        return { valid: false, error: 'Невірний формат файлу' };\n    }\n\n    if (file.size > maxSizeInBytes) {\n        return {\n            valid: false,\n            error: `Розмір файлу перевищує ${maxSizeInBytes / 1024 / 1024} MB`,\n        };\n    }\n\n    // Check for malicious file extensions\n    const dangerousExtensions = ['.exe', '.bat', '.sh', '.php', '.js', '.vbs'];\n    const fileExtension = file.originalname.toLowerCase();\n    if (dangerousExtensions.some(ext => fileExtension.endsWith(ext))) {\n        return { valid: false, error: 'Заборонений тип файлу' };\n    }\n\n    return { valid: true };\n}\n\n/**\n * Rate limit key generator\n */\nexport function generateRateLimitKey(\n    identifier: string,\n    action: string,\n    tenantId?: string\n): string {\n    const parts = ['ratelimit', identifier, action];\n    if (tenantId) {\n        parts.push(tenantId);\n    }\n    return parts.join(':');\n}\n"],"names":["detectSqlInjection","generateRateLimitKey","sanitizeInput","validateDto","validateEdrpou","validateEmail","validateFileUpload","validatePasswordStrength","validatePhone","validateTaxNumber","validateUuid","validator","Validator","dtoClass","data","dto","plainToClass","errors","validate","whitelist","forbidNonWhitelisted","forbidUnknownValues","formattedErrors","map","error","field","property","constraints","value","valid","length","password","score","push","test","email","emailRegex","phone","phoneRegex","edrpou","taxNumber","input","replace","trim","substring","uuid","uuidRegex","sqlPatterns","some","pattern","file","allowedMimeTypes","maxSizeInBytes","includes","mimetype","size","dangerousExtensions","fileExtension","originalname","toLowerCase","ext","endsWith","identifier","action","tenantId","parts","join"],"mappings":";;;;;;;;;;;QAmIgBA;eAAAA;;QA+CAC;eAAAA;;QAlEAC;eAAAA;;QAxGMC;eAAAA;;QA0FNC;eAAAA;;QAhBAC;eAAAA;;QA+DAC;eAAAA;;QA/GAC;eAAAA;;QAwDAC;eAAAA;;QAeAC;eAAAA;;QAiBAC;eAAAA;;;gCA1HoB;kCACW;AAE/C,MAAMC,YAAY,IAAIC,yBAAS;AAKxB,eAAeT,YAClBU,QAA6B,EAC7BC,IAAS;IAET,MAAMC,MAAMC,IAAAA,8BAAY,EAACH,UAAUC;IACnC,MAAMG,SAAS,MAAMC,IAAAA,wBAAQ,EAACH,KAAK;QAC/BI,WAAW;QACXC,sBAAsB;QACtBC,qBAAqB;IACzB;IAEA,MAAMC,kBAAkBL,OAAOM,GAAG,CAACC,CAAAA,QAAU,CAAA;YACzCC,OAAOD,MAAME,QAAQ;YACrBC,aAAaH,MAAMG,WAAW;YAC9BC,OAAOJ,MAAMI,KAAK;QACtB,CAAA;IAEA,OAAO;QACHX,QAAQK;QACRO,OAAOZ,OAAOa,MAAM,KAAK;IAC7B;AACJ;AAKO,SAASvB,yBAAyBwB,QAAgB;IAKrD,MAAMd,SAAmB,EAAE;IAC3B,IAAIe,QAAQ;IAEZ,IAAID,SAASD,MAAM,GAAG,GAAG;QACrBb,OAAOgB,IAAI,CAAC;IAChB,OAAO;QACHD,SAAS;IACb;IAEA,IAAI,CAAC,QAAQE,IAAI,CAACH,WAAW;QACzBd,OAAOgB,IAAI,CAAC;IAChB,OAAO;QACHD,SAAS;IACb;IAEA,IAAI,CAAC,QAAQE,IAAI,CAACH,WAAW;QACzBd,OAAOgB,IAAI,CAAC;IAChB,OAAO;QACHD,SAAS;IACb;IAEA,IAAI,CAAC,QAAQE,IAAI,CAACH,WAAW;QACzBd,OAAOgB,IAAI,CAAC;IAChB,OAAO;QACHD,SAAS;IACb;IAEA,IAAI,CAAC,eAAeE,IAAI,CAACH,WAAW;QAChCd,OAAOgB,IAAI,CAAC;IAChB,OAAO;QACHD,SAAS;IACb;IAEA,OAAO;QACHH,OAAOZ,OAAOa,MAAM,KAAK,KAAKE,SAAS;QACvCA;QACAf;IACJ;AACJ;AAKO,SAASZ,cAAc8B,KAAa;IACvC,MAAMC,aAAa;IACnB,OAAOA,WAAWF,IAAI,CAACC;AAC3B;AAKO,SAAS3B,cAAc6B,KAAa;IACvC,MAAMC,aAAa;IACnB,OAAOA,WAAWJ,IAAI,CAACG;AAC3B;AAKO,SAASjC,eAAemC,MAAc;IACzC,OAAO,UAAUL,IAAI,CAACK;AAC1B;AAKO,SAAS9B,kBAAkB+B,SAAiB;IAC/C,OAAO,cAAcN,IAAI,CAACM;AAC9B;AAKO,SAAStC,cAAcuC,KAAa;IACvC,OAAOA,MACFC,OAAO,CAAC,SAAS,IAAI,iBAAiB;KACtCC,IAAI,GACJC,SAAS,CAAC,GAAG,OAAO,eAAe;AAC5C;AAKO,SAASlC,aAAamC,IAAY;IACrC,MAAMC,YACF;IACJ,OAAOA,UAAUZ,IAAI,CAACW;AAC1B;AAKO,SAAS7C,mBAAmByC,KAAa;IAC5C,MAAMM,cAAc;QAChB;QACA;QACA;QACA;KACH;IAED,OAAOA,YAAYC,IAAI,CAACC,CAAAA,UAAWA,QAAQf,IAAI,CAACO;AACpD;AAKO,SAASnC,mBACZ4C,IAAyB,EACzBC,gBAA0B,EAC1BC,cAAsB;IAEtB,IAAI,CAACF,MAAM;QACP,OAAO;YAAErB,OAAO;YAAOL,OAAO;QAAsB;IACxD;IAEA,IAAI,CAAC2B,iBAAiBE,QAAQ,CAACH,KAAKI,QAAQ,GAAG;QAC3C,OAAO;YAAEzB,OAAO;YAAOL,OAAO;QAAwB;IAC1D;IAEA,IAAI0B,KAAKK,IAAI,GAAGH,gBAAgB;QAC5B,OAAO;YACHvB,OAAO;YACPL,OAAO,CAAC,uBAAuB,EAAE4B,iBAAiB,OAAO,KAAK,GAAG,CAAC;QACtE;IACJ;IAEA,sCAAsC;IACtC,MAAMI,sBAAsB;QAAC;QAAQ;QAAQ;QAAO;QAAQ;QAAO;KAAO;IAC1E,MAAMC,gBAAgBP,KAAKQ,YAAY,CAACC,WAAW;IACnD,IAAIH,oBAAoBR,IAAI,CAACY,CAAAA,MAAOH,cAAcI,QAAQ,CAACD,OAAO;QAC9D,OAAO;YAAE/B,OAAO;YAAOL,OAAO;QAAwB;IAC1D;IAEA,OAAO;QAAEK,OAAO;IAAK;AACzB;AAKO,SAAS5B,qBACZ6D,UAAkB,EAClBC,MAAc,EACdC,QAAiB;IAEjB,MAAMC,QAAQ;QAAC;QAAaH;QAAYC;KAAO;IAC/C,IAAIC,UAAU;QACVC,MAAMhC,IAAI,CAAC+B;IACf;IACA,OAAOC,MAAMC,IAAI,CAAC;AACtB"}
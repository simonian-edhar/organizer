{"version":3,"sources":["../../../src/common/logging/logging.interceptor.ts"],"sourcesContent":["import {\n  Injectable,\n  NestInterceptor,\n  ExecutionContext,\n  CallHandler,\n  Logger,\n} from '@nestjs/common';\nimport { Observable, throwError } from 'rxjs';\nimport { catchError, tap } from 'rxjs/operators';\nimport { LoggingService, LogContext } from './logging.service';\n\n/**\n * Logging interceptor options\n */\nexport interface LoggingInterceptorOptions {\n  logExecutionTime?: boolean;\n  logArgs?: boolean;\n  logResult?: boolean;\n  logErrors?: boolean;\n  executionTimeThreshold?: number; // milliseconds\n  excludeMethods?: string[];\n  excludePaths?: string[];\n}\n\n/**\n * Method-level logging interceptor\n * Logs method calls, execution time, and errors\n */\n@Injectable()\nexport class LoggingInterceptor implements NestInterceptor {\n  private readonly logger = new Logger(LoggingInterceptor.name);\n\n  constructor(\n    private readonly loggingService: LoggingService,\n    private readonly options: LoggingInterceptorOptions = {},\n  ) {\n    this.options = {\n      logExecutionTime: true,\n      logArgs: false,\n      logResult: false,\n      logErrors: true,\n      executionTimeThreshold: 1000, // Log slow methods (> 1s)\n      excludeMethods: ['GET', 'OPTIONS'],\n      excludePaths: ['/health', '/healthz', '/readiness'],\n      ...options,\n    };\n  }\n\n  /**\n   * Interceptor method\n   */\n  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {\n    const request = context.switchToHttp().getRequest();\n    const response = context.switchToHttp().getResponse();\n\n    // Skip logging for excluded paths or methods\n    if (this.shouldExclude(request)) {\n      return next.handle();\n    }\n\n    const startTime = Date.now();\n    const controller = context.getClass().name;\n    const method = context.getHandler().name;\n\n    // Extract context for logging\n    const logContext = this.extractLogContext(request, controller, method);\n\n    // Log method entry\n    this.logMethodEntry(logContext, request);\n\n    return next.handle().pipe(\n      tap((data) => {\n        // Log method exit\n        this.logMethodExit(logContext, startTime, data);\n      }),\n      catchError((error) => {\n        // Log method error\n        this.logMethodError(logContext, error);\n        return throwError(() => error);\n      }),\n    );\n  }\n\n  /**\n   * Check if request should be excluded from logging\n   */\n  private shouldExclude(request: any): boolean {\n    const method = request.method;\n    const path = request.path;\n\n    if (this.options.excludeMethods?.includes(method)) {\n      return true;\n    }\n\n    if (this.options.excludePaths?.some(excludedPath => path.startsWith(excludedPath))) {\n      return true;\n    }\n\n    return false;\n  }\n\n  /**\n   * Extract log context from request and execution context\n   */\n  private extractLogContext(request: any, controller: string, method: string): LogContext {\n    return {\n      requestId: request.requestId,\n      tenantId: request.tenantId,\n      userId: request.userId,\n      userRole: request.userRole,\n      ip: this.getClientIp(request),\n      userAgent: request.headers?.['user-agent'],\n      controller,\n      method,\n      httpMethod: request.method,\n      path: request.path,\n    };\n  }\n\n  /**\n   * Get client IP address\n   */\n  private getClientIp(request: any): string {\n    return (\n      request.headers?.['x-forwarded-for']?.split(',')[0]?.trim() ||\n      request.headers?.['x-real-ip'] ||\n      request.socket?.remoteAddress ||\n      'unknown'\n    );\n  }\n\n  /**\n   * Log method entry\n   */\n  private logMethodEntry(context: LogContext, request: any): void {\n    const message = `${context.controller}.${context.method} called`;\n\n    const logData: LogContext = {\n      ...context,\n      eventType: 'method_call',\n      phase: 'entry',\n    };\n\n    // Add request arguments if enabled\n    if (this.options.logArgs && request.body && Object.keys(request.body).length > 0) {\n      logData.requestBody = this.sanitizeBody(request.body);\n    }\n\n    if (request.query && Object.keys(request.query).length > 0) {\n      logData.query = this.sanitizeQuery(request.query);\n    }\n\n    this.loggingService.debug(message, logData);\n  }\n\n  /**\n   * Log method exit\n   */\n  private logMethodExit(context: LogContext, startTime: number, data?: any): void {\n    const executionTime = Date.now() - startTime;\n    const message = `${context.controller}.${context.method} completed in ${executionTime}ms`;\n\n    const logData: LogContext = {\n      ...context,\n      eventType: 'method_call',\n      phase: 'exit',\n      executionTimeMs: executionTime,\n    };\n\n    // Add response data if enabled\n    if (this.options.logResult && data) {\n      logData.response = this.sanitizeResponse(data);\n    }\n\n    // Determine log level based on execution time\n    if (this.options.logExecutionTime && executionTime > (this.options.executionTimeThreshold || 1000)) {\n      // Log slow methods as warnings\n      this.loggingService.warn(message, logData);\n    } else {\n      this.loggingService.debug(message, logData);\n    }\n  }\n\n  /**\n   * Log method error\n   */\n  private logMethodError(context: LogContext, error: any): void {\n    const message = `${context.controller}.${context.method} failed`;\n\n    const logData: LogContext = {\n      ...context,\n      eventType: 'method_call',\n      phase: 'error',\n      error: error.message,\n      errorName: error.name,\n    };\n\n    if (error.stack) {\n      logData.stack = error.stack;\n    }\n\n    if (this.options.logErrors) {\n      this.loggingService.error(\n        message,\n        error.stack,\n        logData,\n      );\n    }\n  }\n\n  /**\n   * Sanitize request body by removing sensitive fields\n   */\n  private sanitizeBody(body: any): any {\n    if (!body || typeof body !== 'object') {\n      return body;\n    }\n\n    const sanitized: any = {};\n    const sensitiveFields = ['password', 'token', 'secret', 'apiKey', 'creditCard', 'ssn'];\n\n    for (const [key, value] of Object.entries(body)) {\n      const isSensitive = sensitiveFields.some(field =>\n        key.toLowerCase().includes(field.toLowerCase())\n      );\n\n      if (isSensitive) {\n        sanitized[key] = '[REDACTED]';\n      } else if (typeof value === 'object' && value !== null) {\n        sanitized[key] = this.sanitizeBody(value);\n      } else {\n        sanitized[key] = value;\n      }\n    }\n\n    return sanitized;\n  }\n\n  /**\n   * Sanitize query parameters\n   */\n  private sanitizeQuery(query: any): any {\n    if (!query || typeof query !== 'object') {\n      return query;\n    }\n\n    const sanitized: any = {};\n    const sensitiveParams = ['password', 'token', 'secret', 'api_key', 'authorization'];\n\n    for (const [key, value] of Object.entries(query)) {\n      if (sensitiveParams.some(param => key.toLowerCase().includes(param))) {\n        sanitized[key] = '[REDACTED]';\n      } else {\n        sanitized[key] = value;\n      }\n    }\n\n    return sanitized;\n  }\n\n  /**\n   * Sanitize response data by removing sensitive fields\n   */\n  private sanitizeResponse(data: any): any {\n    if (!data || typeof data !== 'object') {\n      return data;\n    }\n\n    const sanitized: any = {};\n    const sensitiveFields = ['password', 'token', 'secret', 'accessToken', 'refreshToken'];\n\n    for (const [key, value] of Object.entries(data)) {\n      const isSensitive = sensitiveFields.some(field =>\n        key.toLowerCase().includes(field.toLowerCase())\n      );\n\n      if (isSensitive) {\n        sanitized[key] = '[REDACTED]';\n      } else if (typeof value === 'object' && value !== null) {\n        sanitized[key] = this.sanitizeResponse(value);\n      } else {\n        sanitized[key] = value;\n      }\n    }\n\n    return sanitized;\n  }\n}\n"],"names":["LoggingInterceptor","intercept","context","next","request","switchToHttp","getRequest","response","getResponse","shouldExclude","handle","startTime","Date","now","controller","getClass","name","method","getHandler","logContext","extractLogContext","logMethodEntry","pipe","tap","data","logMethodExit","catchError","error","logMethodError","throwError","path","options","excludeMethods","includes","excludePaths","some","excludedPath","startsWith","requestId","tenantId","userId","userRole","ip","getClientIp","userAgent","headers","httpMethod","split","trim","socket","remoteAddress","message","logData","eventType","phase","logArgs","body","Object","keys","length","requestBody","sanitizeBody","query","sanitizeQuery","loggingService","debug","executionTime","executionTimeMs","logResult","sanitizeResponse","logExecutionTime","executionTimeThreshold","warn","errorName","stack","logErrors","sanitized","sensitiveFields","key","value","entries","isSensitive","field","toLowerCase","sensitiveParams","param","logger","Logger"],"mappings":"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"}
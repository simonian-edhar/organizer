{"version":3,"sources":["../../../src/common/logging/logging.service.ts"],"sourcesContent":["import { Injectable, LoggerService as NestLoggerService, Scope } from '@nestjs/common';\nimport { WINSTON_MODULE_PROVIDER } from 'nest-winston';\nimport { Inject } from '@nestjs/common';\nimport * as winston from 'winston';\nimport { v4 as uuidv4 } from 'uuid';\n\n/**\n * Logging context interface for consistent log metadata\n */\nexport interface LogContext {\n  tenantId?: string;\n  userId?: string;\n  requestId?: string;\n  action?: string;\n  entity?: string;\n  entityId?: string;\n  ip?: string;\n  userAgent?: string;\n  [key: string]: any;\n}\n\n/**\n * Structured logging service with context support\n * Extends NestJS LoggerService with enhanced capabilities\n */\n@Injectable({ scope: Scope.TRANSIENT })\nexport class LoggingService implements NestLoggerService {\n  private context: string;\n\n  constructor(\n    @Inject(WINSTON_MODULE_PROVIDER) private readonly logger: winston.Logger,\n  ) {}\n\n  /**\n   * Set the logging context (typically the service/class name)\n   */\n  setContext(context: string): void {\n    this.context = context;\n  }\n\n  /**\n   * Generate or retrieve request ID from context\n   */\n  private getRequestId(contextData?: LogContext): string {\n    if (contextData?.requestId) {\n      return contextData.requestId;\n    }\n    return uuidv4();\n  }\n\n  /**\n   * Create log metadata with context\n   */\n  private createLogMeta(contextData?: LogContext, additionalMeta?: Record<string, any>): LogContext {\n    const requestId = this.getRequestId(contextData);\n\n    return {\n      requestId,\n      context: this.context,\n      ...contextData,\n      ...additionalMeta,\n    };\n  }\n\n  /**\n   * Log a message at debug level\n   */\n  debug(message: any, contextData?: LogContext): void {\n    const meta = this.createLogMeta(contextData);\n    this.logger.debug(message, meta);\n  }\n\n  /**\n   * Log a message at error level\n   */\n  error(message: any, trace?: string, contextData?: LogContext): void {\n    const meta = this.createLogMeta(contextData);\n    this.logger.error(message, { ...meta, trace });\n  }\n\n  /**\n   * Log a message at info level\n   */\n  log(message: any, contextData?: LogContext): void {\n    const meta = this.createLogMeta(contextData);\n    this.logger.info(message, meta);\n  }\n\n  /**\n   * Log a message at verbose level\n   */\n  verbose(message: any, contextData?: LogContext): void {\n    const meta = this.createLogMeta(contextData);\n    this.logger.verbose(message, meta);\n  }\n\n  /**\n   * Log a message at warn level\n   */\n  warn(message: any, contextData?: LogContext): void {\n    const meta = this.createLogMeta(contextData);\n    this.logger.warn(message, meta);\n  }\n\n  /**\n   * Log HTTP request/response with timing\n   */\n  logHttpRequest(\n    method: string,\n    url: string,\n    statusCode: number,\n    responseTime: number,\n    contextData?: LogContext,\n  ): void {\n    const meta = this.createLogMeta({\n      ...contextData,\n      method,\n      url,\n      statusCode,\n      responseTimeMs: responseTime,\n    });\n\n    const level = statusCode >= 500 ? 'error' : statusCode >= 400 ? 'warn' : 'info';\n    this.logger.log(level, `HTTP ${method} ${url} ${statusCode} - ${responseTime}ms`, meta);\n  }\n\n  /**\n   * Log database query performance\n   */\n  logDatabaseQuery(\n    query: string,\n    duration: number,\n    contextData?: LogContext,\n  ): void {\n    const meta = this.createLogMeta({\n      ...contextData,\n      queryType: 'database',\n      queryLength: query.length,\n      durationMs: duration,\n    });\n\n    const level = duration > 1000 ? 'warn' : 'debug';\n    this.logger.log(level, `Database query executed in ${duration}ms`, meta);\n  }\n\n  /**\n   * Log business event with action and entity information\n   */\n  logBusinessEvent(\n    action: string,\n    entity: string,\n    entityId?: string,\n    contextData?: LogContext,\n  ): void {\n    const meta = this.createLogMeta({\n      ...contextData,\n      action,\n      entity,\n      entityId,\n      eventType: 'business',\n    });\n\n    this.logger.info(`Business event: ${action} ${entity}${entityId ? `:${entityId}` : ''}`, meta);\n  }\n\n  /**\n   * Log authentication event\n   */\n  logAuthEvent(\n    event: 'login' | 'logout' | 'login_failed' | 'token_refresh' | 'mfa_verified' | 'mfa_required' | 'logout_all_devices' | 'password_reset_requested',\n    contextData?: LogContext,\n  ): void {\n    const meta = this.createLogMeta({\n      ...contextData,\n      eventType: 'auth',\n      authEvent: event,\n    });\n\n    const level = event === 'login_failed' ? 'warn' : 'info';\n    this.logger.log(level, `Authentication event: ${event}`, meta);\n  }\n\n  /**\n   * Log security event\n   */\n  logSecurityEvent(\n    event: string,\n    severity: 'low' | 'medium' | 'high' | 'critical',\n    contextData?: LogContext,\n  ): void {\n    const meta = this.createLogMeta({\n      ...contextData,\n      eventType: 'security',\n      securityEvent: event,\n      severity,\n    });\n\n    const level = severity === 'critical' || severity === 'high' ? 'error' : 'warn';\n    this.logger.log(level, `Security event: ${event} (severity: ${severity})`, meta);\n  }\n\n  /**\n   * Log performance metrics\n   */\n  logPerformance(\n    operation: string,\n    duration: number,\n    threshold: number,\n    contextData?: LogContext,\n  ): void {\n    const meta = this.createLogMeta({\n      ...contextData,\n      eventType: 'performance',\n      operation,\n      durationMs: duration,\n      thresholdMs: threshold,\n      exceededThreshold: duration > threshold,\n    });\n\n    const level = duration > threshold ? 'warn' : 'debug';\n    this.logger.log(level, `Performance: ${operation} completed in ${duration}ms`, meta);\n  }\n\n  /**\n   * Log error with stack trace and context\n   */\n  logError(\n    error: Error | string,\n    contextData?: LogContext,\n  ): void {\n    const errorMessage = error instanceof Error ? error.message : error;\n    const errorStack = error instanceof Error ? error.stack : undefined;\n\n    const meta = this.createLogMeta({\n      ...contextData,\n      error: errorMessage,\n    });\n\n    this.logger.error(errorMessage, errorStack, meta);\n  }\n\n  /**\n   * Create a child logger with additional context\n   */\n  child(contextData: LogContext): LoggingService {\n    const childService = new LoggingService(this.logger);\n    childService.setContext(this.context);\n\n    // Store additional context for all log calls\n    const originalLog = childService.log.bind(childService);\n    const originalError = childService.error.bind(childService);\n    const originalWarn = childService.warn.bind(childService);\n    const originalDebug = childService.debug.bind(childService);\n\n    childService.log = (message: any, ctx?: LogContext) => {\n      originalLog(message, { ...contextData, ...ctx });\n    };\n\n    childService.error = (message: any, trace?: string, ctx?: LogContext) => {\n      originalError(message, trace, { ...contextData, ...ctx });\n    };\n\n    childService.warn = (message: any, ctx?: LogContext) => {\n      originalWarn(message, { ...contextData, ...ctx });\n    };\n\n    childService.debug = (message: any, ctx?: LogContext) => {\n      originalDebug(message, { ...contextData, ...ctx });\n    };\n\n    return childService;\n  }\n\n  /**\n   * Get the underlying Winston logger\n   */\n  getWinstonLogger(): winston.Logger {\n    return this.logger;\n  }\n}\n"],"names":["LoggingService","setContext","context","getRequestId","contextData","requestId","uuidv4","createLogMeta","additionalMeta","debug","message","meta","logger","error","trace","log","info","verbose","warn","logHttpRequest","method","url","statusCode","responseTime","responseTimeMs","level","logDatabaseQuery","query","duration","queryType","queryLength","length","durationMs","logBusinessEvent","action","entity","entityId","eventType","logAuthEvent","event","authEvent","logSecurityEvent","severity","securityEvent","logPerformance","operation","threshold","thresholdMs","exceededThreshold","logError","errorMessage","Error","errorStack","stack","undefined","child","childService","originalLog","bind","originalError","originalWarn","originalDebug","ctx","getWinstonLogger","scope","Scope","TRANSIENT"],"mappings":"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"}
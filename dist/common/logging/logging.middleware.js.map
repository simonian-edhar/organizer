{"version":3,"sources":["../../../src/common/logging/logging.middleware.ts"],"sourcesContent":["import {\n  Injectable,\n  NestMiddleware,\n  LoggerService as NestLoggerService,\n  RequestMethod,\n} from '@nestjs/common';\nimport { Request, Response, NextFunction } from 'express';\nimport { v4 as uuidv4 } from 'uuid';\nimport { LoggingService } from './logging.service';\n\n/**\n * Extend Express Request to include logging metadata\n */\ndeclare global {\n  namespace Express {\n    interface Request {\n      requestId: string;\n      startTime: number;\n      tenantId?: string;\n      userId?: string;\n      userRole?: string;\n    }\n  }\n}\n\n/**\n * HTTP methods that should be logged\n */\nconst LOGGABLE_METHODS = [\n  RequestMethod.POST,\n  RequestMethod.PUT,\n  RequestMethod.PATCH,\n  RequestMethod.DELETE,\n];\n\n/**\n * Paths that should be excluded from logging\n */\nconst EXCLUDE_PATHS = [\n  '/health',\n  '/healthz',\n  '/readiness',\n  '/metrics',\n  '/favicon.ico',\n];\n\n/**\n * Headers that should be excluded from logs for security\n */\nconst EXCLUDE_HEADERS = [\n  'authorization',\n  'cookie',\n  'set-cookie',\n  'x-api-key',\n  'x-auth-token',\n];\n\n/**\n * Request/Response logging middleware\n * Logs HTTP requests with correlation IDs, timing, and context\n */\n@Injectable()\nexport class LoggingMiddleware implements NestMiddleware {\n  constructor(private readonly logger: LoggingService) {}\n\n  /**\n   * Middleware handler\n   */\n  use(req: Request, res: Response, next: NextFunction): void {\n    // Skip logging for excluded paths\n    if (this.shouldExcludePath(req.path)) {\n      return next();\n    }\n\n    // Generate or retrieve request ID\n    const requestId = req.headers['x-request-id'] as string || uuidv4();\n\n    // Attach request ID and start time to request\n    req.requestId = requestId;\n    req.startTime = Date.now();\n\n    // Add request ID to response headers\n    res.setHeader('X-Request-ID', requestId);\n\n    // Extract tenant and user context\n    const context = this.extractContext(req);\n\n    // Set up response listener\n    this.setupResponseLogging(req, res, context);\n\n    next();\n  }\n\n  /**\n   * Check if path should be excluded from logging\n   */\n  private shouldExcludePath(path: string): boolean {\n    return EXCLUDE_PATHS.some(excludedPath => path.startsWith(excludedPath));\n  }\n\n  /**\n   * Extract context from request\n   */\n  private extractContext(req: Request): {\n    tenantId?: string;\n    userId?: string;\n    userRole?: string;\n    ip?: string;\n    userAgent?: string;\n  } {\n    return {\n      tenantId: (req as any).tenantId,\n      userId: (req as any).userId,\n      userRole: (req as any).userRole,\n      ip: this.getClientIp(req),\n      userAgent: req.headers['user-agent'],\n    };\n  }\n\n  /**\n   * Get client IP address from request\n   */\n  private getClientIp(req: Request): string {\n    return (\n      (req.headers['x-forwarded-for'] as string)?.split(',')[0]?.trim() ||\n      (req.headers['x-real-ip'] as string) ||\n      req.socket.remoteAddress ||\n      'unknown'\n    );\n  }\n\n  /**\n   * Sanitize headers by removing sensitive information\n   */\n  private sanitizeHeaders(headers: any): any {\n    const sanitized: any = {};\n\n    for (const [key, value] of Object.entries(headers)) {\n      const headerKey = key.toLowerCase();\n      if (!EXCLUDE_HEADERS.includes(headerKey)) {\n        sanitized[key] = value;\n      } else {\n        sanitized[key] = '[REDACTED]';\n      }\n    }\n\n    return sanitized;\n  }\n\n  /**\n   * Set up response logging\n   */\n  private setupResponseLogging(req: Request, res: Response, context: any): void {\n    const originalEnd = res.end.bind(res);\n    const startTime = req.startTime;\n\n    res.end = (chunk?: any, encoding?: BufferEncoding) => {\n      const responseTime = Date.now() - startTime;\n      const method = req.method as RequestMethod;\n\n      // Log the request/response\n      this.logRequestResponse(req, res, responseTime, method, context);\n\n      // Call original end\n      return originalEnd(chunk, encoding);\n    };\n  }\n\n  /**\n   * Log request/response details\n   */\n  private logRequestResponse(\n    req: Request,\n    res: Response,\n    responseTime: number,\n    method: RequestMethod,\n    context: any,\n  ): void {\n    const statusCode = res.statusCode;\n    const methodStr = RequestMethod[method];\n\n    // Determine log level based on status code and method\n    const shouldLog = this.shouldLogRequest(method, statusCode, responseTime);\n\n    if (!shouldLog) {\n      return;\n    }\n\n    // Extract request information\n    const requestInfo = {\n      method: methodStr,\n      path: req.path,\n      query: this.sanitizeQuery(req.query),\n      headers: this.sanitizeHeaders(req.headers),\n      ip: context.ip,\n      userAgent: context.userAgent,\n    };\n\n    // Extract response information\n    const responseInfo = {\n      statusCode,\n      responseTimeMs: responseTime,\n      headers: this.sanitizeHeaders(res.getHeaders()),\n    };\n\n    // Log with context\n    this.logger.logHttpRequest(\n      methodStr,\n      req.path,\n      statusCode,\n      responseTime,\n      {\n        ...context,\n        requestId: req.requestId,\n        request: requestInfo,\n        response: responseInfo,\n      },\n    );\n  }\n\n  /**\n   * Sanitize query parameters\n   */\n  private sanitizeQuery(query: any): any {\n    if (!query || typeof query !== 'object') {\n      return query;\n    }\n\n    const sanitized: any = {};\n    const sensitiveParams = ['password', 'token', 'secret', 'api_key', 'authorization'];\n\n    for (const [key, value] of Object.entries(query)) {\n      if (sensitiveParams.some(param => key.toLowerCase().includes(param))) {\n        sanitized[key] = '[REDACTED]';\n      } else {\n        sanitized[key] = value;\n      }\n    }\n\n    return sanitized;\n  }\n\n  /**\n   * Determine if request should be logged\n   */\n  private shouldLogRequest(method: RequestMethod, statusCode: number, responseTime: number): boolean {\n    // Always log errors (4xx, 5xx)\n    if (statusCode >= 400) {\n      return true;\n    }\n\n    // Always log modifying methods (POST, PUT, PATCH, DELETE)\n    if (LOGGABLE_METHODS.includes(method)) {\n      return true;\n    }\n\n    // Log slow requests (> 1000ms) even for other methods\n    if (responseTime > 1000) {\n      return true;\n    }\n\n    // Don't log GET, HEAD, OPTIONS by default (too noisy)\n    return false;\n  }\n}\n"],"names":["LoggingMiddleware","LOGGABLE_METHODS","RequestMethod","POST","PUT","PATCH","DELETE","EXCLUDE_PATHS","EXCLUDE_HEADERS","use","req","res","next","shouldExcludePath","path","requestId","headers","uuidv4","startTime","Date","now","setHeader","context","extractContext","setupResponseLogging","some","excludedPath","startsWith","tenantId","userId","userRole","ip","getClientIp","userAgent","split","trim","socket","remoteAddress","sanitizeHeaders","sanitized","key","value","Object","entries","headerKey","toLowerCase","includes","originalEnd","end","bind","chunk","encoding","responseTime","method","logRequestResponse","statusCode","methodStr","shouldLog","shouldLogRequest","requestInfo","query","sanitizeQuery","responseInfo","responseTimeMs","getHeaders","logger","logHttpRequest","request","response","sensitiveParams","param"],"mappings":"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"}
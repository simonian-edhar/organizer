{"version":3,"sources":["../../../src/common/logging/logger.config.ts"],"sourcesContent":["import { ConfigService } from '@nestjs/config';\nimport * as winston from 'winston';\nimport DailyRotateFile from 'winston-daily-rotate-file';\nimport * as Sentry from '@sentry/node';\n\n/**\n * Sensitive data patterns that should be redacted from logs\n */\nconst SENSITIVE_PATTERNS = [\n  /password/i,\n  /token/i,\n  /secret/i,\n  /api[_-]?key/i,\n  /authorization/i,\n  /credit[_-]?card/i,\n  /ssn/i,\n  /social[_-]?security/i,\n];\n\n/**\n * Redact sensitive data from log objects\n */\nfunction redactSensitiveData(data: any): any {\n  if (!data || typeof data !== 'object') {\n    return data;\n  }\n\n  if (Array.isArray(data)) {\n    return data.map(item => redactSensitiveData(item));\n  }\n\n  const redacted: any = {};\n  for (const [key, value] of Object.entries(data)) {\n    const isSensitive = SENSITIVE_PATTERNS.some(pattern => pattern.test(key));\n    redacted[key] = isSensitive ? '[REDACTED]' : redactSensitiveData(value);\n  }\n  return redacted;\n}\n\n/**\n * Create console transport with appropriate format\n */\nfunction createConsoleTransport(isProduction: boolean): winston.transports.ConsoleTransportInstance {\n  return new winston.transports.Console({\n    format: winston.format.combine(\n      winston.format.timestamp({ format: 'YYYY-MM-DD HH:mm:ss' }),\n      winston.format.errors({ stack: true }),\n      winston.format.printf(({ timestamp, level, message, context, trace, ...meta }) => {\n        const metaObj = redactSensitiveData(meta);\n        const metaStr = Object.keys(metaObj).length ? JSON.stringify(metaObj, null, 2) : '';\n\n        if (isProduction) {\n          // JSON format for production\n          return JSON.stringify({\n            timestamp,\n            level,\n            context,\n            message,\n            ...metaObj,\n            ...(trace && { trace }),\n          });\n        }\n\n        // Pretty format for development\n        const traceStr = trace ? `\\n${trace}` : '';\n        const metaPretty = metaStr ? `\\n${metaStr}` : '';\n        return `${timestamp} [${context}] ${level}: ${message}${metaPretty}${traceStr}`;\n      }),\n    ),\n  });\n}\n\n/**\n * Create file transport with daily rotation\n */\nfunction createFileTransport(\n  logLevel: string,\n  filename: string,\n  datePattern: string,\n  maxSize: string,\n  maxFiles: string,\n): DailyRotateFile {\n  return new DailyRotateFile({\n    filename,\n    datePattern,\n    zippedArchive: true,\n    maxSize,\n    maxFiles,\n    level: logLevel,\n    format: winston.format.combine(\n      winston.format.timestamp({ format: 'YYYY-MM-DD HH:mm:ss' }),\n      winston.format.errors({ stack: true }),\n      winston.format.json(),\n    ),\n  });\n}\n\n/**\n * Create Sentry transport for error tracking\n */\nfunction createSentryTransport(\n  sentryDsn: string,\n  environment: string,\n): winston.transport | null {\n  if (!sentryDsn) {\n    return null;\n  }\n\n  Sentry.init({\n    dsn: sentryDsn,\n    environment,\n    tracesSampleRate: 0.1,\n    beforeSend(event) {\n      // Redact sensitive data from Sentry events\n      if (event.request) {\n        event.request.headers = redactSensitiveData(event.request.headers);\n        if (event.request.cookies) {\n          event.request.cookies = redactSensitiveData(event.request.cookies);\n        }\n      }\n      if (event.user) {\n        event.user = redactSensitiveData(event.user);\n      }\n      return event;\n    },\n  });\n\n  return new winston.transports.Console({\n    level: 'error',\n    format: winston.format.combine(\n      winston.format.printf(({ level, message, trace, ...meta }) => {\n        if (level === 'error' || level === 'fatal') {\n          Sentry.captureException(new Error(message), {\n            extra: { ...meta, ...(trace && { trace }) },\n          });\n        }\n        return '';\n      }),\n    ),\n  });\n}\n\n/**\n * Create Winston logger configuration\n */\nexport function createLoggerConfig(configService: ConfigService): winston.LoggerOptions {\n  const isProduction = configService.get('NODE_ENV') === 'production';\n  const logLevel = configService.get('LOG_LEVEL', 'info');\n  const logFormat = configService.get('LOG_FORMAT', 'json');\n  const sentryDsn = configService.get('SENTRY_DSN', '');\n  const environment = configService.get('NODE_ENV', 'development');\n  const consoleOnly = configService.get('LOG_CONSOLE_ONLY', '') === 'true' || configService.get('LOG_CONSOLE_ONLY', '') === '1';\n\n  const transports: winston.transport[] = [\n    createConsoleTransport(isProduction && logFormat === 'json'),\n  ];\n\n  if (!consoleOnly) {\n    // Add file transports for all logs\n    transports.push(\n      createFileTransport(\n        logLevel,\n        'logs/application-%DATE%.log',\n        'YYYY-MM-DD',\n        '20m',\n        '14d',\n      ),\n    );\n    transports.push(\n      createFileTransport(\n        'error',\n        'logs/error-%DATE%.log',\n        'YYYY-MM-DD',\n        '20m',\n        '30d',\n      ),\n    );\n  }\n\n  // Add Sentry transport if DSN is configured (and not a placeholder)\n  const sentryTransport = sentryDsn && !sentryDsn.includes('xxxxxx') ? createSentryTransport(sentryDsn, environment) : null;\n  if (sentryTransport) {\n    transports.push(sentryTransport);\n  }\n\n  return {\n    level: logLevel,\n    format: winston.format.combine(\n      winston.format.timestamp({ format: 'YYYY-MM-DD HH:mm:ss' }),\n      winston.format.errors({ stack: true }),\n      winston.format.splat(),\n    ),\n    transports,\n    // Exit on error in production to prevent silent failures\n    exitOnError: isProduction,\n  };\n}\n\n/**\n * Create request-specific logger with context\n */\nexport function createContextLogger(\n  logger: winston.Logger,\n  context: string,\n  meta?: Record<string, any>,\n): winston.Logger {\n  return logger.child({\n    context,\n    ...redactSensitiveData(meta),\n  });\n}\n\n/**\n * Get log level from environment or use default\n */\nexport function getLogLevel(configService: ConfigService): string {\n  const nodeEnv = configService.get('NODE_ENV', 'development');\n  const envLogLevel = configService.get('LOG_LEVEL');\n\n  // Use environment-specific default if not explicitly set\n  if (!envLogLevel) {\n    return nodeEnv === 'production' ? 'info' : 'debug';\n  }\n\n  return envLogLevel;\n}\n\n/**\n * Validate log level\n */\nexport function isValidLogLevel(level: string): boolean {\n  const validLevels = ['error', 'warn', 'info', 'http', 'verbose', 'debug', 'silly'];\n  return validLevels.includes(level);\n}\n"],"names":["createContextLogger","createLoggerConfig","getLogLevel","isValidLogLevel","SENSITIVE_PATTERNS","redactSensitiveData","data","Array","isArray","map","item","redacted","key","value","Object","entries","isSensitive","some","pattern","test","createConsoleTransport","isProduction","winston","transports","Console","format","combine","timestamp","errors","stack","printf","level","message","context","trace","meta","metaObj","metaStr","keys","length","JSON","stringify","traceStr","metaPretty","createFileTransport","logLevel","filename","datePattern","maxSize","maxFiles","DailyRotateFile","zippedArchive","json","createSentryTransport","sentryDsn","environment","Sentry","init","dsn","tracesSampleRate","beforeSend","event","request","headers","cookies","user","captureException","Error","extra","configService","get","logFormat","consoleOnly","push","sentryTransport","includes","splat","exitOnError","logger","child","nodeEnv","envLogLevel","validLevels"],"mappings":"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"}
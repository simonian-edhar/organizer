{"version":3,"sources":["../../../src/common/logging/global-exception.filter.ts"],"sourcesContent":["import {\n  ExceptionFilter,\n  Catch,\n  ArgumentsHost,\n  HttpException,\n  HttpStatus,\n  LoggerService,\n} from '@nestjs/common';\nimport { Request, Response } from 'express';\nimport { LoggingService, LogContext } from './logging.service';\n\n/**\n * Error response interface\n */\ninterface ErrorResponse {\n  statusCode: number;\n  timestamp: string;\n  path: string;\n  method: string;\n  requestId?: string;\n  error: string;\n  message: string | object;\n  stack?: string;\n}\n\n/**\n * Global exception filter\n * Catches all exceptions and logs them with context\n */\n@Catch()\nexport class GlobalExceptionFilter implements ExceptionFilter {\n  constructor(private readonly logger: LoggingService) {}\n\n  /**\n   * Exception handler\n   */\n  catch(exception: unknown, host: ArgumentsHost): void {\n    const ctx = host.switchToHttp();\n    const request = ctx.getRequest<Request>();\n    const response = ctx.getResponse<Response>();\n\n    const statusCode =\n      exception instanceof HttpException\n        ? exception.getStatus()\n        : HttpStatus.INTERNAL_SERVER_ERROR;\n\n    const message =\n      exception instanceof HttpException\n        ? exception.getResponse()\n        : 'Internal server error';\n\n    const errorResponse = this.buildErrorResponse(exception, request, statusCode, message);\n\n    // Log the error with context\n    this.logException(exception, request, errorResponse);\n\n    // Send error response\n    response.status(statusCode).json(this.sanitizeError(errorResponse));\n  }\n\n  /**\n   * Build error response object\n   */\n  private buildErrorResponse(\n    exception: unknown,\n    request: Request,\n    statusCode: number,\n    message: any,\n  ): ErrorResponse {\n    const baseResponse: ErrorResponse = {\n      statusCode,\n      timestamp: new Date().toISOString(),\n      path: request.path,\n      method: request.method,\n      requestId: (request as any).requestId,\n      error: this.getErrorName(exception),\n      message: typeof message === 'object' ? (message as any).message : message,\n    };\n\n    // Add stack trace in development\n    if (process.env.NODE_ENV !== 'production') {\n      if (exception instanceof Error) {\n        baseResponse.stack = exception.stack;\n      }\n    }\n\n    // Handle validation errors\n    if (typeof message === 'object' && message !== null) {\n      const msgObj = message as any;\n      if (msgObj.error && typeof msgObj.error === 'string') {\n        baseResponse.error = msgObj.error;\n      }\n      if (msgObj.message) {\n        baseResponse.message = msgObj.message;\n      }\n    }\n\n    return baseResponse;\n  }\n\n  /**\n   * Get error name\n   */\n  private getErrorName(exception: unknown): string {\n    if (exception instanceof HttpException) {\n      return exception.constructor.name;\n    }\n    if (exception instanceof Error) {\n      return exception.constructor.name;\n    }\n    return 'Error';\n  }\n\n  /**\n   * Extract context from request for logging\n   */\n  private extractLogContext(request: Request): LogContext {\n    return {\n      requestId: (request as any).requestId,\n      tenantId: (request as any).tenantId,\n      userId: (request as any).userId,\n      userRole: (request as any).userRole,\n      ip: this.getClientIp(request),\n      userAgent: request.headers['user-agent'],\n      method: request.method,\n      path: request.path,\n    };\n  }\n\n  /**\n   * Get client IP address from request\n   */\n  private getClientIp(request: Request): string {\n    return (\n      (request.headers['x-forwarded-for'] as string)?.split(',')[0]?.trim() ||\n      (request.headers['x-real-ip'] as string) ||\n      request.socket.remoteAddress ||\n      'unknown'\n    );\n  }\n\n  /**\n   * Log exception with context\n   */\n  private logException(exception: unknown, request: Request, errorResponse: ErrorResponse): void {\n    const context = this.extractLogContext(request);\n\n    const logData: LogContext = {\n      ...context,\n      errorType: errorResponse.error,\n      errorMessage: errorResponse.message,\n      statusCode: errorResponse.statusCode,\n    };\n\n    // Log stack trace if available\n    if (exception instanceof Error && exception.stack) {\n      logData.stack = exception.stack;\n    }\n\n    // Log at appropriate level\n    const statusCode = errorResponse.statusCode;\n    if (statusCode >= 500) {\n      // Server errors\n      this.logger.error(\n        `Server Error: ${errorResponse.error}`,\n        exception instanceof Error ? exception.stack : undefined,\n        logData,\n      );\n    } else if (statusCode >= 400) {\n      // Client errors\n      this.logger.warn(\n        `Client Error: ${errorResponse.error}`,\n        logData,\n      );\n    } else {\n      // Other errors\n      this.logger.error(\n        `Error: ${errorResponse.error}`,\n        exception instanceof Error ? exception.stack : undefined,\n        logData,\n      );\n    }\n\n    // Log to error log file specifically\n    this.logger.logHttpRequest(\n      request.method,\n      request.path,\n      statusCode,\n      (request as any).startTime ? Date.now() - (request as any).startTime : 0,\n      context,\n    );\n  }\n\n  /**\n   * Sanitize error response for production\n   * Remove sensitive information\n   */\n  private sanitizeError(errorResponse: ErrorResponse): any {\n    if (process.env.NODE_ENV === 'production') {\n      // Remove stack trace in production\n      const { stack, ...sanitized } = errorResponse;\n      return sanitized;\n    }\n\n    // Return full error in development\n    return errorResponse;\n  }\n\n  /**\n   * Set logger instance (for dependency injection)\n   */\n  setLogger(logger: LoggingService): void {\n    this.logger = logger;\n  }\n}\n"],"names":["GlobalExceptionFilter","catch","exception","host","ctx","switchToHttp","request","getRequest","response","getResponse","statusCode","HttpException","getStatus","HttpStatus","INTERNAL_SERVER_ERROR","message","errorResponse","buildErrorResponse","logException","status","json","sanitizeError","baseResponse","timestamp","Date","toISOString","path","method","requestId","error","getErrorName","process","env","NODE_ENV","Error","stack","msgObj","name","extractLogContext","tenantId","userId","userRole","ip","getClientIp","userAgent","headers","split","trim","socket","remoteAddress","context","logData","errorType","errorMessage","logger","undefined","warn","logHttpRequest","startTime","now","sanitized","setLogger"],"mappings":"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"}
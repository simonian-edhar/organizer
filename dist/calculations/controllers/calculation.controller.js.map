{"version":3,"sources":["../../../src/calculations/controllers/calculation.controller.ts"],"sourcesContent":["import {\n    Controller,\n    Get,\n    Post,\n    Put,\n    Delete,\n    Body,\n    Param,\n    Query,\n    UseGuards,\n    HttpCode,\n    HttpStatus,\n    Res,\n    Req,\n} from '@nestjs/common';\nimport { ApiTags, ApiOperation, ApiResponse, ApiBearerAuth, ApiParam, ApiQuery, ApiBody } from '@nestjs/swagger';\nimport { CalculationService } from '../services/calculation.service';\nimport {\n    CreateCalculationDto,\n    UpdateCalculationDto,\n    CalculationFiltersDto,\n    GeneratePdfDto,\n    ApproveCalculationDto,\n    RejectCalculationDto,\n} from '../dto/calculation.dto';\nimport { JwtAuthGuard } from '../../auth/guards';\nimport { TenantGuard, RbacGuard } from '../../auth/guards';\nimport { Audit } from '../../auth/services/audit.service';\n\n/**\n * Calculations Controller\n */\n@ApiTags('Calculations')\n@Controller('calculations')\n@UseGuards(JwtAuthGuard, TenantGuard)\n@ApiBearerAuth()\nexport class CalculationsController {\n    constructor(private readonly calculationService: CalculationService) {}\n\n    @Get()\n    @ApiOperation({ summary: 'Get all calculations' })\n    @ApiResponse({ status: 200, description: 'Calculations retrieved' })\n    async findAll(\n        @Query() filters: CalculationFiltersDto,\n        @Req() req: any\n    ): Promise<{ data: any[]; total: number; page: number; limit: number }> {\n        const tenantId = req.user?.tenant_id;\n        return this.calculationService.findAll(tenantId, filters);\n    }\n\n    @Get('statistics')\n    @ApiOperation({ summary: 'Get calculation statistics' })\n    @ApiResponse({ status: 200, description: 'Statistics retrieved' })\n    async getStatistics(@Req() req: any): Promise<any> {\n        const tenantId = req.user?.tenant_id;\n        return this.calculationService.getStatistics(tenantId);\n    }\n\n    @Get(':id')\n    @ApiOperation({ summary: 'Get calculation by ID' })\n    @ApiResponse({ status: 200, description: 'Calculation retrieved' })\n    async findById(@Param('id') id: string, @Req() req: any): Promise<any> {\n        const tenantId = req.user?.tenant_id;\n        return this.calculationService.findById(tenantId, id);\n    }\n\n    @Post()\n    @UseGuards(RbacGuard)\n    @ApiOperation({ summary: 'Create new calculation' })\n    @ApiResponse({ status: 201, description: 'Calculation created' })\n    @Audit('create')\n    async create(@Body() dto: CreateCalculationDto, @Req() req: any): Promise<any> {\n        const tenantId = req.user?.tenant_id;\n        const userId = req.user?.user_id;\n        return this.calculationService.create(tenantId, userId, dto);\n    }\n\n    @Put(':id')\n    @UseGuards(RbacGuard)\n    @ApiOperation({ summary: 'Update calculation' })\n    @ApiResponse({ status: 200, description: 'Calculation updated' })\n    @Audit('update')\n    async update(\n        @Param('id') id: string,\n        @Body() dto: UpdateCalculationDto,\n        @Req() req: any\n    ): Promise<any> {\n        const tenantId = req.user?.tenant_id;\n        const userId = req.user?.user_id;\n        return this.calculationService.update(tenantId, id, userId, dto);\n    }\n\n    @Delete(':id')\n    @UseGuards(RbacGuard)\n    @HttpCode(HttpStatus.NO_CONTENT)\n    @ApiOperation({ summary: 'Delete calculation' })\n    @ApiResponse({ status: 204, description: 'Calculation deleted' })\n    @Audit('delete')\n    async delete(@Param('id') id: string, @Req() req: any): Promise<void> {\n        const tenantId = req.user?.tenant_id;\n        const userId = req.user?.user_id;\n        return this.calculationService.delete(tenantId, id, userId);\n    }\n\n    @Post(':id/send-for-approval')\n    @UseGuards(RbacGuard)\n    @ApiOperation({ summary: 'Send calculation for approval' })\n    @ApiResponse({ status: 200, description: 'Calculation sent for approval' })\n    @Audit('update')\n    async sendForApproval(@Param('id') id: string, @Req() req: any): Promise<any> {\n        const tenantId = req.user?.tenant_id;\n        const userId = req.user?.user_id;\n        return this.calculationService.sendForApproval(tenantId, id, userId);\n    }\n\n    @Post(':id/approve')\n    @UseGuards(RbacGuard)\n    @ApiOperation({ summary: 'Approve calculation' })\n    @ApiResponse({ status: 200, description: 'Calculation approved' })\n    @Audit('update')\n    async approve(\n        @Param('id') id: string,\n        @Body() dto: ApproveCalculationDto,\n        @Req() req: any\n    ): Promise<any> {\n        const tenantId = req.user?.tenant_id;\n        const userId = req.user?.user_id;\n        return this.calculationService.approve(tenantId, id, userId, dto);\n    }\n\n    @Post(':id/reject')\n    @UseGuards(RbacGuard)\n    @ApiOperation({ summary: 'Reject calculation' })\n    @ApiResponse({ status: 200, description: 'Calculation rejected' })\n    @Audit('update')\n    async reject(\n        @Param('id') id: string,\n        @Body() dto: RejectCalculationDto,\n        @Req() req: any\n    ): Promise<any> {\n        const tenantId = req.user?.tenant_id;\n        const userId = req.user?.user_id;\n        return this.calculationService.reject(tenantId, id, userId, dto);\n    }\n\n    @Post(':id/pdf')\n    @UseGuards(RbacGuard)\n    @ApiOperation({ summary: 'Generate calculation PDF' })\n    @ApiResponse({ status: 200, description: 'PDF generated' })\n    @Audit('update')\n    async generatePdf(\n        @Param('id') id: string,\n        @Body() dto: GeneratePdfDto,\n        @Req() req: any\n    ): Promise<{ pdfUrl: string; pdfGeneratedAt: Date }> {\n        const tenantId = req.user?.tenant_id;\n        return this.calculationService.generatePdf(tenantId, id, dto);\n    }\n\n    @Get(':id/export/excel')\n    @ApiOperation({ summary: 'Export calculation to Excel' })\n    @ApiResponse({ status: 200, description: 'Excel exported', type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' })\n    async exportToExcel(\n        @Param('id') id: string,\n        @Req() req: any,\n        @Res() res: any,\n    ): Promise<void> {\n        const tenantId = req.user?.tenant_id;\n        const excelBuffer = await this.calculationService.exportToExcel(tenantId, id);\n\n        res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');\n        res.setHeader('Content-Disposition', `attachment; filename=calculation-${id}.xlsx`);\n\n        res.send(excelBuffer);\n    }\n\n    @Get(':id/export/pdf')\n    @ApiOperation({ summary: 'Export calculation to PDF' })\n    @ApiResponse({ status: 200, description: 'PDF exported', type: 'application/pdf' })\n    async exportToPdf(\n        @Param('id') id: string,\n        @Req() req: any,\n        @Res() res: any,\n    ): Promise<void> {\n        const tenantId = req.user?.tenant_id;\n        const { pdfUrl } = await this.calculationService.generatePdf(tenantId, id, { userId: req.user?.user_id });\n\n        // Redirect to PDF URL or serve file\n        res.redirect(pdfUrl);\n    }\n}\n"],"names":["CalculationsController","findAll","filters","req","tenantId","user","tenant_id","calculationService","getStatistics","findById","id","create","dto","userId","user_id","update","delete","sendForApproval","approve","reject","generatePdf","exportToExcel","res","excelBuffer","setHeader","send","exportToPdf","pdfUrl","redirect","summary","status","description","NO_CONTENT","type"],"mappings":"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"}
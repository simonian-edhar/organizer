{"version":3,"sources":["../../../src/calculations/services/calculation.service.ts"],"sourcesContent":["import { Injectable, NotFoundException, BadRequestException } from '@nestjs/common';\nimport { InjectRepository } from '@nestjs/typeorm';\nimport { Repository } from 'typeorm';\nimport { Calculation } from '../../database/entities/Calculation.entity';\nimport { CalculationItem } from '../../database/entities/CalculationItem.entity';\nimport { PricelistItem } from '../../database/entities/PricelistItem.entity';\nimport {\n    CreateCalculationDto,\n    UpdateCalculationDto,\n    CalculationFiltersDto,\n    GeneratePdfDto,\n    ApproveCalculationDto,\n    RejectCalculationDto,\n} from '../dto/calculation.dto';\n\n/**\n * Calculation Service\n */\n@Injectable()\nexport class CalculationService {\n    constructor(\n        @InjectRepository(Calculation)\n        private readonly calculationRepository: Repository<Calculation>,\n        @InjectRepository(CalculationItem)\n        private readonly calculationItemRepository: Repository<CalculationItem>,\n        @InjectRepository(PricelistItem)\n        private readonly pricelistItemRepository: Repository<PricelistItem>,\n    ) {}\n\n    /**\n     * Get all calculations\n     */\n    async findAll(\n        tenantId: string,\n        filters: CalculationFiltersDto = {}\n    ): Promise<{ data: Calculation[]; total: number; page: number; limit: number }> {\n        const query = this.calculationRepository\n            .createQueryBuilder('calculation')\n            .where('calculation.tenantId = :tenantId AND calculation.deletedAt IS NULL', { tenantId });\n\n        // Filter by case\n        if (filters.caseId) {\n            query.andWhere('calculation.caseId = :caseId', { caseId: filters.caseId });\n        }\n\n        // Filter by status\n        if (filters.status) {\n            query.andWhere('calculation.status = :status', { status: filters.status });\n        }\n\n        // Filter by date range\n        if (filters.calculationDateFrom && filters.calculationDateTo) {\n            query.andWhere('calculation.calculationDate BETWEEN :calculationDateFrom AND :calculationDateTo', {\n                calculationDateFrom: new Date(filters.calculationDateFrom),\n                calculationDateTo: new Date(filters.calculationDateTo),\n            });\n        } else if (filters.calculationDateFrom) {\n            query.andWhere('calculation.calculationDate >= :calculationDateFrom', {\n                calculationDateFrom: new Date(filters.calculationDateFrom),\n            });\n        } else if (filters.calculationDateTo) {\n            query.andWhere('calculation.calculationDate <= :calculationDateTo', {\n                calculationDateTo: new Date(filters.calculationDateTo),\n            });\n        }\n\n        // Search\n        if (filters.search) {\n            query.andWhere(\n                '(calculation.name ILIKE :search OR ' +\n                'calculation.description ILIKE :search)',\n                { search: `%${filters.search}%` }\n            );\n        }\n\n        // Sorting\n        const sortBy = filters.sortBy || 'calculationDate';\n        const sortOrder = filters.sortOrder || 'DESC';\n        query.orderBy(`calculation.${sortBy}`, sortOrder);\n\n        // Pagination\n        const page = filters.page || 1;\n        const limit = filters.limit || 20;\n        const skip = (page - 1) * limit;\n\n        query.skip(skip).take(limit);\n\n        // Include relations\n        query.leftJoinAndSelect('calculation.case', 'case');\n        query.leftJoinAndSelect('calculation.items', 'items');\n\n        const [data, total] = await query.getManyAndCount();\n\n        return {\n            data,\n            total,\n            page,\n            limit,\n        };\n    }\n\n    /**\n     * Get calculation by ID\n     */\n    async findById(tenantId: string, id: string): Promise<Calculation> {\n        const calculation = await this.calculationRepository.findOne({\n            where: {\n                id,\n                tenantId,\n                deletedAt: null,\n            },\n            relations: ['items', 'case', 'approvedBy'],\n        });\n\n        if (!calculation) {\n            throw new NotFoundException('Розрахунок не знайдено');\n        }\n\n        return calculation;\n    }\n\n    /**\n     * Create calculation\n     */\n    async create(\n        tenantId: string,\n        userId: string,\n        dto: CreateCalculationDto\n    ): Promise<Calculation> {\n        // Generate calculation number\n        const calculationNumber = await this.generateCalculationNumber(tenantId);\n\n        // Calculate totals\n        let subtotal = 0;\n        let vatAmount = 0;\n        const items = [];\n\n        for (const itemDto of dto.items) {\n            let unitPrice = itemDto.unitPrice;\n            let lineTotal = 0;\n\n            // Get price from pricelist if item not provided\n            if (itemDto.pricelistItemId && !itemDto.unitPrice) {\n                const pricelistItem = await this.pricelistItemRepository.findOne({\n                    where: {\n                        id: itemDto.pricelistItemId,\n                        tenantId,\n                        deletedAt: null,\n                    },\n                });\n\n                if (pricelistItem) {\n                    unitPrice = pricelistItem.basePrice;\n\n                    if (itemDto.unitType === 'hourly') {\n                        const duration = itemDto.duration || pricelistItem.defaultDuration || 60;\n                        lineTotal = (unitPrice * duration) / 60;\n                    } else if (itemDto.unitType === 'piecewise') {\n                        const quantity = itemDto.quantity || 1;\n                        lineTotal = unitPrice * quantity;\n                    } else {\n                        lineTotal = unitPrice;\n                    }\n                }\n            }\n\n            lineTotal = parseFloat(lineTotal.toFixed(2));\n            subtotal += lineTotal;\n\n            items.push({\n                description: itemDto.description,\n                pricelistItemId: itemDto.pricelistItemId,\n                code: itemDto.code,\n                unitType: itemDto.unitType,\n                quantity: itemDto.quantity,\n                duration: itemDto.duration,\n                unitPrice,\n                lineTotal,\n                vatRate: 0, // TODO: from pricelist\n                vatAmount: 0,\n            });\n        }\n\n        // Calculate discount\n        const discountAmount = 0; // TODO: from calculation settings\n\n        // Calculate VAT\n        const vatRate = 20; // TODO: from calculation settings\n        vatAmount = subtotal * (vatRate / 100);\n\n        const totalAmount = subtotal + vatAmount - discountAmount;\n\n        const calculation = this.calculationRepository.create({\n            tenantId,\n            caseId: dto.caseId,\n            number: calculationNumber,\n            name: dto.name,\n            calculationDate: new Date(dto.calculationDate),\n            dueDate: dto.dueDate ? new Date(dto.dueDate) : new Date(dto.calculationDate),\n            description: dto.description,\n            subtotal: parseFloat(subtotal.toFixed(2)),\n            discountAmount: parseFloat(discountAmount.toFixed(2)),\n            vatAmount: parseFloat(vatAmount.toFixed(2)),\n            totalAmount: parseFloat(totalAmount.toFixed(2)),\n            currency: 'UAH',\n            status: 'draft',\n            pricelistId: dto.pricelistId,\n            createdBy: userId,\n            updatedBy: userId,\n        });\n\n        const savedCalculation = await this.calculationRepository.save(calculation);\n\n        // Save items\n        for (const item of items) {\n            await this.calculationItemRepository.save({\n                ...item,\n                calculationId: savedCalculation.id,\n                tenantId,\n                createdBy: userId,\n                updatedBy: userId,\n            });\n        }\n\n        return savedCalculation;\n    }\n\n    /**\n     * Update calculation\n     */\n    async update(\n        tenantId: string,\n        id: string,\n        userId: string,\n        dto: UpdateCalculationDto\n    ): Promise<Calculation> {\n        const calculation = await this.findById(tenantId, id);\n\n        Object.assign(calculation, dto, {\n            updatedBy: userId,\n        });\n\n        return this.calculationRepository.save(calculation);\n    }\n\n    /**\n     * Delete calculation (soft delete)\n     */\n    async delete(tenantId: string, id: string, userId: string): Promise<void> {\n        const calculation = await this.findById(tenantId, id);\n\n        await this.calculationRepository.update(\n            { id, tenantId },\n            {\n                deletedAt: new Date(),\n                updatedBy: userId,\n            }\n        );\n    }\n\n    /**\n     * Send for approval\n     */\n    async sendForApproval(tenantId: string, id: string, userId: string): Promise<Calculation> {\n        const calculation = await this.findById(tenantId, id);\n\n        if (calculation.status !== 'draft') {\n            throw new BadRequestException('Тільки чернети можна відправити на затвердження');\n        }\n\n        calculation.status = 'pending_approval';\n        calculation.updatedBy = userId;\n\n        // TODO: Send notification to owner\n        await this.calculationRepository.save(calculation);\n\n        return calculation;\n    }\n\n    /**\n     * Approve calculation\n     */\n    async approve(\n        tenantId: string,\n        id: string,\n        userId: string,\n        dto: ApproveCalculationDto\n    ): Promise<Calculation> {\n        const calculation = await this.findById(tenantId, id);\n\n        if (calculation.status !== 'pending_approval') {\n            throw new BadRequestException('Розрахунок не очікує затвердження');\n        }\n\n        calculation.status = 'approved';\n        calculation.approvedBy = userId;\n        calculation.updatedBy = userId;\n\n        return this.calculationRepository.save(calculation);\n    }\n\n    /**\n     * Reject calculation\n     */\n    async reject(\n        tenantId: string,\n        id: string,\n        userId: string,\n        dto: RejectCalculationDto\n    ): Promise<Calculation> {\n        const calculation = await this.findById(tenantId, id);\n\n        if (calculation.status !== 'pending_approval') {\n            throw new BadRequestException('Розрахунок не очікує затвердження');\n        }\n\n        calculation.status = 'rejected';\n        calculation.updatedBy = userId;\n\n        // Add rejection reason to notes\n        calculation.internalNotes = `[REJECTED] ${dto.reason}`;\n\n        return this.calculationRepository.save(calculation);\n    }\n\n    /**\n     * Generate PDF\n     */\n    async generatePdf(\n        tenantId: string,\n        id: string,\n        dto: GeneratePdfDto\n    ): Promise<{ pdfUrl: string; pdfGeneratedAt: Date }> {\n        const calculation = await this.findById(tenantId, id);\n\n        // TODO: Generate PDF using template service\n        const pdfUrl = `https://cdn.laworganizer.ua/calculations/${id}.pdf`;\n        const pdfGeneratedAt = new Date();\n\n        calculation.pdfUrl = pdfUrl;\n        calculation.pdfGeneratedAt = pdfGeneratedAt;\n        calculation.updatedBy = dto.userId;\n\n        await this.calculationRepository.save(calculation);\n\n        return { pdfUrl, pdfGeneratedAt };\n    }\n\n    /**\n     * Export calculation\n     */\n    async exportToExcel(tenantId: string, id: string): Promise<Buffer> {\n        const calculation = await this.findById(tenantId, id);\n\n        // TODO: Generate Excel export\n        const excelData = Buffer.from('Excel data');\n\n        return excelData;\n    }\n\n    /**\n     * Get calculation statistics\n     */\n    async getStatistics(tenantId: string): Promise<{\n        total: number;\n        byStatus: Record<string, number>;\n        totalAmount: number;\n        paidAmount: number;\n        outstandingAmount: number;\n    }> {\n        const [total] = await this.calculationRepository\n            .createQueryBuilder('calculation')\n            .select('COUNT(*)')\n            .where('calculation.tenantId = :tenantId AND calculation.deletedAt IS NULL', { tenantId })\n            .getRawMany();\n\n        const [byStatus] = await this.calculationRepository\n            .createQueryBuilder('calculation')\n            .select('calculation.status', 'COUNT(*) as count')\n            .where('calculation.tenantId = :tenantId AND calculation.deletedAt IS NULL', { tenantId })\n            .groupBy('calculation.status')\n            .getRawMany();\n\n        const [totalAmount] = await this.calculationRepository\n            .createQueryBuilder('calculation')\n            .select('SUM(calculation.totalAmount)')\n            .where('calculation.tenantId = :tenantId AND calculation.deletedAt IS NULL', { tenantId })\n            .getRawMany();\n\n        const [paidAmount] = await this.calculationRepository\n            .createQueryBuilder('calculation')\n            .select('SUM(calculation.paidAmount)')\n            .where('calculation.tenantId = :tenantId AND calculation.deletedAt IS NULL', { tenantId })\n            .getRawMany();\n\n        const outstandingAmount = (totalAmount[0].sum || 0) - (paidAmount[0].sum || 0);\n\n        return {\n            total: parseInt(total[0].count),\n            totalAmount: totalAmount[0].sum || 0,\n            paidAmount: paidAmount[0].sum || 0,\n            outstandingAmount,\n            byStatus: byStatus.reduce((acc, row) => {\n                acc[row.status] = parseInt(row.count);\n                return acc;\n            }, {} as Record<string, number>),\n        };\n    }\n\n    /**\n     * Generate calculation number\n     */\n    private async generateCalculationNumber(tenantId: string): Promise<string> {\n        const date = new Date();\n        const year = date.getFullYear();\n        const month = String(date.getMonth() + 1).padStart(2, '0');\n\n        // Get latest calculation number for this month/year\n        const latest = await this.calculationRepository\n            .createQueryBuilder('calculation')\n            .select('calculation.number')\n            .where('calculation.tenantId = :tenantId AND calculation.number LIKE :pattern', {\n                tenantId,\n                pattern: `CALC-${year}-${month}-%`,\n            })\n            .orderBy('calculation.number', 'DESC')\n            .limit(1)\n            .getOne();\n\n        let number = 1;\n        if (latest) {\n            const parts = latest.number.split('-');\n            number = parseInt(parts[3]) + 1;\n        }\n\n        return `CALC-${year}-${month}-${String(number).padStart(4, '0')}`;\n    }\n}\n"],"names":["CalculationService","findAll","tenantId","filters","query","calculationRepository","createQueryBuilder","where","caseId","andWhere","status","calculationDateFrom","calculationDateTo","Date","search","sortBy","sortOrder","orderBy","page","limit","skip","take","leftJoinAndSelect","data","total","getManyAndCount","findById","id","calculation","findOne","deletedAt","relations","NotFoundException","create","userId","dto","calculationNumber","generateCalculationNumber","subtotal","vatAmount","items","itemDto","unitPrice","lineTotal","pricelistItemId","pricelistItem","pricelistItemRepository","basePrice","unitType","duration","defaultDuration","quantity","parseFloat","toFixed","push","description","code","vatRate","discountAmount","totalAmount","number","name","calculationDate","dueDate","currency","pricelistId","createdBy","updatedBy","savedCalculation","save","item","calculationItemRepository","calculationId","update","Object","assign","delete","sendForApproval","BadRequestException","approve","approvedBy","reject","internalNotes","reason","generatePdf","pdfUrl","pdfGeneratedAt","exportToExcel","excelData","Buffer","from","getStatistics","select","getRawMany","byStatus","groupBy","paidAmount","outstandingAmount","sum","parseInt","count","reduce","acc","row","date","year","getFullYear","month","String","getMonth","padStart","latest","pattern","getOne","parts","split"],"mappings":"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"}
{"version":3,"sources":["../../../src/database/migrations/1704067200000-InitAuthSchema.ts"],"sourcesContent":["import { MigrationInterface, QueryRunner } from 'typeorm';\n\nexport class InitAuthSchema1704067200000 implements MigrationInterface {\n    name = 'InitAuthSchema1704067200000';\n\n    public async up(queryRunner: QueryRunner): Promise<void> {\n        // Enable required extensions\n        await queryRunner.query(`CREATE EXTENSION IF NOT EXISTS \"uuid-ossp\"`);\n        await queryRunner.query(`CREATE EXTENSION IF NOT EXISTS \"pgcrypto\"`);\n        await queryRunner.query(`CREATE EXTENSION IF NOT EXISTS \"btree_gin\"`);\n\n        // Create enums\n        await queryRunner.query(`\n            CREATE TYPE subscription_plan AS ENUM ('basic', 'professional', 'enterprise')\n        `);\n        await queryRunner.query(`\n            CREATE TYPE subscription_status AS ENUM ('trialing', 'active', 'past_due', 'canceled', 'unpaid')\n        `);\n        await queryRunner.query(`\n            CREATE TYPE subscription_provider AS ENUM ('stripe', 'wayforpay')\n        `);\n        await queryRunner.query(`\n            CREATE TYPE user_role AS ENUM ('super_admin', 'organization_owner', 'organization_admin', 'lawyer', 'assistant', 'accountant')\n        `);\n        await queryRunner.query(`\n            CREATE TYPE user_status AS ENUM ('pending', 'active', 'suspended', 'deleted')\n        `);\n        await queryRunner.query(`\n            CREATE TYPE invitation_status AS ENUM ('pending', 'accepted', 'expired', 'revoked')\n        `);\n        await queryRunner.query(`\n            CREATE TYPE organization_status AS ENUM ('provisioning', 'active', 'suspended', 'deleted')\n        `);\n        await queryRunner.query(`\n            CREATE TYPE legal_form AS ENUM ('sole_proprietor', 'llc', 'joint_stock', 'partnership', 'other')\n        `);\n        await queryRunner.query(`\n            CREATE TYPE audit_action AS ENUM ('create', 'update', 'delete', 'login', 'logout', 'permission_change')\n        `);\n        await queryRunner.query(`\n            CREATE TYPE onboarding_step AS ENUM ('organization_details', 'user_profile', 'subscription_setup', 'team_invitation', 'first_case_created')\n        `);\n\n        // Create organizations table\n        await queryRunner.query(`\n            CREATE TABLE organizations (\n                id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n                name VARCHAR(255) NOT NULL,\n                legal_form legal_form NOT NULL DEFAULT 'sole_proprietor',\n                edrpou VARCHAR(10),\n                tax_number VARCHAR(12),\n                address TEXT,\n                city VARCHAR(100),\n                region VARCHAR(100),\n                country VARCHAR(2) DEFAULT 'UA',\n                phone VARCHAR(20),\n                email VARCHAR(255) NOT NULL,\n                website VARCHAR(255),\n                subscription_plan subscription_plan NOT NULL DEFAULT 'basic',\n                subscription_status subscription_status NOT NULL DEFAULT 'trialing',\n                trial_end_at TIMESTAMP WITH TIME ZONE,\n                current_period_end_at TIMESTAMP WITH TIME ZONE,\n                max_users INTEGER NOT NULL DEFAULT 1,\n                custom_domain VARCHAR(255),\n                mfa_required BOOLEAN NOT NULL DEFAULT FALSE,\n                sso_enabled BOOLEAN NOT NULL DEFAULT FALSE,\n                audit_retention_days INTEGER NOT NULL DEFAULT 90,\n                status organization_status NOT NULL DEFAULT 'provisioning',\n                settings JSONB NOT NULL DEFAULT '{}',\n                metadata JSONB NOT NULL DEFAULT '{}',\n                created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),\n                updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),\n                deleted_at TIMESTAMP WITH TIME ZONE,\n                CONSTRAINT organizations_email_unique UNIQUE (email, deleted_at),\n                CONSTRAINT organizations_edrpou_unique UNIQUE (edrpou, deleted_at)\n            )\n        `);\n\n        // Create organizations indexes\n        await queryRunner.query(`\n            CREATE INDEX idx_organizations_email ON organizations (email) WHERE deleted_at IS NULL\n        `);\n        await queryRunner.query(`\n            CREATE INDEX idx_organizations_edrpou ON organizations (edrpou) WHERE deleted_at IS NULL\n        `);\n        await queryRunner.query(`\n            CREATE INDEX idx_organizations_status ON organizations (status)\n        `);\n        await queryRunner.query(`\n            CREATE INDEX idx_organizations_subscription_status ON organizations (subscription_status)\n        `);\n        await queryRunner.query(`\n            CREATE INDEX idx_organizations_settings ON organizations USING GIN (settings)\n        `);\n        await queryRunner.query(`\n            CREATE INDEX idx_organizations_metadata ON organizations USING GIN (metadata)\n        `);\n\n        // Create users table\n        await queryRunner.query(`\n            CREATE TABLE users (\n                id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n                tenant_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,\n                first_name VARCHAR(100) NOT NULL,\n                last_name VARCHAR(100) NOT NULL,\n                patronymic VARCHAR(100),\n                email VARCHAR(255) NOT NULL,\n                phone VARCHAR(20),\n                password_hash VARCHAR(255) NOT NULL,\n                salt VARCHAR(255) NOT NULL,\n                mfa_secret VARCHAR(255),\n                mfa_enabled BOOLEAN NOT NULL DEFAULT FALSE,\n                mfa_backup_codes JSONB,\n                role user_role NOT NULL,\n                status user_status NOT NULL DEFAULT 'pending',\n                position VARCHAR(100),\n                avatar_url TEXT,\n                bar_number VARCHAR(20),\n                specialties JSONB,\n                languages JSONB,\n                email_verified BOOLEAN NOT NULL DEFAULT FALSE,\n                email_verified_at TIMESTAMP WITH TIME ZONE,\n                email_verification_token VARCHAR(255),\n                password_reset_token VARCHAR(255),\n                password_reset_expires_at TIMESTAMP WITH TIME ZONE,\n                last_password_change_at TIMESTAMP WITH TIME ZONE,\n                last_login_at TIMESTAMP WITH TIME ZONE,\n                last_login_ip VARCHAR(45),\n                failed_login_attempts INTEGER NOT NULL DEFAULT 0,\n                locked_until TIMESTAMP WITH TIME ZONE,\n                preferences JSONB NOT NULL DEFAULT '{}',\n                metadata JSONB NOT NULL DEFAULT '{}',\n                created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),\n                updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),\n                deleted_at TIMESTAMP WITH TIME ZONE,\n                created_by UUID,\n                updated_by UUID,\n                CONSTRAINT users_tenant_email_unique UNIQUE (tenant_id, email, deleted_at),\n                CONSTRAINT users_role_check CHECK (\n                    role IN ('super_admin', 'organization_owner', 'organization_admin', 'lawyer', 'assistant', 'accountant')\n                )\n            )\n        `);\n\n        // Create users indexes\n        await queryRunner.query(`\n            CREATE INDEX idx_users_tenant_id ON users (tenant_id) WHERE deleted_at IS NULL\n        `);\n        await queryRunner.query(`\n            CREATE INDEX idx_users_email ON users (email) WHERE deleted_at IS NULL\n        `);\n        await queryRunner.query(`\n            CREATE INDEX idx_users_role ON users (role)\n        `);\n        await queryRunner.query(`\n            CREATE INDEX idx_users_status ON users (status)\n        `);\n        await queryRunner.query(`\n            CREATE INDEX idx_users_tenant_role ON users (tenant_id, role) WHERE deleted_at IS NULL\n        `);\n        await queryRunner.query(`\n            CREATE INDEX idx_users_preferences ON users USING GIN (preferences)\n        `);\n        await queryRunner.query(`\n            CREATE INDEX idx_users_metadata ON users USING GIN (metadata)\n        `);\n\n        // Create refresh_tokens table\n        await queryRunner.query(`\n            CREATE TABLE refresh_tokens (\n                id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n                user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n                tenant_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,\n                token VARCHAR(255) NOT NULL UNIQUE,\n                device_info JSONB NOT NULL DEFAULT '{}',\n                ip_address VARCHAR(45),\n                user_agent TEXT,\n                expires_at TIMESTAMP WITH TIME ZONE NOT NULL,\n                revoked_at TIMESTAMP WITH TIME ZONE,\n                replaced_by UUID REFERENCES refresh_tokens(id),\n                created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),\n                CONSTRAINT refresh_tokens_not_expired CHECK (expires_at > created_at)\n            )\n        `);\n\n        await queryRunner.query(`\n            CREATE INDEX idx_refresh_tokens_user_id ON refresh_tokens (user_id)\n        `);\n        await queryRunner.query(`\n            CREATE INDEX idx_refresh_tokens_tenant_id ON refresh_tokens (tenant_id)\n        `);\n        await queryRunner.query(`\n            CREATE INDEX idx_refresh_tokens_token ON refresh_tokens (token)\n        `);\n        await queryRunner.query(`\n            CREATE INDEX idx_refresh_tokens_expires_at ON refresh_tokens (expires_at)\n        `);\n\n        // Create password_resets table\n        await queryRunner.query(`\n            CREATE TABLE password_resets (\n                id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n                user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,\n                tenant_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,\n                token VARCHAR(255) NOT NULL UNIQUE,\n                used_at TIMESTAMP WITH TIME ZONE,\n                expires_at TIMESTAMP WITH TIME ZONE NOT NULL,\n                ip_address VARCHAR(45),\n                user_agent TEXT,\n                created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),\n                CONSTRAINT password_resets_expires CHECK (expires_at > created_at)\n            )\n        `);\n\n        await queryRunner.query(`\n            CREATE INDEX idx_password_resets_user_id ON password_resets (user_id)\n        `);\n        await queryRunner.query(`\n            CREATE INDEX idx_password_resets_tenant_id ON password_resets (tenant_id)\n        `);\n        await queryRunner.query(`\n            CREATE INDEX idx_password_resets_token ON password_resets (token)\n        `);\n        await queryRunner.query(`\n            CREATE INDEX idx_password_resets_expires_at ON password_resets (expires_at) WHERE used_at IS NULL\n        `);\n\n        // Create subscriptions table\n        await queryRunner.query(`\n            CREATE TABLE subscriptions (\n                id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n                tenant_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,\n                provider subscription_provider NOT NULL,\n                external_id VARCHAR(255),\n                subscription_external_id VARCHAR(255),\n                plan subscription_plan NOT NULL,\n                status subscription_status NOT NULL,\n                trial_start_at TIMESTAMP WITH TIME ZONE,\n                trial_end_at TIMESTAMP WITH TIME ZONE,\n                current_period_start_at TIMESTAMP WITH TIME ZONE,\n                current_period_end_at TIMESTAMP WITH TIME ZONE,\n                cancel_at_period_end BOOLEAN NOT NULL DEFAULT FALSE,\n                canceled_at TIMESTAMP WITH TIME ZONE,\n                amount_cents INTEGER,\n                currency VARCHAR(3) NOT NULL DEFAULT 'UAH',\n                latest_webhook_event_id VARCHAR(255),\n                last_synced_at TIMESTAMP WITH TIME ZONE,\n                metadata JSONB NOT NULL DEFAULT '{}',\n                created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),\n                updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),\n                CONSTRAINT subscriptions_tenant_provider_unique UNIQUE (tenant_id, provider)\n            )\n        `);\n\n        await queryRunner.query(`\n            CREATE INDEX idx_subscriptions_tenant_id ON subscriptions (tenant_id)\n        `);\n        await queryRunner.query(`\n            CREATE INDEX idx_subscriptions_external_id ON subscriptions (external_id)\n        `);\n        await queryRunner.query(`\n            CREATE INDEX idx_subscriptions_status ON subscriptions (status)\n        `);\n        await queryRunner.query(`\n            CREATE INDEX idx_subscriptions_plan ON subscriptions (plan)\n        `);\n\n        // Create invitations table\n        await queryRunner.query(`\n            CREATE TABLE invitations (\n                id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n                tenant_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,\n                invited_by UUID NOT NULL REFERENCES users(id),\n                email VARCHAR(255) NOT NULL,\n                role user_role NOT NULL,\n                token VARCHAR(255) NOT NULL UNIQUE,\n                status invitation_status NOT NULL DEFAULT 'pending',\n                message TEXT,\n                expires_at TIMESTAMP WITH TIME ZONE NOT NULL,\n                accepted_at TIMESTAMP WITH TIME ZONE,\n                revoked_at TIMESTAMP WITH TIME ZONE,\n                accepted_by UUID REFERENCES users(id),\n                metadata JSONB NOT NULL DEFAULT '{}',\n                created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),\n                updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),\n                CONSTRAINT invitations_expires CHECK (expires_at > created_at)\n            )\n        `);\n\n        await queryRunner.query(`\n            CREATE INDEX idx_invitations_tenant_id ON invitations (tenant_id)\n        `);\n        await queryRunner.query(`\n            CREATE INDEX idx_invitations_email ON invitations (email)\n        `);\n        await queryRunner.query(`\n            CREATE INDEX idx_invitations_token ON invitations (token)\n        `);\n        await queryRunner.query(`\n            CREATE INDEX idx_invitations_status ON invitations (status)\n        `);\n        await queryRunner.query(`\n            CREATE INDEX idx_invitations_expires_at ON invitations (expires_at) WHERE status = 'pending'\n        `);\n\n        // Create onboarding_progress table\n        await queryRunner.query(`\n            CREATE TABLE onboarding_progress (\n                id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n                tenant_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,\n                user_id UUID NOT NULL REFERENCES users(id),\n                step onboarding_step NOT NULL,\n                completed BOOLEAN NOT NULL DEFAULT FALSE,\n                completed_at TIMESTAMP WITH TIME ZONE,\n                percentage INTEGER NOT NULL DEFAULT 0,\n                data JSONB NOT NULL DEFAULT '{}',\n                created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),\n                updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),\n                CONSTRAINT onboarding_progress_tenant_step_unique UNIQUE (tenant_id, user_id, step)\n            )\n        `);\n\n        await queryRunner.query(`\n            CREATE INDEX idx_onboarding_progress_tenant_id ON onboarding_progress (tenant_id)\n        `);\n        await queryRunner.query(`\n            CREATE INDEX idx_onboarding_progress_user_id ON onboarding_progress (user_id)\n        `);\n        await queryRunner.query(`\n            CREATE INDEX idx_onboarding_progress_step ON onboarding_progress (step)\n        `);\n        await queryRunner.query(`\n            CREATE INDEX idx_onboarding_progress_completed ON onboarding_progress (completed)\n        `);\n\n        // Create audit_logs table\n        await queryRunner.query(`\n            CREATE TABLE audit_logs (\n                id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n                tenant_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,\n                user_id UUID,\n                action audit_action NOT NULL,\n                entity_type VARCHAR(100) NOT NULL,\n                entity_id UUID,\n                old_values JSONB,\n                new_values JSONB,\n                changed_fields JSONB,\n                ip_address VARCHAR(45),\n                user_agent TEXT,\n                request_id VARCHAR(100),\n                metadata JSONB NOT NULL DEFAULT '{}',\n                created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()\n            )\n        `);\n\n        await queryRunner.query(`\n            CREATE INDEX idx_audit_logs_tenant_id ON audit_logs (tenant_id)\n        `);\n        await queryRunner.query(`\n            CREATE INDEX idx_audit_logs_user_id ON audit_logs (user_id)\n        `);\n        await queryRunner.query(`\n            CREATE INDEX idx_audit_logs_action ON audit_logs (action)\n        `);\n        await queryRunner_query(`\n            CREATE INDEX idx_audit_logs_entity_type ON audit_logs (entity_type)\n        `);\n        await queryRunner.query(`\n            CREATE INDEX idx_audit_logs_entity_id ON audit_logs (entity_id)\n        `);\n        await queryRunner.query(`\n            CREATE INDEX idx_audit_logs_created_at ON audit_logs (created_at)\n        `);\n        await queryRunner.query(`\n            CREATE INDEX idx_audit_logs_metadata ON audit_logs USING GIN (metadata)\n        `);\n        await queryRunner.query(`\n            CREATE INDEX idx_audit_logs_tenant_created ON audit_logs (tenant_id, created_at DESC)\n        `);\n\n        // Create trigger function\n        await queryRunner.query(`\n            CREATE OR REPLACE FUNCTION update_updated_at_column()\n            RETURNS TRIGGER AS $$\n            BEGIN\n                NEW.updated_at = NOW();\n                RETURN NEW;\n            END;\n            $$ LANGUAGE plpgsql\n        `);\n\n        // Apply triggers\n        await queryRunner.query(`\n            CREATE TRIGGER update_organizations_updated_at BEFORE UPDATE ON organizations\n                FOR EACH ROW EXECUTE FUNCTION update_updated_at_column()\n        `);\n        await queryRunner.query(`\n            CREATE TRIGGER update_users_updated_at BEFORE UPDATE ON users\n                FOR EACH ROW EXECUTE FUNCTION update_updated_at_column()\n        `);\n        await queryRunner.query(`\n            CREATE TRIGGER update_subscriptions_updated_at BEFORE UPDATE ON subscriptions\n                FOR EACH ROW EXECUTE FUNCTION update_updated_at_column()\n        `);\n        await queryRunner.query(`\n            CREATE TRIGGER update_invitations_updated_at BEFORE UPDATE ON invitations\n                FOR EACH ROW EXECUTE FUNCTION update_updated_at_column()\n        `);\n        await queryRunner.query(`\n            CREATE TRIGGER update_onboarding_progress_updated_at BEFORE UPDATE ON onboarding_progress\n                FOR EACH ROW EXECUTE FUNCTION update_updated_at_column()\n        `);\n\n        // Insert default platform organization\n        await queryRunner.query(`\n            INSERT INTO organizations (\n                id,\n                name,\n                legal_form,\n                email,\n                subscription_plan,\n                subscription_status,\n                status\n            ) VALUES (\n                '00000000-0000-0000-0000-000000000001',\n                'LAW ORGANIZER Platform',\n                'sole_proprietor',\n                'platform@laworganizer.ua',\n                'enterprise',\n                'active',\n                'active'\n            ) ON CONFLICT DO NOTHING\n        `);\n    }\n\n    public async down(queryRunner: QueryRunner): Promise<void> {\n        // Drop triggers\n        await queryRunner.query(`DROP TRIGGER IF EXISTS update_organizations_updated_at ON organizations`);\n        await queryRunner.query(`DROP TRIGGER IF EXISTS update_users_updated_at ON users`);\n        await queryRunner.query(`DROP TRIGGER IF EXISTS update_subscriptions_updated_at ON subscriptions`);\n        await queryRunner.query(`DROP TRIGGER IF EXISTS update_invitations_updated_at ON invitations`);\n        await queryRunner.query(`DROP TRIGGER IF EXISTS update_onboarding_progress_updated_at ON onboarding_progress`);\n\n        // Drop trigger function\n        await queryRunner.query(`DROP FUNCTION IF EXISTS update_updated_at_column`);\n\n        // Drop indexes\n        await queryRunner.query(`DROP INDEX IF EXISTS idx_audit_logs_tenant_created`);\n        await queryRunner.query(`DROP INDEX IF EXISTS idx_audit_logs_metadata`);\n        await queryRunner.query(`DROP INDEX IF EXISTS idx_audit_logs_created_at`);\n        await queryRunner.query(`DROP INDEX IF EXISTS idx_audit_logs_entity_id`);\n        await queryRunner.query(`DROP INDEX IF EXISTS idx_audit_logs_entity_type`);\n        await queryRunner.query(`DROP INDEX IF EXISTS idx_audit_logs_action`);\n        await queryRunner.query(`DROP INDEX IF EXISTS idx_audit_logs_user_id`);\n        await queryRunner.query(`DROP INDEX IF EXISTS idx_audit_logs_tenant_id`);\n\n        await queryRunner.query(`DROP INDEX IF EXISTS idx_onboarding_progress_completed`);\n        await queryRunner.query(`DROP INDEX IF EXISTS idx_onboarding_progress_step`);\n        await queryRunner.query(`DROP INDEX IF EXISTS idx_onboarding_progress_user_id`);\n        await queryRunner.query(`DROP INDEX IF EXISTS idx_onboarding_progress_tenant_id`);\n\n        await queryRunner.query(`DROP INDEX IF EXISTS idx_invitations_expires_at`);\n        await queryRunner.query(`DROP INDEX IF EXISTS idx_invitations_status`);\n        await queryRunner.query(`DROP INDEX IF EXISTS idx_invitations_token`);\n        await queryRunner.query(`DROP INDEX IF EXISTS idx_invitations_email`);\n        await queryRunner.query(`DROP INDEX IF EXISTS idx_invitations_tenant_id`);\n\n        await queryRunner.query(`DROP INDEX IF EXISTS idx_subscriptions_plan`);\n        await queryRunner.query(`DROP INDEX IF EXISTS idx_subscriptions_status`);\n        await queryRunner.query(`DROP INDEX IF EXISTS idx_subscriptions_external_id`);\n        await queryRunner.query(`DROP INDEX IF EXISTS idx_subscriptions_tenant_id`);\n\n        await queryRunner.query(`DROP INDEX IF EXISTS idx_password_resets_expires_at`);\n        await queryRunner.query(`DROP INDEX IF EXISTS idx_password_resets_token`);\n        await queryRunner.query(`DROP INDEX IF EXISTS idx_password_resets_tenant_id`);\n        await queryRunner.query(`DROP INDEX IF EXISTS idx_password_resets_user_id`);\n\n        await queryRunner.query(`DROP INDEX IF EXISTS idx_refresh_tokens_expires_at`);\n        await queryRunner.query(`DROP INDEX IF EXISTS idx_refresh_tokens_token`);\n        await queryRunner.query(`DROP INDEX IF EXISTS idx_refresh_tokens_tenant_id`);\n        await queryRunner.query(`DROP INDEX IF EXISTS idx_refresh_tokens_user_id`);\n\n        await queryRunner.query(`DROP INDEX IF EXISTS idx_users_metadata`);\n        await queryRunner.query(`DROP INDEX IF EXISTS idx_users_preferences`);\n        await queryRunner.query(`DROP INDEX IF EXISTS idx_users_tenant_role`);\n        await queryRunner.query(`DROP INDEX IF EXISTS idx_users_status`);\n        await queryRunner.query(`DROP INDEX IF EXISTS idx_users_role`);\n        await queryRunner.query(`DROP INDEX IF EXISTS idx_users_email`);\n        await queryRunner.query(`DROP INDEX IF EXISTS idx_users_tenant_id`);\n\n        await queryRunner.query(`DROP INDEX IF EXISTS idx_organizations_metadata`);\n        await queryRunner.query(`DROP INDEX IF EXISTS idx_organizations_settings`);\n        await queryRunner.query(`DROP INDEX IF EXISTS idx_organizations_subscription_status`);\n        await queryRunner.query(`DROP INDEX IF EXISTS idx_organizations_status`);\n        await queryRunner.query(`DROP INDEX IF EXISTS idx_organizations_edrpou`);\n        await queryRunner.query(`DROP INDEX IF EXISTS idx_organizations_email`);\n\n        // Drop tables (in reverse order due to foreign keys)\n        await queryRunner.query(`DROP TABLE IF EXISTS audit_logs CASCADE`);\n        await queryRunner.query(`DROP TABLE IF EXISTS onboarding_progress CASCADE`);\n        await queryRunner.query(`DROP TABLE IF EXISTS invitations CASCADE`);\n        await queryRunner.query(`DROP TABLE IF EXISTS subscriptions CASCADE`);\n        await queryRunner.query(`DROP TABLE IF EXISTS password_resets CASCADE`);\n        await queryRunner.query(`DROP TABLE IF EXISTS refresh_tokens CASCADE`);\n        await queryRunner.query(`DROP TABLE IF EXISTS users CASCADE`);\n        await queryRunner.query(`DROP TABLE IF EXISTS organizations CASCADE`);\n\n        // Drop enums\n        await queryRunner.query(`DROP TYPE IF EXISTS onboarding_step`);\n        await queryRunner.query(`DROP TYPE IF EXISTS audit_action`);\n        await queryRunner.query(`DROP TYPE IF EXISTS legal_form`);\n        await queryRunner.query(`DROP TYPE IF EXISTS organization_status`);\n        await queryRunner.query(`DROP TYPE IF EXISTS invitation_status`);\n        await queryRunner.query(`DROP TYPE IF EXISTS user_status`);\n        await queryRunner.query(`DROP TYPE IF EXISTS user_role`);\n        await queryRunner.query(`DROP TYPE IF EXISTS subscription_provider`);\n        await queryRunner.query(`DROP TYPE IF EXISTS subscription_status`);\n        await queryRunner.query(`DROP TYPE IF EXISTS subscription_plan`);\n\n        // Drop extensions\n        await queryRunner.query(`DROP EXTENSION IF EXISTS \"btree_gin\"`);\n        await queryRunner.query(`DROP EXTENSION IF EXISTS \"pgcrypto\"`);\n        await queryRunner.query(`DROP EXTENSION IF EXISTS \"uuid-ossp\"`);\n    }\n}\n"],"names":["InitAuthSchema1704067200000","up","queryRunner","query","queryRunner_query","down","name"],"mappings":"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"}
{"version":3,"sources":["../../../src/file-storage/providers/local-storage.service.ts"],"sourcesContent":["import { Injectable, Logger } from '@nestjs/common';\nimport { ConfigService } from '@nestjs/config';\nimport { promises as fs } from 'fs';\nimport { join } from 'path';\nimport { createReadStream, createWriteStream } from 'fs';\nimport { stat, unlink, mkdir } from 'fs/promises';\nimport { pipeline } from 'stream/promises';\nimport { IStorageProvider, FileUploadOptions, FileUploadResult, FileDownloadOptions, FileDownloadResult, SignedUrlOptions, FileMetadata, FileVersion } from '../interfaces/file-storage.interfaces';\n\n/**\n * Local Storage Service\n *\n * Provides local filesystem storage for development\n */\n@Injectable()\nexport class LocalStorageService implements IStorageProvider {\n    private readonly logger = new Logger(LocalStorageService.name);\n    private readonly baseDir: string;\n    private readonly baseUrl: string;\n\n    constructor(private readonly configService: ConfigService) {\n        this.baseDir = this.configService.get<string>('LOCAL_STORAGE_DIR', './storage') || './storage';\n        this.baseUrl = this.configService.get<string>('LOCAL_STORAGE_URL', 'http://localhost:3000/storage');\n\n        this.ensureBaseDir();\n        this.logger.log(`Local Storage initialized at: ${this.baseDir}`);\n    }\n\n    /**\n     * Upload file to local filesystem\n     */\n    async upload(options: FileUploadOptions): Promise<FileUploadResult> {\n        const fullPath = join(this.baseDir, options.path);\n        const filePath = join(fullPath, options.fileName);\n\n        await fs.mkdir(fullPath, { recursive: true });\n        await fs.writeFile(filePath, options.buffer);\n\n        this.logger.log(`File uploaded: ${filePath}`);\n\n        return {\n            path: `${options.path}${options.fileName}`,\n            url: this.getPublicUrl(options.path, options.fileName),\n            size: options.buffer.length,\n        };\n    }\n\n    /**\n     * Download file from local filesystem\n     */\n    async download(options: FileDownloadOptions): Promise<FileDownloadResult> {\n        const filePath = join(this.baseDir, options.path);\n        const stats = await stat(filePath);\n        const buffer = await fs.readFile(filePath);\n\n        return {\n            buffer,\n            contentType: this.getMimeType(options.path),\n            contentLength: stats.size,\n            lastModified: stats.mtime,\n        };\n    }\n\n    /**\n     * Delete file from local filesystem\n     */\n    async delete(path: string): Promise<void> {\n        const filePath = join(this.baseDir, path);\n        await unlink(filePath);\n        this.logger.log(`File deleted: ${filePath}`);\n    }\n\n    /**\n     * Check if file exists\n     */\n    async exists(path: string): Promise<boolean> {\n        try {\n            await stat(join(this.baseDir, path));\n            return true;\n        } catch {\n            return false;\n        }\n    }\n\n    /**\n     * Get file metadata\n     */\n    async getMetadata(path: string): Promise<FileMetadata> {\n        const filePath = join(this.baseDir, path);\n        const stats = await stat(filePath);\n\n        return {\n            fileName: path.split('/').pop() || path,\n            contentType: this.getMimeType(path),\n            size: stats.size,\n            lastModified: stats.mtime,\n            url: this.getPublicUrl(path.split('/').slice(0, -1).join('/'), path.split('/').pop() || ''),\n        };\n    }\n\n    /**\n     * Generate signed URL (not applicable for local storage, returns public URL)\n     */\n    async generateSignedUrl(options: SignedUrlOptions): Promise<string> {\n        // Local storage doesn't support signed URLs\n        // Return the public URL with timestamp query param for logging\n        const fileName = options.path.split('/').pop();\n        const path = options.path.split('/').slice(0, -1).join('/');\n        return `${this.getPublicUrl(path, fileName || '')}?expires=${Date.now() + (options.expiresIn || 3600) * 1000}`;\n    }\n\n    /**\n     * List file versions (not supported for local storage)\n     */\n    async listVersions(path: string): Promise<FileVersion[]> {\n        const metadata = await this.getMetadata(path);\n        return [\n            {\n                versionId: '1',\n                path,\n                size: metadata.size,\n                lastModified: metadata.lastModified,\n                isLatest: true,\n            },\n        ];\n    }\n\n    /**\n     * Copy file\n     */\n    async copy(sourcePath: string, destinationPath: string): Promise<FileUploadResult> {\n        const sourceFilePath = join(this.baseDir, sourcePath);\n        const destDir = join(this.baseDir, destinationPath.split('/').slice(0, -1).join('/'));\n        const destFileName = destinationPath.split('/').pop() || '';\n        const destFilePath = join(this.baseDir, destinationPath);\n\n        await mkdir(destDir, { recursive: true });\n\n        await pipeline(\n            createReadStream(sourceFilePath),\n            createWriteStream(destFilePath)\n        );\n\n        return {\n            path: destinationPath,\n            url: this.getPublicUrl(destinationPath.split('/').slice(0, -1).join('/'), destFileName),\n            size: (await stat(destFilePath)).size,\n        };\n    }\n\n    /**\n     * Move file\n     */\n    async move(sourcePath: string, destinationPath: string): Promise<FileUploadResult> {\n        const result = await this.copy(sourcePath, destinationPath);\n        await this.delete(sourcePath);\n        return result;\n    }\n\n    /**\n     * Delete multiple files\n     */\n    async deleteMultiple(paths: string[]): Promise<void> {\n        await Promise.all(paths.map(path => this.delete(path)));\n        this.logger.log(`Deleted ${paths.length} files`);\n    }\n\n    /**\n     * Get storage usage for a prefix\n     */\n    async getStorageUsage(prefix: string): Promise<number> {\n        const dir = join(this.baseDir, prefix);\n        let totalSize = 0;\n\n        try {\n            const files = await fs.readdir(dir, { recursive: true });\n\n            for (const file of files) {\n                try {\n                    const filePath = join(dir, file);\n                    const stats = await stat(filePath);\n                    if (stats.isFile()) {\n                        totalSize += stats.size;\n                    }\n                } catch {\n                    // Skip files that can't be accessed\n                }\n            }\n        } catch {\n            // Directory doesn't exist\n        }\n\n        return totalSize;\n    }\n\n    /**\n     * Ensure base directory exists\n     */\n    private async ensureBaseDir(): Promise<void> {\n        try {\n            await fs.mkdir(this.baseDir, { recursive: true });\n        } catch (error) {\n            this.logger.error(`Failed to create base directory: ${error.message}`);\n        }\n    }\n\n    /**\n     * Get public URL for a file\n     */\n    private getPublicUrl(path: string, fileName: string): string {\n        return `${this.baseUrl}/${path}${fileName}`;\n    }\n\n    /**\n     * Get MIME type from file extension\n     */\n    private getMimeType(path: string): string {\n        const ext = path.split('.').pop()?.toLowerCase() || '';\n        const mimeTypes: Record<string, string> = {\n            pdf: 'application/pdf',\n            doc: 'application/msword',\n            docx: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',\n            xls: 'application/vnd.ms-excel',\n            xlsx: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',\n            jpg: 'image/jpeg',\n            jpeg: 'image/jpeg',\n            png: 'image/png',\n            gif: 'image/gif',\n        };\n        return mimeTypes[ext] || 'application/octet-stream';\n    }\n}\n"],"names":["LocalStorageService","upload","options","fullPath","join","baseDir","path","filePath","fileName","fs","mkdir","recursive","writeFile","buffer","logger","log","url","getPublicUrl","size","length","download","stats","stat","readFile","contentType","getMimeType","contentLength","lastModified","mtime","delete","unlink","exists","getMetadata","split","pop","slice","generateSignedUrl","Date","now","expiresIn","listVersions","metadata","versionId","isLatest","copy","sourcePath","destinationPath","sourceFilePath","destDir","destFileName","destFilePath","pipeline","createReadStream","createWriteStream","move","result","deleteMultiple","paths","Promise","all","map","getStorageUsage","prefix","dir","totalSize","files","readdir","file","isFile","ensureBaseDir","error","message","baseUrl","ext","toLowerCase","mimeTypes","pdf","doc","docx","xls","xlsx","jpg","jpeg","png","gif","configService","Logger","name","get"],"mappings":"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"}
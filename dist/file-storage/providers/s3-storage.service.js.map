{"version":3,"sources":["../../../src/file-storage/providers/s3-storage.service.ts"],"sourcesContent":["import { Injectable, Logger } from '@nestjs/common';\nimport { ConfigService } from '@nestjs/config';\nimport { S3Client, PutObjectCommand, GetObjectCommand, DeleteObjectCommand, HeadObjectCommand, CopyObjectCommand } from '@aws-sdk/client-s3';\nimport { getSignedUrl } from '@aws-sdk/s3-request-presigner';\nimport { Readable } from 'stream';\nimport { IStorageProvider, FileUploadOptions, FileUploadResult, FileDownloadOptions, FileDownloadResult, SignedUrlOptions, FileMetadata, FileVersion } from '../interfaces/file-storage.interfaces';\n\n/**\n * S3 Storage Service\n *\n * Provides S3-compatible storage (works with AWS S3, MinIO, DigitalOcean Spaces, etc.)\n */\n@Injectable()\nexport class S3StorageService implements IStorageProvider {\n    private readonly logger = new Logger(S3StorageService.name);\n    private readonly s3Client: S3Client;\n    private readonly bucket: string;\n\n    constructor(private readonly configService: ConfigService) {\n        const endpoint = this.configService.get<string>('AWS_ENDPOINT');\n        const region = this.configService.get<string>('AWS_REGION', 'us-east-1');\n        const accessKeyId = this.configService.get<string>('AWS_ACCESS_KEY_ID');\n        const secretAccessKey = this.configService.get<string>('AWS_SECRET_ACCESS_KEY');\n\n        this.bucket = this.configService.get<string>('AWS_S3_BUCKET', 'law-organizer-uploads');\n\n        this.s3Client = new S3Client({\n            region,\n            endpoint,\n            credentials: {\n                accessKeyId: accessKeyId || '',\n                secretAccessKey: secretAccessKey || '',\n            },\n            forcePathStyle: !!endpoint, // Required for MinIO\n        });\n\n        this.logger.log(`S3 Storage initialized with bucket: ${this.bucket}, endpoint: ${endpoint || 'AWS S3'}`);\n    }\n\n    /**\n     * Upload file to S3\n     */\n    async upload(options: FileUploadOptions): Promise<FileUploadResult> {\n        const key = `${options.path}${options.fileName}`;\n\n        const command = new PutObjectCommand({\n            Bucket: this.bucket,\n            Key: key,\n            Body: options.buffer,\n            ContentType: options.contentType,\n            Metadata: options.metadata,\n            ACL: options.isPublic ? 'public-read' : 'private',\n        });\n\n        const result = await this.s3Client.send(command);\n\n        this.logger.log(`File uploaded: ${key}`);\n\n        return {\n            path: key,\n            url: this.getPublicUrl(key),\n            size: options.buffer.length,\n            etag: result.ETag,\n            versionId: result.VersionId,\n        };\n    }\n\n    /**\n     * Download file from S3\n     */\n    async download(options: FileDownloadOptions): Promise<FileDownloadResult> {\n        const command = new GetObjectCommand({\n            Bucket: this.bucket,\n            Key: options.path,\n            Range: options.range,\n        });\n\n        const result = await this.s3Client.send(command);\n\n        const buffer = await this.streamToBuffer(result.Body as Readable);\n\n        return {\n            buffer,\n            contentType: result.ContentType || 'application/octet-stream',\n            contentLength: result.ContentLength || 0,\n            lastModified: result.LastModified,\n            etag: result.ETag,\n        };\n    }\n\n    /**\n     * Delete file from S3\n     */\n    async delete(path: string): Promise<void> {\n        const command = new DeleteObjectCommand({\n            Bucket: this.bucket,\n            Key: path,\n        });\n\n        await this.s3Client.send(command);\n        this.logger.log(`File deleted: ${path}`);\n    }\n\n    /**\n     * Check if file exists in S3\n     */\n    async exists(path: string): Promise<boolean> {\n        try {\n            const command = new HeadObjectCommand({\n                Bucket: this.bucket,\n                Key: path,\n            });\n\n            await this.s3Client.send(command);\n            return true;\n        } catch (error) {\n            if (error.name === 'NotFound') {\n                return false;\n            }\n            throw error;\n        }\n    }\n\n    /**\n     * Get file metadata from S3\n     */\n    async getMetadata(path: string): Promise<FileMetadata> {\n        const command = new HeadObjectCommand({\n            Bucket: this.bucket,\n            Key: path,\n        });\n\n        const result = await this.s3Client.send(command);\n\n        return {\n            fileName: path.split('/').pop() || path,\n            contentType: result.ContentType || 'application/octet-stream',\n            size: result.ContentLength || 0,\n            lastModified: result.LastModified || new Date(),\n            metadata: result.Metadata,\n            url: this.getPublicUrl(path),\n        };\n    }\n\n    /**\n     * Generate signed URL for temporary access\n     */\n    async generateSignedUrl(options: SignedUrlOptions): Promise<string> {\n        const command = new GetObjectCommand({\n            Bucket: this.bucket,\n            Key: options.path,\n            ResponseContentDisposition: options.disposition ? `${options.disposition}; filename=\"${options.path.split('/').pop()}\"` : undefined,\n            ResponseContentType: options.contentType,\n        });\n\n        const expiresIn = options.expiresIn || 3600;\n        const url = await getSignedUrl(this.s3Client, command, { expiresIn });\n\n        return url;\n    }\n\n    /**\n     * List all versions of a file\n     */\n    async listVersions(path: string): Promise<FileVersion[]> {\n        // This requires bucket versioning to be enabled\n        // For now, return a single version\n        const metadata = await this.getMetadata(path);\n\n        return [\n            {\n                versionId: 'null',\n                path,\n                size: metadata.size,\n                lastModified: metadata.lastModified,\n                isLatest: true,\n            },\n        ];\n    }\n\n    /**\n     * Copy file within S3\n     */\n    async copy(sourcePath: string, destinationPath: string): Promise<FileUploadResult> {\n        const command = new CopyObjectCommand({\n            Bucket: this.bucket,\n            CopySource: `${this.bucket}/${sourcePath}`,\n            Key: destinationPath,\n        });\n\n        const result = await this.s3Client.send(command);\n\n        return {\n            path: destinationPath,\n            url: this.getPublicUrl(destinationPath),\n            size: 0, // Need to get metadata to get size\n            etag: result.CopyObjectResult?.ETag,\n            versionId: result.VersionId,\n        };\n    }\n\n    /**\n     * Move file within S3 (copy + delete)\n     */\n    async move(sourcePath: string, destinationPath: string): Promise<FileUploadResult> {\n        const result = await this.copy(sourcePath, destinationPath);\n        await this.delete(sourcePath);\n        return result;\n    }\n\n    /**\n     * Delete multiple files from S3\n     */\n    async deleteMultiple(paths: string[]): Promise<void> {\n        // S3 allows deleting up to 1000 objects at a time\n        const batchSize = 1000;\n\n        for (let i = 0; i < paths.length; i += batchSize) {\n            const batch = paths.slice(i, i + batchSize);\n            const command = new DeleteObjectsCommand({\n                Bucket: this.bucket,\n                Delete: {\n                    Objects: batch.map(path => ({ Key: path })),\n                    Quiet: false,\n                },\n            });\n\n            await this.s3Client.send(command);\n        }\n\n        this.logger.log(`Deleted ${paths.length} files`);\n    }\n\n    /**\n     * Get storage usage for a prefix (tenant)\n     */\n    async getStorageUsage(prefix: string): Promise<number> {\n        // This would require listing all objects under the prefix\n        // For production, you might want to use CloudWatch metrics or maintain a counter\n        // For now, return 0\n        this.logger.warn(`Storage usage calculation not implemented for prefix: ${prefix}`);\n        return 0;\n    }\n\n    /**\n     * Convert stream to buffer\n     */\n    private async streamToBuffer(stream: Readable): Promise<Buffer> {\n        return new Promise((resolve, reject) => {\n            const chunks: Buffer[] = [];\n            stream.on('data', (chunk) => chunks.push(chunk));\n            stream.on('error', reject);\n            stream.on('end', () => resolve(Buffer.concat(chunks)));\n        });\n    }\n\n    /**\n     * Get public URL for a file\n     */\n    private getPublicUrl(key: string): string {\n        const endpoint = this.configService.get<string>('AWS_ENDPOINT');\n        const cdnDomain = this.configService.get<string>('CDN_DOMAIN');\n\n        if (cdnDomain) {\n            return `https://${cdnDomain}/${key}`;\n        }\n\n        if (endpoint) {\n            return `${endpoint}/${this.bucket}/${key}`;\n        }\n\n        return `https://${this.bucket}.s3.amazonaws.com/${key}`;\n    }\n}\n\n// Add missing import for DeleteObjectsCommand\nimport { DeleteObjectsCommand } from '@aws-sdk/client-s3';\n"],"names":["S3StorageService","upload","options","key","path","fileName","command","PutObjectCommand","Bucket","bucket","Key","Body","buffer","ContentType","contentType","Metadata","metadata","ACL","isPublic","result","s3Client","send","logger","log","url","getPublicUrl","size","length","etag","ETag","versionId","VersionId","download","GetObjectCommand","Range","range","streamToBuffer","contentLength","ContentLength","lastModified","LastModified","delete","DeleteObjectCommand","exists","HeadObjectCommand","error","name","getMetadata","split","pop","Date","generateSignedUrl","ResponseContentDisposition","disposition","undefined","ResponseContentType","expiresIn","getSignedUrl","listVersions","isLatest","copy","sourcePath","destinationPath","CopyObjectCommand","CopySource","CopyObjectResult","move","deleteMultiple","paths","batchSize","i","batch","slice","DeleteObjectsCommand","Delete","Objects","map","Quiet","getStorageUsage","prefix","warn","stream","Promise","resolve","reject","chunks","on","chunk","push","Buffer","concat","endpoint","configService","get","cdnDomain","Logger","region","accessKeyId","secretAccessKey","S3Client","credentials","forcePathStyle"],"mappings":"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"}
{"version":3,"sources":["../../../src/file-storage/controllers/file-storage.controller.ts"],"sourcesContent":["import { Controller, Get, Post, Delete, Body, Param, Query, UseGuards, UseInterceptors, UploadedFile, UploadedFiles, HttpCode, HttpStatus, Res, StreamableFile, Req, } from '@nestjs/common';\nimport { FileInterceptor, FilesInterceptor } from '@nestjs/platform-express';\nimport { ApiTags, ApiOperation, ApiResponse, ApiBearerAuth, ApiConsumes, ApiBody } from '@nestjs/swagger';\nimport { Response } from 'express';\nimport { FileStorageService } from '../services/file-storage.service';\nimport { JwtAuthGuard } from '../../auth/guards';\nimport { TenantGuard, RbacGuard } from '../../auth/guards';\nimport { Audit } from '../../auth/services/audit.service';\n\n/**\n * File Storage Controller\n *\n * Provides endpoints for file upload, download, and management\n */\n@ApiTags('File Storage')\n@Controller('file-storage')\n@UseGuards(JwtAuthGuard, TenantGuard)\n@ApiBearerAuth()\nexport class FileStorageController {\n    constructor(private readonly fileStorageService: FileStorageService) {}\n\n    @Post('upload')\n    @UseGuards(RbacGuard)\n    @UseInterceptors(FileInterceptor('file'))\n    @ApiConsumes('multipart/form-data')\n    @ApiOperation({ summary: 'Upload a file' })\n    @ApiResponse({ status: 201, description: 'File uploaded successfully' })\n    @ApiResponse({ status: 400, description: 'Invalid file' })\n    @Audit('create')\n    async uploadFile(\n        @UploadedFile() file: Express.Multer.File,\n        @Query('caseId') caseId?: string,\n        @Query('clientId') clientId?: string,\n        @Query('folder') folder?: string,\n        @Query('isPublic') isPublic?: string,\n        @Req() req: any\n    ) {\n        const tenantId = req.user?.tenant_id;\n        const userId = req.user?.user_id;\n\n        return this.fileStorageService.uploadFile(tenantId, userId, file, {\n            caseId,\n            clientId,\n            folder,\n            isPublic: isPublic === 'true',\n        });\n    }\n\n    @Post('upload/bulk')\n    @UseGuards(RbacGuard)\n    @UseInterceptors(FilesInterceptor('files', 10))\n    @ApiConsumes('multipart/form-data')\n    @ApiOperation({ summary: 'Upload multiple files' })\n    @ApiResponse({ status: 201, description: 'Files uploaded successfully' })\n    @ApiResponse({ status: 400, description: 'Invalid files' })\n    @Audit('create')\n    async uploadFiles(\n        @UploadedFiles() files: Express.Multer.File[],\n        @Query('caseId') caseId?: string,\n        @Query('clientId') clientId?: string,\n        @Query('folder') folder?: string,\n        @Query('isPublic') isPublic?: string,\n        @Req() req: any\n    ) {\n        const tenantId = req.user?.tenant_id;\n        const userId = req.user?.user_id;\n\n        return this.fileStorageService.uploadFiles(tenantId, userId, files, {\n            caseId,\n            clientId,\n            folder,\n            isPublic: isPublic === 'true',\n        });\n    }\n\n    @Get('download/:path(*)')\n    @ApiOperation({ summary: 'Download a file' })\n    @ApiResponse({ status: 200, description: 'File downloaded' })\n    @ApiResponse({ status: 404, description: 'File not found' })\n    @Audit('read')\n    async downloadFile(\n        @Param('path') path: string,\n        @Req() req: any,\n        @Res({ passthrough: true }) res: Response\n    ): Promise<StreamableFile> {\n        const tenantId = req.user?.tenant_id;\n        const buffer = await this.fileStorageService.downloadFile(tenantId, path);\n\n        res.set({\n            'Content-Type': 'application/octet-stream',\n            'Content-Disposition': `attachment; filename=\"${path.split('/').pop()}\"`,\n            'Content-Length': buffer.length.toString(),\n        });\n\n        return new StreamableFile(buffer);\n    }\n\n    @Get('signed-url')\n    @ApiOperation({ summary: 'Generate signed URL for file access' })\n    @ApiResponse({ status: 200, description: 'Signed URL generated' })\n    @ApiResponse({ status: 400, description: 'Invalid request' })\n    @Audit('read')\n    async generateSignedUrl(\n        @Query('path') path: string,\n        @Query('expiresIn') expiresIn?: string,\n        @Query('disposition') disposition?: 'attachment' | 'inline',\n        @Query('contentType') contentType?: string,\n        @Req() req: any\n    ) {\n        const tenantId = req.user?.tenant_id;\n\n        const url = await this.fileStorageService.generateSignedUrl(tenantId, path, {\n            expiresIn: expiresIn ? parseInt(expiresIn) : undefined,\n            disposition,\n            contentType,\n        });\n\n        return { url };\n    }\n\n    @Delete('file/:path(*)')\n    @UseGuards(RbacGuard)\n    @HttpCode(HttpStatus.NO_CONTENT)\n    @ApiOperation({ summary: 'Delete a file' })\n    @ApiResponse({ status: 204, description: 'File deleted' })\n    @ApiResponse({ status: 404, description: 'File not found' })\n    @Audit('delete')\n    async deleteFile(\n        @Param('path') path: string,\n        @Req() req: any\n    ): Promise<void> {\n        const tenantId = req.user?.tenant_id;\n        await this.fileStorageService.deleteFile(tenantId, path);\n    }\n\n    @Delete('files')\n    @UseGuards(RbacGuard)\n    @HttpCode(HttpStatus.NO_CONTENT)\n    @ApiOperation({ summary: 'Delete multiple files' })\n    @ApiResponse({ status: 204, description: 'Files deleted' })\n    @Audit('delete')\n    async deleteFiles(\n        @Body('paths') paths: string[],\n        @Req() req: any\n    ): Promise<void> {\n        const tenantId = req.user?.tenant_id;\n        await this.fileStorageService.deleteFiles(tenantId, paths);\n    }\n\n    @Post('copy')\n    @UseGuards(RbacGuard)\n    @ApiOperation({ summary: 'Copy a file' })\n    @ApiResponse({ status: 201, description: 'File copied' })\n    @Audit('update')\n    async copyFile(\n        @Body('sourcePath') sourcePath: string,\n        @Body('destinationPath') destinationPath: string,\n        @Req() req: any\n    ) {\n        const tenantId = req.user?.tenant_id;\n        return this.fileStorageService.copyFile(tenantId, sourcePath, destinationPath);\n    }\n\n    @Post('move')\n    @UseGuards(RbacGuard)\n    @ApiOperation({ summary: 'Move a file' })\n    @ApiResponse({ status: 201, description: 'File moved' })\n    @Audit('update')\n    async moveFile(\n        @Body('sourcePath') sourcePath: string,\n        @Body('destinationPath') destinationPath: string,\n        @Req() req: any\n    ) {\n        const tenantId = req.user?.tenant_id;\n        return this.fileStorageService.moveFile(tenantId, sourcePath, destinationPath);\n    }\n\n    @Get('exists/:path(*)')\n    @ApiOperation({ summary: 'Check if file exists' })\n    @ApiResponse({ status: 200, description: 'File exists' })\n    @ApiResponse({ status: 404, description: 'File not found' })\n    async fileExists(\n        @Param('path') path: string,\n        @Req() req: any\n    ) {\n        const tenantId = req.user?.tenant_id;\n        const exists = await this.fileStorageService.fileExists(tenantId, path);\n        return { exists };\n    }\n\n    @Get('metadata/:path(*)')\n    @ApiOperation({ summary: 'Get file metadata' })\n    @ApiResponse({ status: 200, description: 'Metadata retrieved' })\n    @ApiResponse({ status: 404, description: 'File not found' })\n    async getFileMetadata(\n        @Param('path') path: string,\n        @Req() req: any\n    ) {\n        const tenantId = req.user?.tenant_id;\n        return this.fileStorageService.getFileMetadata(tenantId, path);\n    }\n\n    @Get('quota')\n    @ApiOperation({ summary: 'Get storage quota for tenant' })\n    @ApiResponse({ status: 200, description: 'Quota retrieved' })\n    async getStorageQuota(\n        @Query('plan') plan?: string,\n        @Req() req: any\n    ) {\n        const tenantId = req.user?.tenant_id;\n        return this.fileStorageService.getStorageQuota(tenantId, plan);\n    }\n\n    @Get('config')\n    @ApiOperation({ summary: 'Get file storage configuration' })\n    @ApiResponse({ status: 200, description: 'Configuration retrieved' })\n    async getConfig(\n        @Query('plan') plan?: string\n    ) {\n        return {\n            allowedMimeTypes: this.fileStorageService.getAllowedMimeTypes(),\n            fileSizeLimit: this.fileStorageService.getFileSizeLimit(plan),\n        };\n    }\n}\n"],"names":["FileStorageController","uploadFile","file","caseId","clientId","folder","isPublic","req","tenantId","user","tenant_id","userId","user_id","fileStorageService","uploadFiles","files","downloadFile","path","res","buffer","set","split","pop","length","toString","StreamableFile","generateSignedUrl","expiresIn","disposition","contentType","url","parseInt","undefined","deleteFile","deleteFiles","paths","copyFile","sourcePath","destinationPath","moveFile","fileExists","exists","getFileMetadata","getStorageQuota","plan","getConfig","allowedMimeTypes","getAllowedMimeTypes","fileSizeLimit","getFileSizeLimit","summary","status","description","passthrough","NO_CONTENT"],"mappings":"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"}